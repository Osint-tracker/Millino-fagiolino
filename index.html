<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millino Fagiolino | Research Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 800: '#292524', 900: '#1c1917' },
                        rose: { 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #fafaf9; color: #44403c; } /* Stone-50 background */
        
        /* Navigation & Active States - Stile "Soft Pill" */
        .nav-active { background-color: #ffe4e6; color: #be123c; font-weight: 600; }
        .nav-item:hover:not(.nav-active) { background-color: #f5f5f4; color: #1c1917; }
        
        /* Card Styling - Effetto Carta */
        .paper-card { 
            background: white; 
            border: 1px solid #e7e5e4; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .paper-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); 
            border-color: #fecdd3; /* Rose border on hover */
        }

        /* Status Badges */
        .status-btn { transition: all 0.2s; border: 1px solid transparent; letter-spacing: 0.05em;}
        .status-todo { background: #f5f5f4; color: #78716c; border-color: #e7e5e4; }
        .status-reading { background: #fff1f2; color: #be123c; border-color: #fecdd3; } /* Rose light */
        .status-done { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; } /* Emerald softer */

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Typography Override */
        .prose p { margin-bottom: 0.8em; line-height: 1.7; color: #57534e; }
        .prose strong { color: #1c1917; font-weight: 600; }
        
        /* Chat Widget */
        .chat-open { transform: translateY(0) scale(1); opacity: 1; pointer-events: all; }
        .chat-closed { transform: translateY(20px) scale(0.95); opacity: 0; pointer-events: none; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans selection:bg-rose-100 selection:text-rose-900">

    <aside class="w-72 bg-white border-r border-stone-200 flex-shrink-0 flex flex-col z-30 hidden md:flex">
        <div class="p-8 pb-4">
            <h1 class="text-3xl font-bold text-stone-900 tracking-tight serif">Millino<span class="text-rose-500 italic">.Fagiolino</span></h1>
            <div class="flex items-center gap-2 mt-2">
                <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                <p class="text-[11px] text-stone-400 uppercase tracking-widest font-semibold">Tesi Hub v2.0</p>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-4">
            <div class="px-2 py-3 text-[10px] font-bold text-stone-400 uppercase tracking-widest mt-2">Esplorazione</div>
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-item nav-active w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors text-sm"><span>üìä</span> Panoramica</button>
            <button onclick="router('database')" id="nav-database" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-stone-600 transition-colors text-sm"><span>üìö</span> Biblioteca</button>
            
            <div class="px-2 py-3 text-[10px] font-bold text-stone-400 uppercase tracking-widest mt-6">Produzione</div>
            <button onclick="router('roadmap')" id="nav-roadmap" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-stone-600 transition-colors text-sm"><span>üó∫Ô∏è</span> Mappa Tesi</button>
            <button onclick="router('citations')" id="nav-citations" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-stone-600 transition-colors text-sm"><span>‚ùû</span> Citazioni</button>
        </nav>

        <div class="px-6 py-6 border-t border-stone-50">
            <div class="bg-stone-50 border border-stone-200 rounded-2xl p-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Sessione Focus</span>
                    <span id="timer-display" class="font-mono text-lg font-bold text-stone-700">25:00</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleTimer()" id="timer-btn" class="flex-1 bg-white border border-stone-200 hover:border-rose-200 hover:text-rose-600 text-stone-600 text-xs py-2 rounded-lg font-medium transition-all shadow-sm">Avvia</button>
                    <button onclick="resetTimer()" class="px-3 bg-stone-200 hover:bg-stone-300 text-stone-600 text-xs py-2 rounded-lg">‚Ü∫</button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-stone-50/50" id="main-wrapper">
        
        <div class="md:hidden bg-white/80 backdrop-blur-md border-b border-stone-200 p-4 flex justify-between items-center z-30 sticky top-0">
            <span class="font-bold serif text-xl text-stone-800">Millino.F</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="text-stone-600">‚ò∞</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-10 relative scroll-smooth" id="content-area">
            
            <div id="view-dashboard" class="space-y-10 fade-in max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-stone-200 pb-8">
                    <div>
                        <h2 class="text-4xl text-stone-900 mb-3 serif font-medium">Bentornata.</h2>
                        <p class="text-stone-500 font-light text-lg">Il database √® attivo. DeepSeek ha accesso a <span id="dash-total-sources" class="font-bold text-rose-500">0</span> fonti.</p>
                    </div>
                    <button onclick="askAI('Fammi un riassunto di cosa mi manca da leggere')" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-full shadow-lg shadow-rose-200 transition-all text-sm font-medium flex items-center gap-2">
                        <span>‚ú®</span> Chiedi all'AI
                    </button>
                </div>

                <div class="paper-card p-8 rounded-3xl">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-stone-800 text-xs uppercase tracking-widest">Stato Avanzamento</h3>
                        <span class="text-rose-500 font-serif font-bold text-xl" id="reading-progress-text">0%</span>
                    </div>
                    <div class="w-full bg-stone-100 rounded-full h-4 overflow-hidden mb-6">
                        <div id="reading-progress-bar" class="bg-gradient-to-r from-rose-400 to-rose-600 h-4 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-stone-50 rounded-2xl p-3 border border-stone-100">
                            <div class="text-2xl font-bold text-stone-700 serif" id="count-todo">0</div>
                            <div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider">Da Leggere</div>
                        </div>
                        <div class="bg-rose-50 rounded-2xl p-3 border border-rose-100">
                            <div class="text-2xl font-bold text-rose-600 serif" id="count-reading">0</div>
                            <div class="text-[10px] uppercase font-bold text-rose-400 tracking-wider">In Corso</div>
                        </div>
                        <div class="bg-emerald-50 rounded-2xl p-3 border border-emerald-100">
                            <div class="text-2xl font-bold text-emerald-600 serif" id="count-done">0</div>
                            <div class="text-[10px] uppercase font-bold text-emerald-400 tracking-wider">Completati</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="paper-card p-6 rounded-3xl border-l-4 border-rose-400">
                        <div class="text-xs text-stone-400 uppercase font-bold tracking-wider mb-2">Focus Principale</div>
                        <div class="text-3xl font-serif text-stone-800 mb-1">Fonti Primarie</div>
                        <div class="text-stone-500 text-sm">Simondon, Deleuze, Guattari...</div>
                        <div class="mt-4 text-3xl font-bold text-rose-500" id="stat-primary">0</div>
                    </div>
                    <div class="paper-card p-6 rounded-3xl">
                         <div class="text-xs text-stone-400 uppercase font-bold tracking-wider mb-2">Motore Semantico</div>
                         <div class="flex items-center gap-3">
                             <div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg">DS</div>
                             <div>
                                 <div class="font-bold text-stone-800">DeepSeek v3.2</div>
                                 <div class="text-xs text-stone-500">Reasoning & Context Aware</div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <div id="view-database" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <div class="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-stone-200 sticky top-0 z-20 flex flex-wrap gap-4 items-center">
                    <div class="flex-1 relative min-w-[200px]">
                        <span class="absolute left-4 top-3 text-stone-400">üîç</span>
                        <input type="text" id="searchInput" placeholder="Cerca autore, titolo o anno..." 
                            class="w-full pl-10 pr-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-rose-200 focus:border-rose-300 outline-none text-sm transition-all text-stone-700 placeholder-stone-400"
                            oninput="runSearch()">
                    </div>
                    <select id="catFilter" onchange="runSearch()" class="px-4 py-2.5 bg-white border border-stone-200 rounded-xl text-sm outline-none cursor-pointer text-stone-600 hover:border-rose-300 transition-colors">
                        <option value="all">Tutte le Categorie</option>
                        <option value="Primary Sources">Fonti Primarie</option>
                        <option value="Comparative Studies">Studi Comparativi</option>
                        <option value="Philosophy of Technology">Filosofia della Tecnica</option>
                        <option value="Ecological Philosophy">Ecologia</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 gap-4" id="results-container"></div>
            </div>

            <div id="view-roadmap" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-stone-200 pb-6">
                    <div>
                        <h2 class="text-3xl font-medium text-stone-900 serif">Roadmap</h2>
                        <p class="text-stone-500">Struttura capitolare e strategia.</p>
                    </div>
                    <select id="roadmapSelect" onchange="renderRoadmap()" class="bg-white border border-stone-200 text-rose-600 font-bold text-sm px-4 py-2 rounded-xl outline-none cursor-pointer shadow-sm">
                        <option value="A">Strategia A: Ontologica</option>
                        <option value="B">Strategia B: Tecno-Ecologica</option>
                        <option value="C">Strategia C: Politica</option>
                    </select>
                </div>
                <div class="bg-rose-50 border border-rose-100 p-8 rounded-3xl">
                    <h3 class="text-rose-900 font-bold text-xl serif mb-2" id="roadmap-title"></h3>
                    <p class="text-rose-800/80" id="roadmap-desc"></p>
                </div>
                <div class="space-y-6" id="chapters-container"></div>
            </div>

            <div id="view-citations" class="hidden space-y-6 fade-in pb-20 max-w-6xl mx-auto">
                <div class="border-b border-stone-200 pb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Citation Manager</h2>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[600px]">
                    <div class="lg:col-span-1 paper-card rounded-2xl flex flex-col overflow-hidden">
                        <div class="p-4 bg-stone-50 border-b border-stone-100 flex justify-between items-center">
                            <span class="font-bold text-stone-600 text-xs uppercase tracking-wider">Fonti Disponibili</span>
                            <button onclick="selectAllCitations()" class="text-rose-500 text-xs font-bold hover:underline">Seleziona Tutto</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="citation-list"></div>
                    </div>
                    <div class="lg:col-span-2 paper-card rounded-2xl flex flex-col">
                        <div class="p-4 bg-stone-50 border-b border-stone-100 flex gap-4 items-center">
                             <select id="citation-style" onchange="generateBibliography()" class="bg-white border border-stone-200 rounded-lg px-3 py-1.5 text-sm outline-none text-stone-600">
                                <option value="apa">APA 7</option>
                                <option value="chicago">Chicago</option>
                                <option value="bibtex">BibTeX</option>
                            </select>
                            <button onclick="copyCitationOutput()" class="text-xs font-bold text-rose-500 uppercase tracking-wider flex items-center gap-1"><span>üìã</span> Copia</button>
                        </div>
                        <textarea id="citation-output" class="flex-1 p-6 font-mono text-xs text-stone-600 outline-none resize-none bg-white" readonly placeholder="Seleziona le fonti a sinistra per generare la bibliografia..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-widget" class="fixed bottom-6 right-6 w-[400px] h-[650px] bg-white rounded-3xl shadow-2xl shadow-stone-900/10 border border-stone-200 flex flex-col z-50 transition-all duration-300 chat-closed origin-bottom-right overflow-hidden ring-1 ring-stone-900/5">
            <div class="bg-white p-4 border-b border-stone-100 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-rose-400 to-orange-400 flex items-center justify-center font-bold text-white text-sm shadow-inner">MF</div>
                    <div><h4 class="font-bold text-stone-800 text-sm">Millino Assistant</h4><div class="text-[10px] text-rose-500 font-medium">Powered by DeepSeek</div></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('chat-messages').innerHTML=''" class="text-stone-400 hover:text-stone-600 text-xs p-2">Pulsci</button>
                    <button onclick="toggleChat()" class="text-stone-400 hover:text-stone-600 p-2">‚úï</button>
                </div>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-4 bg-stone-50/30 scroll-smooth">
                <div class="text-center text-xs text-stone-400 my-4">Chiedimi delle fonti, della tesi o di Simondon.</div>
            </div>
            <div class="p-4 bg-white border-t border-stone-100 shrink-0">
                <div class="flex gap-2 relative">
                    <input type="text" id="chat-input" placeholder="Scrivi qui..." class="flex-1 pl-4 pr-12 py-3.5 bg-stone-50 border border-stone-200 rounded-2xl text-sm focus:ring-2 focus:ring-rose-100 outline-none transition-all" onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" class="absolute right-2 top-2 bottom-2 w-9 h-9 rounded-xl bg-rose-500 hover:bg-rose-600 text-white flex items-center justify-center shadow-md transition-all">‚û§</button>
                </div>
            </div>
        </div>
        
        <button onclick="toggleChat()" class="fixed bottom-6 right-6 w-14 h-14 bg-stone-900 text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform z-40 group">
            <span class="text-2xl group-hover:animate-pulse">‚ú®</span>
        </button>

    </main>

    <script>
        // --- DATA LAYER ---
        const biblioData = [
            // SIMONDON
            { id: "S01", author: "Simondon, G.", year: "2005", title: "L'individuation √† la lumi√®re des notions de forme et d'information", pub: "J√©r√¥me Millon", cat: "Primary Sources", prio: "ESSENTIAL", desc: "Il testo base sull'individuatione.", status: "todo" },
            { id: "S02", author: "Simondon, G.", year: "1958", title: "Du mode d'existence des objets techniques", pub: "Aubier", cat: "Primary Sources", prio: "ESSENTIAL", desc: "Genesi tecnica e alienazione.", status: "todo" },
            { id: "S03", author: "Simondon, G.", year: "1989", title: "L'individuation psychique et collective", pub: "Aubier", cat: "Primary Sources", prio: "HIGH", desc: "Transindividuale e affettivit√†.", status: "todo" },
            { id: "S04", author: "Simondon, G.", year: "2008", title: "Imagination et invention", pub: "La Transparence", cat: "Primary Sources", prio: "HIGH", desc: "Ciclo delle immagini.", status: "todo" },
            { id: "S13", author: "Simondon, G.", year: "1953", title: "La mentalit√© technique", pub: "PUF", cat: "Primary Sources", prio: "HIGH", desc: "Schemi cognitivi tecnici.", status: "todo" },
            // ... (Inserisci qui tutti gli altri libri)
            { id: "D04", author: "Deleuze, G. & Guattari, F.", year: "1980", title: "Mille Plateaux", pub: "Minuit", cat: "Primary Sources", prio: "ESSENTIAL", desc: "Rizoma e agencement.", status: "todo" }
        ];

        const roadmaps = {
            A: {
                title: "Strategia A: Classica Comparativa",
                desc: "Approccio fondativo metafisico che confronta i sistemi.",
                chapters: [
                    { title: "1. La Genesi dell'Individuo", goal: "Confrontare i meccanismi di genesi.", sources: ["S01", "D01", "C02"], structure: ["1.1 La critica all'ilemorfismo.", "1.2 Simondon: Preindividuale.", "1.3 Deleuze: Virtuale."] }
                ]
            },
            B: { title: "Strategia B: Tecno-Ecologica", desc: "Philosophy of Technology.", chapters: [] },
            C: { title: "Strategia C: Politica", desc: "Transindividuale e controllo.", chapters: [] }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            loadProgress(); 
            router('dashboard');
            renderDatabase();
            renderStats();
            renderRoadmap();
            renderCitationsList();
        }

        // --- CORE LOGIC ---
        function saveProgress() {
            const progress = biblioData.map(item => ({ id: item.id, status: item.status }));
            localStorage.setItem('millino_progress', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('millino_progress');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    parsed.forEach(savedItem => {
                        const item = biblioData.find(i => i.id === savedItem.id);
                        if (item) item.status = savedItem.status;
                    });
                } catch(e) { console.error("Error loading progress", e); }
            }
        }

        // --- ROUTING ---
        function router(viewName) {
            ['dashboard', 'database', 'roadmap', 'citations'].forEach(v => {
                document.getElementById('view-' + v)?.classList.add('hidden');
                const btn = document.getElementById('nav-' + v);
                if (btn) { btn.classList.remove('nav-active'); btn.classList.add('text-stone-600'); }
            });
            document.getElementById('view-' + viewName).classList.remove('hidden');
            const btn = document.getElementById('nav-' + viewName);
            if (btn) { btn.classList.add('nav-active'); btn.classList.remove('text-stone-600'); }
            if(window.innerWidth < 768) document.querySelector('aside').classList.add('hidden');
        }

        // --- DATABASE UI ---
        function runSearch() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;
            const filtered = biblioData.filter(i => {
                const matchText = i.title.toLowerCase().includes(txt) || i.author.toLowerCase().includes(txt);
                const matchCat = cat === 'all' || i.cat === cat;
                return matchText && matchCat;
            });
            renderList(filtered);
        }

        function renderList(data) {
            const list = document.getElementById('results-container');
            list.innerHTML = '';
            data.forEach(item => {
                const statusClass = item.status === 'done' ? 'status-done' : (item.status === 'reading' ? 'status-reading' : 'status-todo');
                const statusLabel = item.status === 'done' ? 'Letto' : (item.status === 'reading' ? 'In Corso' : 'Da Leggere');
                
                list.innerHTML += `
                <div class="paper-card p-6 rounded-2xl flex flex-col md:flex-row gap-5 items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-[10px] font-bold px-2 py-1 rounded bg-stone-100 text-stone-500 uppercase tracking-wide border border-stone-200">${item.cat}</span>
                            <button onclick="cycleStatus('${item.id}')" class="text-[10px] px-3 py-1 rounded-full uppercase font-bold cursor-pointer status-btn ${statusClass}">${statusLabel}</button>
                        </div>
                        <h3 class="text-xl font-bold text-stone-800 serif leading-snug mb-1">${item.title}</h3>
                        <div class="text-sm text-rose-600 font-medium font-serif italic">${item.author}, ${item.year}</div>
                        <p class="text-sm text-stone-500 mt-3 leading-relaxed">${item.desc}</p>
                    </div>
                    <div class="flex md:flex-col gap-2 w-full md:w-auto">
                        <button onclick="askAI('Analizza questo testo: ${item.title} di ${item.author}')" class="flex-1 px-4 py-2 bg-stone-800 hover:bg-stone-900 text-white text-xs font-bold rounded-lg transition-colors shadow-lg shadow-stone-200">‚ú® Analizza</button>
                        <button onclick="copySingleCitation('${item.id}')" class="flex-1 px-4 py-2 bg-white border border-stone-200 hover:bg-stone-50 text-stone-600 text-xs font-bold rounded-lg transition-colors">Cita</button>
                    </div>
                </div>`;
            });
        }

        function cycleStatus(id) {
            const idx = biblioData.findIndex(i => i.id === id);
            const map = { 'todo': 'reading', 'reading': 'done', 'done': 'todo' };
            biblioData[idx].status = map[biblioData[idx].status || 'todo'];
            saveProgress(); renderStats(); runSearch();
        }

        function renderStats() {
            const done = biblioData.filter(i => i.status === 'done').length;
            const total = biblioData.length;
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            
            document.getElementById('dash-total-sources').innerText = total;
            document.getElementById('stat-primary').innerText = biblioData.filter(i => i.cat === 'Primary Sources').length;
            document.getElementById('count-todo').innerText = biblioData.filter(i => i.status === 'todo').length;
            document.getElementById('count-reading').innerText = biblioData.filter(i => i.status === 'reading').length;
            document.getElementById('count-done').innerText = done;

            document.getElementById('reading-progress-text').innerText = pct + "%";
            document.getElementById('reading-progress-bar').style.width = pct + "%";
        }

        // --- CITATIONS & ROADMAP ---
        function renderCitationsList() {
            const list = document.getElementById('citation-list');
            list.innerHTML = '';
            biblioData.forEach(item => {
                list.innerHTML += `<label class="flex items-center gap-3 p-3 hover:bg-stone-50 rounded-lg cursor-pointer transition-colors border-b border-stone-50 last:border-0"><input type="checkbox" class="w-4 h-4 rounded border-stone-300 text-rose-500 focus:ring-rose-500 cite-cb" value="${item.id}" onchange="generateBibliography()"><span class="text-xs text-stone-600 font-medium truncate">${item.author} <span class="text-stone-400 mx-1">‚Ä¢</span> ${item.title}</span></label>`;
            });
        }
        function selectAllCitations() { document.querySelectorAll('.cite-cb').forEach(cb => cb.checked = true); generateBibliography(); }
        function copySingleCitation(id) { const i = biblioData.find(x => x.id === id); navigator.clipboard.writeText(`${i.author} (${i.year}). ${i.title}.`); alert("Copiato!"); }
        function generateBibliography() {
            const checked = Array.from(document.querySelectorAll('.cite-cb:checked')).map(c => c.value);
            const items = biblioData.filter(i => checked.includes(i.id));
            let out = "";
            const style = document.getElementById('citation-style').value;
            items.forEach(i => { out += style==='bibtex' ? `@book{${i.id}, title={${i.title}}...}\n` : `${i.author} (${i.year}). ${i.title}.\n\n`; });
            document.getElementById('citation-output').value = out;
        }
        function copyCitationOutput() { const txt = document.getElementById('citation-output'); txt.select(); navigator.clipboard.writeText(txt.value); alert("Copiato negli appunti!"); }
        
        function renderRoadmap() {
            const sel = document.getElementById('roadmapSelect').value;
            const p = roadmaps[sel];
            document.getElementById('roadmap-title').innerText = p.title;
            document.getElementById('roadmap-desc').innerText = p.desc;
            const c = document.getElementById('chapters-container');
            c.innerHTML = '';
            p.chapters.forEach(chap => {
                c.innerHTML += `
                <div class="bg-white rounded-2xl border border-stone-200 p-6 shadow-sm hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-stone-800 text-lg serif">${chap.title}</h4>
                        <button onclick="askAI('Aiutami a strutturare il capitolo: ${chap.title}')" class="text-[10px] bg-stone-100 hover:bg-stone-200 text-stone-600 px-3 py-1.5 rounded-lg font-bold uppercase tracking-wider transition-colors">AI Help</button>
                    </div>
                    <p class="text-sm text-stone-600 mb-4 bg-stone-50 p-3 rounded-lg border border-stone-100 italic">${chap.goal}</p>
                    <div class="grid grid-cols-2 gap-6 mt-4 pt-4 border-t border-stone-100">
                        <div><h5 class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-2">Struttura</h5><ul class="text-sm space-y-1 text-stone-600 list-disc pl-4 marker:text-rose-300">${chap.structure.map(s=>`<li>${s}</li>`).join('')}</ul></div>
                    </div>
                </div>`;
            });
        }

        // --- AI ENGINE (CONTEXT AWARE) ---
        function toggleChat() { 
            const widget = document.getElementById('chat-widget');
            const btn = document.querySelector('button[onclick="toggleChat()"].fixed'); // Floating btn
            
            if (widget.classList.contains('chat-closed')) {
                widget.classList.remove('chat-closed');
                widget.classList.add('chat-open');
                btn.classList.add('scale-0'); // Nascondi il bottone galleggiante
            } else {
                widget.classList.add('chat-closed');
                widget.classList.remove('chat-open');
                btn.classList.remove('scale-0'); // Mostra bottone
            }
        }
        
        async function sendChat() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;
            
            addMessage(txt, 'user');
            inp.value = '';
            
            const loadId = 'load-' + Date.now();
            document.getElementById('chat-messages').innerHTML += `<div id="${loadId}" class="flex items-center gap-2 text-xs text-stone-400 mt-4 ml-2"><span class="w-2 h-2 bg-rose-400 rounded-full animate-pulse"></span> DeepSeek sta leggendo la biblioteca...</div>`;

            try {
                // INVIA I DATI BIBLIOGRAFICI NEL BODY DELLA RICHIESTA
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: txt,
                        context: biblioData // <--- ECCO IL TRUCCO: Inviamo tutto il DB
                    })
                });
                
                const data = await res.json();
                document.getElementById(loadId).remove();
                
                if (data.error) throw new Error(data.error);
                addMessage(data.choices[0].message.content, 'bot');

            } catch(e) {
                document.getElementById(loadId).remove();
                const localRes = localBrain(txt);
                addMessage(`‚ö†Ô∏è <b>Server Error:</b> ${e.message}<br><br>ü§ñ <b>Local Fallback:</b> ${localRes}`, 'bot');
            }
        }

        function localBrain(query) {
            const q = query.toLowerCase();
            const found = biblioData.filter(i => q.includes(i.title.toLowerCase()) || q.includes(i.author.toLowerCase().split(',')[0].toLowerCase()));
            if(found.length > 0) return `Offline mode. Trovato: <br>${found.map(f => `- ${f.title}`).join('<br>')}`;
            return "Nessuna connessione.";
        }

        function addMessage(txt, role) {
            const box = document.getElementById('chat-messages');
            const isUser = role === 'user';
            const html = marked.parse(txt);
            
            box.innerHTML += `
            <div class="flex gap-3 ${isUser ? 'flex-row-reverse' : ''} fade-in mt-4">
                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold shadow-sm ${isUser ? 'bg-stone-200 text-stone-600' : 'bg-rose-500 text-white'}">
                    ${isUser ? 'TU' : 'MF'}
                </div>
                <div class="p-4 rounded-2xl text-sm max-w-[85%] shadow-sm prose prose-sm prose-p:leading-relaxed prose-a:text-rose-600 ${isUser ? 'bg-white border border-stone-100 text-stone-700' : 'bg-white border border-rose-100 text-stone-700'}">
                    ${html}
                </div>
            </div>`;
            box.scrollTop = box.scrollHeight;
        }
        
        function askAI(q) { 
            const widget = document.getElementById('chat-widget');
            if(widget.classList.contains('chat-closed')) toggleChat();
            document.getElementById('chat-input').value = q; 
            sendChat(); 
        }

        // --- POMODORO ---
        let timer, time = 1500, running = false;
        function toggleTimer() {
            const btn = document.getElementById('timer-btn');
            if(running) { clearInterval(timer); running = false; btn.innerText = "Avvia"; btn.classList.remove('bg-rose-50', 'text-rose-600', 'border-rose-200'); }
            else {
                running = true; btn.innerText = "Pausa"; btn.classList.add('bg-rose-50', 'text-rose-600', 'border-rose-200');
                timer = setInterval(() => {
                    time--;
                    const m = Math.floor(time/60).toString().padStart(2,'0'), s = (time%60).toString().padStart(2,'0');
                    document.getElementById('timer-display').innerText = `${m}:${s}`;
                    if(time<=0) { clearInterval(timer); alert("Tempo!"); resetTimer(); }
                }, 1000);
            }
        }
        function resetTimer() { clearInterval(timer); running = false; time = 1500; document.getElementById('timer-display').innerText="25:00"; document.getElementById('timer-btn').innerText="Avvia"; document.getElementById('timer-btn').classList.remove('bg-rose-50', 'text-rose-600', 'border-rose-200');}
    </script>
</body>
</html>
