<!DOCTYPE html>
<html lang="it" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millino Fagiolino | Research OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="js/database.js"></script> 
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,500;0,600;1,500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Palette professionale "Warm Stone"
                        stone: { 50: '#FBFBFB', 100: '#F5F5F4', 200: '#E7E5E4', 300: '#D6D3D1', 800: '#292524', 900: '#1C1917' },
                        // Accent "Rose Clay" - meno saturo, pi√π elegante
                        rose: { 50: '#FFF1F2', 100: '#FFE4E6', 400: '#FB7185', 500: '#F43F5E', 600: '#E11D48', 900: '#881337' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'soft': '0 2px 10px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FBFBFB; color: #1C1917; }
        
        /* Premium Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #E7E5E4; border-radius: 99px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        /* Navigation Styles */
        .nav-item { transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .nav-active { 
            background-color: white; 
            color: #1C1917; 
            font-weight: 500; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.04); 
            border: 1px solid #E7E5E4;
        }
        
        /* Card Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(231, 229, 228, 0.8);
        }
        .pro-card {
            background: white;
            border: 1px solid #E7E5E4;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .pro-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            border-color: #D6D3D1;
            transform: translateY(-1px);
        }

        /* Status Badges */
        .badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 99px; letter-spacing: 0.02em; border: 1px solid transparent; }
        .badge-todo { background: #F5F5F4; color: #78716C; border-color: #E7E5E4; }
        .badge-reading { background: #FFF1F2; color: #E11D48; border-color: #FECDD3; }
        .badge-done { background: #F0FDF4; color: #15803D; border-color: #BBF7D0; }

        /* Typography & Animation */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .chat-widget { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        .chat-open { transform: translateY(0) scale(1); opacity: 1; pointer-events: all; }
        .chat-closed { transform: translateY(20px) scale(0.96); opacity: 0; pointer-events: none; }
        
        /* Markdown Overrides */
        .prose p { margin-bottom: 0.75em; line-height: 1.6; color: #44403C; font-size: 0.95rem; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.75em; }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-rose-100 selection:text-rose-900">

    <aside class="w-[280px] bg-[#FBFBFB] border-r border-stone-200 flex-shrink-0 flex flex-col z-30 hidden md:flex">
        <div class="p-6 pt-8 pb-2">
            <h1 class="text-2xl font-semibold text-stone-900 tracking-tight serif flex items-baseline gap-1">
                Millino<span class="text-rose-500 italic font-serif">.F</span>
            </h1>
            <p class="text-[11px] text-stone-400 font-medium mt-1 tracking-wide">RESEARCH OS v2.1</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 px-4 space-y-8">
            <div>
                <div class="px-3 mb-2 text-[10px] font-bold text-stone-400 uppercase tracking-widest">Esplorazione</div>
                <div class="space-y-1">
                    <button onclick="router('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100">
                        <span class="text-stone-400 text-lg">üìä</span> Panoramica
                    </button>
                    <button onclick="router('database')" id="nav-database" class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100">
                        <span class="text-stone-400 text-lg">üìö</span> Biblioteca
                    </button>
                    <button onclick="router('journal')" id="nav-journal" class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100">
                        <span class="text-stone-400 text-lg">üìî</span> Diario
                    </button>
                </div>
            </div>
            
            <div>
                <div class="px-3 mb-2 text-[10px] font-bold text-stone-400 uppercase tracking-widest">Produzione</div>
                <div class="space-y-1">
                    <button onclick="router('roadmap')" id="nav-roadmap" class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100">
                        <span class="text-stone-400 text-lg">üó∫Ô∏è</span> Roadmap
                    </button>
                    <button onclick="router('tracker')" id="nav-tracker" class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100">
                        <span class="text-stone-400 text-lg">üìà</span> Tracker
                    </button>
                    <button onclick="router('citations')" id="nav-citations" class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100">
                        <span class="text-stone-400 text-lg">‚ùû</span> Citazioni
                    </button>
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-stone-100 bg-white">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Deep Work</span>
                <span id="timer-display" class="font-mono text-sm font-semibold text-rose-600">25:00</span>
            </div>
            
            <div class="flex justify-between items-center mb-4 px-2">
                <button onclick="toggleSound('rain')" id="btn-rain" class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Pioggia">üåßÔ∏è</button>
                <button onclick="toggleSound('cafe')" id="btn-cafe" class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Caff√®">‚òï</button>
                <button onclick="toggleSound('fire')" id="btn-fire" class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Camino">üî•</button>
            </div>

            <div class="flex gap-2">
                <button onclick="toggleTimer()" id="timer-btn" class="flex-1 bg-stone-900 hover:bg-black text-white text-xs py-2 rounded-md font-medium transition-all shadow-sm">Focus</button>
                <button onclick="resetTimer()" class="px-3 bg-stone-100 hover:bg-stone-200 text-stone-500 text-xs py-2 rounded-md transition-colors">‚Ü∫</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-white" id="main-wrapper">
        
        <div class="md:hidden bg-white/80 backdrop-blur-md border-b border-stone-200 p-4 flex justify-between items-center z-30 sticky top-0">
            <span class="font-semibold serif text-lg text-stone-900">Millino.F</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="text-stone-600">‚ò∞</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 md:p-12 relative scroll-smooth" id="content-area">
            
            <div id="view-dashboard" class="space-y-10 fade-in max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-stone-100 pb-8">
                    <div>
                        <h2 class="text-3xl md:text-4xl text-stone-900 mb-2 serif font-medium tracking-tight">Panoramica</h2>
                        <div class="flex items-center gap-3 text-sm text-stone-500">
                            <span>Deadline Tesi:</span>
                            <input type="date" id="deadline-input" onchange="saveDeadline()" class="bg-transparent border-b border-stone-200 focus:border-rose-500 outline-none text-stone-800 font-medium text-sm pb-0.5">
                            <span id="days-remaining" class="text-[10px] bg-rose-50 text-rose-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-wide hidden"></span>
                        </div>
                    </div>
                    <button onclick="askAI('Fammi un briefing su cosa mi manca da leggere e suggerisci una priorit√†')" class="group bg-white border border-stone-200 hover:border-rose-200 hover:shadow-soft text-stone-600 px-5 py-2.5 rounded-full transition-all text-sm font-medium flex items-center gap-2">
                        <span class="text-lg group-hover:scale-110 transition-transform">‚ú®</span> AI Briefing
                    </button>
                </div>

                <div class="pro-card p-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div> <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="font-bold text-stone-400 text-[10px] uppercase tracking-widest mb-1">Avanzamento Globale</h3>
                            <div class="text-3xl font-serif font-medium text-stone-900"><span id="reading-progress-text">0%</span> <span class="text-lg text-stone-400 italic">completato</span></div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-stone-100 rounded-full h-2 overflow-hidden mb-8">
                        <div id="reading-progress-bar" class="bg-stone-800 h-2 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-8 text-center border-t border-stone-100 pt-6">
                        <div><div class="text-2xl font-semibold text-stone-900 serif" id="count-todo">0</div><div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider mt-1">Da Leggere</div></div>
                        <div><div class="text-2xl font-semibold text-rose-500 serif" id="count-reading">0</div><div class="text-[10px] uppercase font-bold text-rose-300 tracking-wider mt-1">In Corso</div></div>
                        <div><div class="text-2xl font-semibold text-stone-900 serif" id="count-done">0</div><div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider mt-1">Archiviati</div></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="pro-card p-6 flex flex-col justify-between h-32">
                        <div class="flex justify-between items-start">
                            <div class="text-xs text-stone-400 uppercase font-bold tracking-wider">Fonti Primarie</div>
                            <span class="text-lg">üìö</span>
                        </div>
                        <div class="text-3xl font-serif text-stone-900" id="stat-primary">0</div>
                    </div>
                    <div class="pro-card p-6 flex items-center gap-4 h-32">
                         <div class="w-12 h-12 rounded-full bg-stone-100 flex items-center justify-center text-stone-900 font-bold text-lg">DS</div>
                         <div>
                             <div class="font-bold text-stone-900 text-sm">DeepSeek v3.2</div>
                             <div class="text-xs text-stone-500">Reasoning Engine Active</div>
                         </div>
                    </div>
                </div>
            </div>

            <div id="view-database" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <div class="glass-card sticky top-2 z-20 p-2 rounded-xl flex gap-2 items-center shadow-soft mb-8">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-2.5 text-stone-400 text-sm">üîç</span>
                        <input type="text" id="searchInput" placeholder="Cerca autore, titolo, anno..." 
                            class="w-full pl-9 pr-4 py-2 bg-transparent border-none focus:ring-0 text-sm text-stone-800 placeholder-stone-400 h-9"
                            oninput="runSearch()">
                    </div>
                    <div class="w-px h-6 bg-stone-200"></div>
                    <select id="catFilter" onchange="runSearch()" class="bg-transparent border-none text-xs font-medium text-stone-600 outline-none cursor-pointer hover:text-stone-900 pr-8">
                        <option value="all">Tutte le Categorie</option>
                        <option value="Primary Sources">Fonti Primarie</option>
                        <option value="Comparative Studies">Studi Comparativi</option>
                        <option value="Philosophy of Technology">Tecnica</option>
                        <option value="Ecological Philosophy">Ecologia</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 gap-3" id="results-container">
                    </div>
            </div>

            <div id="view-journal" class="hidden space-y-8 fade-in pb-20 max-w-3xl mx-auto">
                <div class="border-b border-stone-100 pb-6 mb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Diario di Bordo</h2>
                    <p class="text-stone-500 text-sm mt-2">Annota pensieri, blocchi e intuizioni giornaliere.</p>
                </div>
                
                <div class="pro-card p-1">
                    <textarea id="journal-entry" class="w-full h-32 p-4 bg-white rounded-t-xl border-none outline-none resize-none text-sm text-stone-700 placeholder-stone-300" placeholder="A cosa stai pensando oggi?"></textarea>
                    <div class="bg-stone-50 p-2 rounded-b-xl flex justify-end border-t border-stone-100">
                        <button onclick="addJournalEntry()" class="bg-stone-900 text-white px-4 py-1.5 rounded-md text-xs font-medium hover:bg-black transition-colors">Salva Nota</button>
                    </div>
                </div>
                
                <div id="journal-container" class="space-y-6 relative before:absolute before:left-4 before:top-0 before:h-full before:w-px before:bg-stone-200 pl-10">
                    </div>
            </div>

            <div id="view-tracker" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="border-b border-stone-100 pb-6"><h2 class="text-3xl font-medium text-stone-900 serif">Word Tracker</h2></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="pro-card p-6 rounded-xl col-span-1 h-fit">
                        <h4 class="font-bold text-stone-900 text-sm mb-4">Aggiornamento Quotidiano</h4>
                        <input type="number" id="word-input" class="w-full p-2.5 bg-stone-50 border border-stone-200 rounded-lg mb-4 text-sm outline-none focus:border-rose-300 transition-colors" placeholder="Totale parole oggi...">
                        <button onclick="updateWordCount()" class="w-full bg-stone-900 text-white py-2.5 rounded-lg text-sm font-medium hover:bg-black transition-colors">Registra</button>
                    </div>
                    <div class="pro-card p-6 rounded-xl col-span-2">
                        <canvas id="wordChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-roadmap" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="flex justify-between items-center border-b border-stone-100 pb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Roadmap</h2>
                    <button onclick="triggerSpark()" class="bg-rose-50 text-rose-600 border border-rose-100 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-rose-100 transition-colors">
                        <span>‚ú®</span> Sblocco Creativo
                    </button>
                </div>
                
                <div class="flex gap-4 mb-6">
                    <select id="roadmapSelect" onchange="renderRoadmap()" class="bg-white border border-stone-200 text-stone-700 font-medium text-sm px-4 py-2 rounded-lg outline-none cursor-pointer hover:border-stone-300">
                        <option value="A">Strategia A: Ontologica</option>
                        <option value="B">Strategia B: Tecno-Ecologica</option>
                        <option value="C">Strategia C: Politica</option>
                    </select>
                </div>

                <div class="bg-stone-50 border border-stone-200 p-8 rounded-xl mb-6">
                    <h3 class="text-stone-900 font-serif text-xl mb-2" id="roadmap-title"></h3>
                    <p class="text-stone-500 text-sm leading-relaxed" id="roadmap-desc"></p>
                </div>
                <div class="space-y-4" id="chapters-container"></div>
            </div>

            <div id="view-citations" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <div class="flex justify-between items-center border-b border-stone-100 pb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Citation Manager</h2>
                    <button onclick="downloadBibliography()" class="text-stone-600 text-xs font-bold border border-stone-200 px-3 py-1.5 rounded hover:bg-stone-50 transition-colors">üì• Export .txt</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
                    <div class="lg:col-span-1 pro-card flex flex-col overflow-hidden">
                        <div class="p-3 bg-stone-50 border-b border-stone-100 flex justify-between items-center">
                            <span class="font-semibold text-stone-500 text-[10px] uppercase tracking-wider">Fonti</span>
                            <button onclick="selectAllCitations()" class="text-rose-500 text-[10px] font-bold hover:underline">Seleziona Tutti</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="citation-list"></div>
                    </div>
                    <div class="lg:col-span-2 pro-card flex flex-col">
                        <div class="p-3 bg-stone-50 border-b border-stone-100 flex gap-4 items-center justify-between">
                             <select id="citation-style" onchange="generateBibliography()" class="bg-white border border-stone-200 rounded px-2 py-1 text-xs outline-none text-stone-600">
                                <option value="apa">APA 7</option>
                                <option value="chicago">Chicago</option>
                                <option value="bibtex">BibTeX</option>
                            </select>
                            <button onclick="copyCitationOutput()" class="text-xs font-bold text-stone-600 hover:text-stone-900">Copia</button>
                        </div>
                        <textarea id="citation-output" class="flex-1 p-6 font-mono text-xs text-stone-600 outline-none resize-none bg-white" readonly placeholder="Output bibliografico..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="book-modal" class="fixed inset-0 bg-stone-900/20 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-float p-8 transform transition-all scale-100 border border-stone-100">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h3 id="modal-title" class="text-2xl font-serif font-medium text-stone-900 mb-1"></h3>
                        <p id="modal-author" class="text-rose-500 text-sm font-medium"></p>
                    </div>
                    <button onclick="closeModal()" class="text-stone-300 hover:text-stone-600 text-2xl leading-none">&times;</button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Tag</label>
                        <input type="text" id="modal-tags" class="w-full p-3 bg-stone-50 rounded-lg border border-stone-200 text-sm outline-none focus:border-stone-400 transition-colors" placeholder="es. #difficile, #capitolo1...">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Note personali</label>
                        <textarea id="modal-notes" class="w-full h-40 p-3 bg-stone-50 rounded-lg border border-stone-200 text-sm resize-none outline-none focus:border-stone-400 transition-colors leading-relaxed" placeholder="Scrivi qui i tuoi pensieri. DeepSeek li user√† come contesto."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-stone-100">
                    <button onclick="askAIAboutBook()" class="px-4 py-2 bg-white border border-stone-200 text-stone-600 font-medium rounded-lg text-xs hover:border-rose-200 hover:text-rose-600 transition-all">Chiedi all'AI</button>
                    <button onclick="saveBookDetails()" class="px-6 py-2 bg-stone-900 text-white font-medium rounded-lg text-xs hover:bg-black transition-colors shadow-soft">Salva Modifiche</button>
                </div>
            </div>
        </div>

        <div id="chat-widget" class="fixed bottom-6 right-6 w-[380px] h-[600px] bg-white rounded-2xl shadow-float border border-stone-200 flex flex-col z-50 chat-closed overflow-hidden">
            <div class="bg-white p-4 border-b border-stone-100 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-stone-900 flex items-center justify-center font-bold text-white text-[10px]">DS</div>
                    <div><h4 class="font-semibold text-stone-900 text-sm">Assistant</h4><div class="text-[10px] text-stone-400">DeepSeek v3.2 Enhanced</div></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('chat-messages').innerHTML=''" class="text-stone-300 hover:text-stone-600 text-xs px-2">Clear</button>
                    <button onclick="toggleChat()" class="text-stone-300 hover:text-stone-600">&times;</button>
                </div>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-6 bg-[#FAFAFA]">
                <div class="text-center text-xs text-stone-300 mt-4">Research Context Active</div>
            </div>
            <div class="p-3 bg-white border-t border-stone-100 shrink-0">
                <div class="relative">
                    <input type="text" id="chat-input" placeholder="Chiedi..." class="w-full pl-4 pr-10 py-3 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-stone-400 outline-none transition-colors" onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" class="absolute right-2 top-2 bottom-2 w-8 h-8 rounded-lg bg-stone-900 text-white flex items-center justify-center hover:bg-black transition-colors">‚Üë</button>
                </div>
            </div>
        </div>
        
        <button onclick="toggleChat()" class="fixed bottom-6 right-6 w-12 h-12 bg-stone-900 text-white rounded-full shadow-float flex items-center justify-center hover:scale-105 transition-transform z-40 group">
            <span class="text-xl">‚ú®</span>
        </button>

    </main>

    <audio id="audio-rain" loop src="https://assets.mixkit.co/active_storage/sfx/2499/2499-preview.mp3"></audio>
    <audio id="audio-cafe" loop src="https://assets.mixkit.co/active_storage/sfx/248/248-preview.mp3"></audio>
    <audio id="audio-fire" loop src="https://assets.mixkit.co/active_storage/sfx/1239/1239-preview.mp3"></audio>

    <script>
        // GLOBALS
        let biblioData = []; 
        let currentBookId = null;
        let wordHistory = JSON.parse(localStorage.getItem('word_history')) || [];
        let journalEntries = JSON.parse(localStorage.getItem('journal_entries')) || [];

        document.addEventListener('DOMContentLoaded', () => {
            mergeData(); 
            initApp();
            initAudio();
        });

        function mergeData() {
            // Assicurati che MASTER_DB sia definito in js/database.js
            if(typeof MASTER_DB === 'undefined') { console.error("Database missing"); return; }
            const saved = JSON.parse(localStorage.getItem('millino_progress')) || [];
            biblioData = MASTER_DB.map(book => {
                const userState = saved.find(s => s.id === book.id) || {};
                return { 
                    ...book, 
                    status: userState.status || 'todo',
                    notes: userState.notes || '',
                    tags: userState.tags || []
                };
            });
        }

        function initApp() {
            renderDeadline();
            router('dashboard');
            renderDatabase();
            renderStats();
            renderJournal();
            renderTracker();
            renderRoadmap(); 
            renderCitationsList();
        }

        function saveData() {
            const progress = biblioData.map(b => ({ id: b.id, status: b.status, notes: b.notes, tags: b.tags }));
            localStorage.setItem('millino_progress', JSON.stringify(progress));
        }

        // --- ROUTING ---
        function router(viewName) {
            ['dashboard', 'database', 'journal', 'tracker', 'roadmap', 'citations'].forEach(v => {
                document.getElementById('view-' + v)?.classList.add('hidden');
                document.getElementById('nav-' + v)?.classList.remove('nav-active');
            });
            document.getElementById('view-' + viewName).classList.remove('hidden');
            document.getElementById('nav-' + viewName).classList.add('nav-active');
            if(window.innerWidth < 768) document.querySelector('aside').classList.add('hidden');
        }

        // --- DATABASE & MODAL ---
        function runSearch() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;
            const filtered = biblioData.filter(i => (i.title.toLowerCase().includes(txt) || i.author.toLowerCase().includes(txt)) && (cat === 'all' || i.cat === cat));
            renderList(filtered);
        }

        function renderList(data) {
            const list = document.getElementById('results-container');
            list.innerHTML = '';
            data.forEach(item => {
                const statusClass = item.status === 'done' ? 'badge-done' : (item.status === 'reading' ? 'badge-reading' : 'badge-todo');
                const tagBadges = (item.tags || []).map(t => `<span class="text-[9px] text-stone-500 bg-stone-100 px-1.5 py-0.5 rounded mr-1">#${t}</span>`).join('');
                
                list.innerHTML += `
                <div class="pro-card p-4 flex flex-col md:flex-row gap-4 items-start cursor-pointer hover:border-stone-300" onclick="openBookModal('${item.id}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1.5">
                            <span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider">${item.cat}</span>
                            <button onclick="event.stopPropagation(); cycleStatus('${item.id}')" class="badge uppercase ${statusClass}">${item.status}</button>
                            ${item.notes ? '<span class="text-rose-500 text-[10px]">‚óè</span>' : ''}
                        </div>
                        <h3 class="text-lg font-medium text-stone-900 serif leading-snug mb-0.5">${item.title}</h3>
                        <div class="text-xs text-stone-500 font-medium">${item.author}, ${item.year}</div>
                        <div class="mt-2">${tagBadges}</div>
                    </div>
                </div>`;
            });
        }

        function openBookModal(id) {
            currentBookId = id;
            const book = biblioData.find(b => b.id === id);
            document.getElementById('modal-title').innerText = book.title;
            document.getElementById('modal-author').innerText = book.author;
            document.getElementById('modal-notes').value = book.notes || '';
            document.getElementById('modal-tags').value = (book.tags || []).join(', ');
            document.getElementById('book-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('book-modal').querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
        }

        function saveBookDetails() {
            const book = biblioData.find(b => b.id === currentBookId);
            book.notes = document.getElementById('modal-notes').value;
            const rawTags = document.getElementById('modal-tags').value;
            book.tags = rawTags.split(',').map(t => t.trim()).filter(t => t);
            saveData();
            closeModal();
            runSearch();
        }

        function closeModal() { 
            document.getElementById('book-modal').classList.add('hidden');
        }
        
        function cycleStatus(id) {
            const idx = biblioData.findIndex(i => i.id === id);
            const map = { 'todo': 'reading', 'reading': 'done', 'done': 'todo' };
            biblioData[idx].status = map[biblioData[idx].status || 'todo'];
            if(biblioData[idx].status === 'done') confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: ['#E7E5E4', '#F43F5E'] });
            saveData(); renderStats(); runSearch();
        }
        
        function renderStats() {
             const done = biblioData.filter(i => i.status === 'done').length;
             const total = biblioData.length;
             const pct = total === 0 ? 0 : Math.round((done / total) * 100);
             document.getElementById('reading-progress-text').innerText = pct + "%";
             document.getElementById('reading-progress-bar').style.width = pct + "%";
             document.getElementById('count-todo').innerText = biblioData.filter(i => i.status === 'todo').length;
             document.getElementById('count-reading').innerText = biblioData.filter(i => i.status === 'reading').length;
             document.getElementById('count-done').innerText = done;
             document.getElementById('stat-primary').innerText = biblioData.filter(i => i.cat === 'Primary Sources').length;
        }

        // --- JOURNAL ---
        function renderJournal() {
            const cont = document.getElementById('journal-container');
            if(journalEntries.length === 0) { cont.innerHTML = `<div class="text-center text-xs text-stone-300 italic py-8">Il diario √® vuoto.</div>`; return; }
            cont.innerHTML = journalEntries.map(e => `
                <div class="relative pl-6">
                    <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full bg-stone-200 border-2 border-white"></div>
                    <div class="text-[10px] text-stone-400 font-bold uppercase tracking-wider mb-1">${e.date}</div>
                    <div class="bg-white p-4 rounded-lg border border-stone-100 shadow-sm">
                        <p class="text-stone-700 text-sm whitespace-pre-wrap leading-relaxed">${e.text}</p>
                    </div>
                </div>
            `).join('');
        }
        function addJournalEntry() {
            const txt = document.getElementById('journal-entry').value;
            if(!txt) return;
            journalEntries.unshift({ date: new Date().toLocaleDateString('it-IT', { weekday:'short', day:'numeric', month:'short' }), text: txt });
            localStorage.setItem('journal_entries', JSON.stringify(journalEntries));
            document.getElementById('journal-entry').value = '';
            renderJournal();
        }

        // --- WORD TRACKER ---
        let chartInstance = null;
        function renderTracker() {
            const ctx = document.getElementById('wordChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: wordHistory.map(h => h.date),
                    datasets: [{ 
                        label: 'Parole Totali', 
                        data: wordHistory.map(h => h.count), 
                        borderColor: '#1C1917', 
                        tension: 0.3, 
                        borderWidth: 2,
                        pointBackgroundColor: '#FFF',
                        pointBorderColor: '#1C1917',
                        pointRadius: 3,
                        fill: { target: 'origin', above: 'rgba(28, 25, 23, 0.02)' }
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1C1917', padding: 10, cornerRadius: 8 } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: '#F5F5F4' }, border: { display: false } }
                    }
                }
            });
        }
        function updateWordCount() {
            const val = parseInt(document.getElementById('word-input').value);
            if(!val) return;
            const today = new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const idx = wordHistory.findIndex(h => h.date === today);
            if(idx >= 0) wordHistory[idx].count = val;
            else wordHistory.push({ date: today, count: val });
            localStorage.setItem('word_history', JSON.stringify(wordHistory));
            renderTracker();
        }

        // --- DEADLINE ---
        function saveDeadline() {
            const d = document.getElementById('deadline-input').value;
            localStorage.setItem('thesis_deadline', d);
            renderDeadline();
        }
        function renderDeadline() {
            const d = localStorage.getItem('thesis_deadline');
            if(d) {
                document.getElementById('deadline-input').value = d;
                const days = Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60 * 24));
                const span = document.getElementById('days-remaining');
                span.classList.remove('hidden');
                span.innerText = `${days} GIORNI`;
            }
        }

        // --- EXPORT BIBLIO ---
        function downloadBibliography() {
            const txt = biblioData.filter(b => b.status === 'done' || b.status === 'reading').map(b => `${b.author} (${b.year}). ${b.title}. ${b.pub}.`).join('\n\n');
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "bibliografia_millino.txt";
            a.click();
        }

        // --- SPARK & AI ---
        function askAIAboutBook() {
            const book = biblioData.find(b => b.id === currentBookId);
            const prompt = `Ho preso queste note sul libro "${book.title}": "${book.notes}". Aiutami a espanderle o collegarle a Simondon.`;
            closeModal();
            toggleChat();
            askAI(prompt);
        }

        function triggerSpark() {
            toggleChat();
            addMessage("Analizzo lo stato della tesi per sbloccarti...", 'user');
            sendChat('spark');
        }

        function toggleChat() { 
            const w = document.getElementById('chat-widget');
            w.classList.toggle('chat-closed'); w.classList.toggle('chat-open');
        }

        function addMessage(txt, role) {
            const box = document.getElementById('chat-messages');
            const html = marked.parse(txt);
            const align = role === 'user' ? 'justify-end' : 'justify-start';
            const style = role === 'user' ? 'bg-stone-900 text-white rounded-br-none' : 'bg-white border border-stone-200 text-stone-800 rounded-bl-none shadow-sm';
            
            box.innerHTML += `
            <div class="flex ${align} fade-in">
                <div class="py-2.5 px-4 rounded-2xl text-sm max-w-[85%] prose prose-sm prose-p:my-1 ${style}">
                    ${html}
                </div>
            </div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function sendChat(mode = 'chat') {
            const inp = document.getElementById('chat-input');
            const txt = mode === 'spark' ? "Sblocco Creativo" : inp.value.trim();
            if(!txt && mode !== 'spark') return;
            
            if(mode !== 'spark') { addMessage(txt, 'user'); inp.value = ''; }
            
            const loadId = 'load-' + Date.now();
            document.getElementById('chat-messages').innerHTML += `<div id="${loadId}" class="text-[10px] text-stone-400 mt-2 ml-2 animate-pulse">DeepSeek sta pensando...</div>`;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: txt, context: biblioData, mode: mode })
                });
                const data = await res.json();
                document.getElementById(loadId).remove();
                addMessage(data.choices[0].message.content, 'bot');
            } catch(e) {
                document.getElementById(loadId).remove();
                addMessage("Errore di connessione al server Vercel.", 'bot');
            }
        }
        function askAI(q) { document.getElementById('chat-input').value = q; sendChat(); }

        // --- SOUNDS & TIMER ---
        function toggleSound(id) {
            const el = document.getElementById('audio-'+id);
            const btn = document.getElementById('btn-'+id);
            if(el.paused) { el.play(); btn.classList.remove('text-stone-300'); btn.classList.add('text-stone-900'); }
            else { el.pause(); btn.classList.add('text-stone-300'); btn.classList.remove('text-stone-900'); }
        }
        function initAudio() { 
            // Audio init logic
        }
        
        // --- TIMER ---
        let timer, time=1500, running=false;
        function toggleTimer() {
            if(running) { clearInterval(timer); running=false; document.getElementById('timer-btn').innerText="Focus"; }
            else { running=true; document.getElementById('timer-btn').innerText="Pausa"; timer=setInterval(()=>{ time--; let m=Math.floor(time/60), s=time%60; document.getElementById('timer-display').innerText=`${m}:${s.toString().padStart(2,'0')}`; if(time<=0) resetTimer(); },1000); }
        }
        function resetTimer() { clearInterval(timer); running=false; time=1500; document.getElementById('timer-display').innerText="25:00"; document.getElementById('timer-btn').innerText="Focus"; }

        // --- UTILS ---
        function renderRoadmap() {
             const sel = document.getElementById('roadmapSelect').value;
             const p = { A: {title: "Strategia Ontologica", desc: "Confronto tra Genesi in Simondon e Virtuale in Deleuze."}, B: {title: "Strategia Ecologica", desc: "Technics and Time."}, C: {title: "Strategia Politica", desc: "Il Transindividuale."} }[sel];
             document.getElementById('roadmap-title').innerText = p.title;
             document.getElementById('roadmap-desc').innerText = p.desc;
             document.getElementById('chapters-container').innerHTML = `
             <div class="pro-card p-4 text-center cursor-pointer hover:border-stone-400 transition-colors group" onclick="askAI('Genera struttura capitoli per: ${p.title}')">
                <span class="text-2xl block mb-2 group-hover:scale-110 transition-transform">‚ú®</span>
                <span class="text-sm font-medium text-stone-600">Genera struttura con AI</span>
             </div>`;
        }
        function selectAllCitations() { document.querySelectorAll('.cite-cb').forEach(cb => cb.checked = true); generateBibliography(); }
        function renderCitationsList() { 
             const list = document.getElementById('citation-list');
             list.innerHTML = '';
             biblioData.forEach(item => {
                 list.innerHTML += `<label class="flex items-center gap-3 p-2 hover:bg-stone-50 rounded-lg cursor-pointer"><input type="checkbox" class="accent-stone-900 cite-cb" value="${item.id}" onchange="generateBibliography()"><span class="text-xs text-stone-600 truncate">${item.title}</span></label>`;
             });
        }
        function copyCitationOutput() { const txt = document.getElementById('citation-output'); txt.select(); navigator.clipboard.writeText(txt.value); alert("Copiato."); }
        function generateBibliography() {
             const checked = Array.from(document.querySelectorAll('.cite-cb:checked')).map(c => c.value);
             const items = biblioData.filter(i => checked.includes(i.id));
             let out = "";
             const style = document.getElementById('citation-style').value;
             items.forEach(i => { out += style==='bibtex' ? `@book{${i.id}, title={${i.title}}...}\n` : `${i.author} (${i.year}). ${i.title}.\n\n`; });
             document.getElementById('citation-output').value = out;
        }
    </script>
</body>
</html>
