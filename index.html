<!DOCTYPE html>
<html lang="it" class="antialiased">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Millino Fagiolino | Research OS v4.4 (Stable)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,500;0,600;1,500&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="js/database.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 50: '#FBFBFB', 100: '#F5F5F4', 200: '#E7E5E4', 300: '#D6D3D1', 800: '#292524', 900: '#1C1917' },
                        rose: { 50: '#FFF1F2', 100: '#FFE4E6', 400: '#FB7185', 500: '#F43F5E', 600: '#E11D48', 900: '#881337' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'soft': '0 2px 10px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #FBFBFB;
            color: #1C1917;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #E7E5E4;
            border-radius: 99px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-item {
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .nav-active {
            background-color: white;
            color: #1C1917;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            border: 1px solid #E7E5E4;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(231, 229, 228, 0.8);
        }

        .pro-card {
            background: white;
            border: 1px solid #E7E5E4;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .pro-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            border-color: #D6D3D1;
            transform: translateY(-1px);
        }

        #zen-mode {
            transition: opacity 0.5s ease;
        }

        .hidden-zen {
            display: none !important;
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary~* {
            animation: sweep .3s ease-in-out;
        }

        @keyframes sweep {
            0% {
                opacity: 0;
                transform: translateY(-10px)
            }

            100% {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 99px;
            letter-spacing: 0.02em;
            border: 1px solid transparent;
        }

        .badge-todo {
            background: #F5F5F4;
            color: #78716C;
            border-color: #E7E5E4;
        }

        .badge-reading {
            background: #FFF1F2;
            color: #E11D48;
            border-color: #FECDD3;
        }

        .badge-done {
            background: #F0FDF4;
            color: #15803D;
            border-color: #BBF7D0;
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat Widget & Messages */
        .chat-widget {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        }

        .chat-open {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .chat-closed {
            transform: translateY(20px) scale(0.96);
            opacity: 0;
            pointer-events: none;
        }

        .msg-jesse {
            background-color: #F5F5F4;
            color: #1C1917;
            border-radius: 12px;
            border-bottom-left-radius: 2px;
        }

        .msg-user {
            background-color: #1C1917;
            color: white;
            border-radius: 12px;
            border-bottom-right-radius: 2px;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
            font-size: 0.95rem;
        }
    </style>
</head>

<body class="flex h-full w-full overflow-hidden">

    <div id="zen-mode"
        class="fixed inset-0 bg-white z-[100] hidden flex flex-col items-center justify-center p-8 overflow-hidden">
        <div class="absolute top-6 right-6">
            <button onclick="toggleZenMode()"
                class="text-stone-400 hover:text-stone-900 transition-colors text-xs font-bold tracking-widest uppercase">ESCI
                ZEN</button>
        </div>
        <div class="w-full max-w-3xl h-full flex flex-col">
            <textarea
                class="flex-1 w-full h-full text-xl leading-loose text-stone-800 placeholder-stone-300 outline-none resize-none font-serif bg-transparent"
                placeholder="Respira. Scrivi. Nessuna distrazione."></textarea>
        </div>
        <div class="absolute bottom-6 flex gap-4 text-stone-300 items-center">
            <span class="text-xs font-bold tracking-widest uppercase">Focus Mode</span>
            <span id="zen-timer" class="font-mono text-sm text-stone-400">25:00</span>
        </div>
    </div>

    <aside id="app-sidebar"
        class="w-[280px] bg-[#FBFBFB] border-r border-stone-200 flex-shrink-0 flex flex-col z-30 hidden md:flex h-full">
        <div class="p-6 pt-8 pb-2">
            <h1 class="text-2xl font-semibold text-stone-900 tracking-tight serif flex items-baseline gap-1">
                Millino<span class="text-rose-500 italic font-serif">.F</span>
            </h1>
            <p class="text-[11px] text-stone-400 font-medium mt-1 tracking-wide">RESEARCH OS v4.4</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-4 space-y-8">
            <div>
                <div class="px-3 mb-2 text-[10px] font-bold text-stone-400 uppercase tracking-widest">Esplorazione</div>
                <div class="space-y-1">
                    <button onclick="router('dashboard')" id="nav-dashboard"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìä</span> Panoramica</button>
                    <button onclick="router('database')" id="nav-database"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìö</span> Biblioteca</button>
                    <button onclick="router('concepts')" id="nav-concepts"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üß∂</span> Tessitore</button>
                    <button onclick="router('journal')" id="nav-journal"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìî</span> Diario</button>
                </div>
            </div>

            <div>
                <div class="px-3 mb-2 text-[10px] font-bold text-stone-400 uppercase tracking-widest">Produzione</div>
                <div class="space-y-1">
                    <button onclick="router('roadmap')" id="nav-roadmap"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üó∫Ô∏è</span> Roadmap</button>
                    <button onclick="router('tracker')" id="nav-tracker"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìà</span> Tracker</button>
                    <button onclick="router('citations')" id="nav-citations"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">‚ùû</span> Citazioni</button>
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-stone-100 bg-white">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Deep Work</span>
                <span id="timer-display" class="font-mono text-sm font-semibold text-rose-600">25:00</span>
            </div>
            <div class="flex justify-between items-center mb-4 px-2">
                <button onclick="toggleSound('rain')" id="btn-rain"
                    class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Pioggia">üåßÔ∏è</button>
                <button onclick="toggleSound('cafe')" id="btn-cafe"
                    class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Caff√®">‚òï</button>
                <button onclick="toggleSound('fire')" id="btn-fire"
                    class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Camino">üî•</button>
                <button onclick="stopAllSounds()"
                    class="text-rose-400 hover:text-rose-600 transition-colors text-[10px] font-bold border border-rose-200 px-2 py-1 rounded ml-1 bg-rose-50">STOP</button>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTimer()" id="timer-btn"
                    class="flex-1 bg-stone-900 hover:bg-black text-white text-xs py-2 rounded-md font-medium transition-all shadow-sm">Focus</button>
                <button onclick="toggleZenMode()"
                    class="px-3 bg-stone-100 hover:bg-stone-200 text-stone-500 text-lg py-1 rounded-md transition-colors"
                    title="Zen Mode">üëÅÔ∏è</button>
            </div>
            <div class="mt-4 pt-2 border-t border-stone-100 text-center">
                <button onclick="forceReset()"
                    class="text-[9px] text-stone-300 hover:text-red-500 underline cursor-pointer">Fix Database</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative bg-white" id="main-wrapper">
        <div
            class="md:hidden bg-white/80 backdrop-blur-md border-b border-stone-200 p-4 flex justify-between items-center z-30 sticky top-0">
            <span class="font-semibold serif text-lg text-stone-900">Millino.F</span>
            <button
                onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');"
                class="text-stone-600">‚ò∞</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 md:p-12 relative scroll-smooth pb-40" id="content-area">

            <div id="view-dashboard" class="space-y-10 fade-in max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-stone-100 pb-8">
                    <div>
                        <h2 class="text-3xl md:text-4xl text-stone-900 mb-2 serif font-medium tracking-tight">Panoramica
                            Corsi</h2>
                        <p class="text-stone-500 text-sm">Monitoraggio accademico attivo.</p>
                    </div>
                    <button onclick="askAI('Fammi un briefing sui miei corsi attivi e cosa devo studiare oggi')"
                        class="group bg-white border border-stone-200 hover:border-rose-200 hover:shadow-soft text-stone-600 px-5 py-2.5 rounded-full transition-all text-sm font-medium flex items-center gap-2">
                        <img src="jesse/psicologo.jpeg"
                            class="w-6 h-6 rounded-full object-cover border border-stone-200 group-hover:scale-110 transition-transform shadow-sm"
                            alt="Jesse">
                        Briefing Mattutino
                    </button>
                </div>

                <div id="course-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Course Cards will be injected here -->
                </div>

                <!-- NEW: Smart Scheduler -->
                <div class="bg-white border border-stone-200 p-6 rounded-xl mb-8 shadow-soft">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-stone-900 text-lg serif">üìÖ Pianificatore Settimanale</h3>
                        <span
                            class="text-xs bg-rose-50 text-rose-600 px-2 py-1 rounded font-bold uppercase tracking-wider">AI
                            Powered</span>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="schedule-input"
                            class="flex-1 bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300"
                            placeholder="Es: Studio Lun-Mer-Ven, lavoro Marted√¨...">
                        <button onclick="calculateStudySchedule()"
                            class="bg-stone-900 text-white px-6 py-3 rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-black transition-colors">Genera
                            Programma</button>
                    </div>
                    <div id="schedule-output" class="hidden animate-pulse">
                        <div class="space-y-3">
                            <div class="bg-stone-100 h-10 rounded w-3/4"></div>
                            <div class="bg-stone-100 h-24 rounded w-full"></div>
                        </div>
                    </div>
                    <div id="schedule-result" class="hidden mt-6 pt-6 border-t border-stone-100"></div>
                </div>

                <div class="pro-card p-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="font-bold text-stone-400 text-[10px] uppercase tracking-widest mb-1">Stato
                                Ricerca</h3>
                            <div class="text-3xl font-serif font-medium text-stone-900"><span
                                    id="reading-progress-text">0%</span> <span
                                    class="text-lg text-stone-400 italic">completato</span></div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-serif text-stone-900" id="total-sources-count">0</div>
                            <div class="text-[10px] text-stone-400 uppercase font-bold tracking-wider">Fonti Totali
                            </div>
                        </div>
                    </div>
                    <div class="w-full bg-stone-100 rounded-full h-2 overflow-hidden mb-8">
                        <div id="reading-progress-bar"
                            class="bg-stone-800 h-2 rounded-full transition-all duration-1000 ease-out"
                            style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-8 text-center border-t border-stone-100 pt-6">
                        <div>
                            <div class="text-2xl font-semibold text-stone-900 serif" id="count-todo">0</div>
                            <div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider mt-1">Da Leggere
                            </div>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-rose-500 serif" id="count-reading">0</div>
                            <div class="text-[10px] uppercase font-bold text-rose-300 tracking-wider mt-1">In Corso
                            </div>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-stone-900 serif" id="count-done">0</div>
                            <div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider mt-1">Archiviati
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-database" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <div class="glass-card sticky top-2 z-20 p-2 rounded-xl flex gap-2 items-center shadow-soft mb-8">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-2.5 text-stone-400 text-sm">üîç</span>
                        <input type="text" id="searchInput" placeholder="Cerca o aggiungi..."
                            class="w-full pl-9 pr-4 py-2 bg-transparent border-none focus:ring-0 text-sm text-stone-800 placeholder-stone-400 h-9"
                            oninput="runSearch()">
                    </div>
                    <div class="w-px h-6 bg-stone-200"></div>
                    <select id="catFilter" onchange="runSearch()"
                        class="bg-transparent border-none text-xs font-medium text-stone-600 outline-none cursor-pointer hover:text-stone-900 pr-2">
                        <option value="all">Tutte</option>
                        <option value="User Added">Le Mie Fonti</option>
                        <option value="Primary Sources">Primarie</option>
                        <option value="Comparative Studies">Studi Comparativi</option>
                        <option value="Philosophy of Technology">Tecnica</option>
                        <option value="Ecological Philosophy">Ecologia</option>
                        <option value="Background">Background</option>
                    </select>
                    <button onclick="addNewSourcePrompt()"
                        class="ml-2 bg-stone-900 text-white w-8 h-8 rounded-lg flex items-center justify-center hover:bg-black transition-colors text-lg font-bold"
                        title="Aggiungi Libro">+</button>
                </div>
                <div class="grid grid-cols-1 gap-3" id="results-container"></div>
            </div>

            <div id="view-concepts" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="border-b border-stone-100 pb-6 mb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Il Tessitore</h2>
                    <p class="text-stone-500 text-sm mt-2">Collega i punti. Clicca su un tag per vedere le connessioni.
                    </p>
                </div>
                <div class="bg-stone-50 border border-stone-200 p-6 rounded-xl mb-8">
                    <h3 class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-4">Mappa Concettuale
                    </h3>
                    <div id="concept-cloud" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="concept-results" class="grid grid-cols-1 gap-3"></div>
            </div>

            <div id="view-journal" class="hidden space-y-8 fade-in pb-20 max-w-3xl mx-auto">
                <div class="border-b border-stone-100 pb-6 mb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Diario di Bordo</h2>
                    <p class="text-stone-500 text-sm mt-2">Usa <span
                            class="text-rose-500 bg-rose-50 px-1 rounded">@Autore</span> per collegare le note.</p>
                </div>
                <div class="pro-card p-1">
                    <textarea id="journal-entry"
                        class="w-full h-32 p-4 bg-white rounded-t-xl border-none outline-none resize-none text-sm text-stone-700 placeholder-stone-300"
                        placeholder="Caro Jesse, oggi ho capito che..."></textarea>
                    <div class="bg-stone-50 p-2 rounded-b-xl flex justify-end border-t border-stone-100">
                        <button onclick="addJournalEntry()"
                            class="bg-stone-900 text-white px-4 py-1.5 rounded-md text-xs font-medium hover:bg-black transition-colors">Salva
                            Nota</button>
                    </div>
                </div>
                <div id="journal-container"
                    class="space-y-6 relative before:absolute before:left-4 before:top-0 before:h-full before:w-px before:bg-stone-200 pl-10">
                </div>
            </div>

            <div id="view-tracker" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="border-b border-stone-100 pb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Word Tracker</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="pro-card p-6 rounded-xl col-span-1 h-fit">
                        <h4 class="font-bold text-stone-900 text-sm mb-4">Aggiornamento Quotidiano</h4>
                        <input type="number" id="word-input"
                            class="w-full p-2.5 bg-stone-50 border border-stone-200 rounded-lg mb-4 text-sm outline-none focus:border-rose-300 transition-colors"
                            placeholder="Totale parole oggi...">
                        <button onclick="updateWordCount()"
                            class="w-full bg-stone-900 text-white py-2.5 rounded-lg text-sm font-medium hover:bg-black transition-colors">Registra</button>
                    </div>
                    <div class="pro-card p-6 rounded-xl col-span-2"><canvas id="wordChart"></canvas></div>
                </div>
            </div>

            <div id="view-roadmap" class="hidden space-y-8 fade-in pb-40 min-h-full max-w-5xl mx-auto">
                <div class="flex justify-between items-end border-b border-stone-100 pb-6">
                    <div>
                        <h2 class="text-3xl font-medium text-stone-900 serif">Roadmap Tesi</h2>
                        <p class="text-stone-500 text-sm mt-1">Seleziona la strategia per la tua Tesi di Laurea.</p>
                    </div>
                </div>
                <div class="mb-8">
                    <div class="relative"><select id="roadmapSelect" onchange="renderRoadmap()"
                            class="w-full md:w-1/2 bg-white border border-stone-200 text-stone-900 font-medium text-sm px-4 py-3 rounded-lg outline-none cursor-pointer hover:border-stone-300 focus:ring-2 focus:ring-stone-100 appearance-none shadow-sm">
                            <option value="A">Strategia A: Ontologica</option>
                            <option value="B">Strategia B: Tecno-Ecologica</option>
                            <option value="C">Strategia C: Politica</option>
                            <option value="custom">Strategia D: Personalizzata (Jesse AI)</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-500 md:right-1/2 mr-4">
                            ‚ñº</div>
                    </div>
                </div>
                <div class="bg-stone-50 border border-stone-200 p-6 rounded-xl mb-8 flex flex-col gap-4">
                    <div class="flex gap-4 items-start"><span class="text-2xl">üí°</span>
                        <div class="flex-1">
                            <h3 class="text-stone-900 font-bold text-sm uppercase tracking-wide mb-1"
                                id="roadmap-title"></h3>
                            <p class="text-stone-600 text-sm leading-relaxed" id="roadmap-desc"></p>
                        </div>
                    </div>

                    <div id="roadmap-biblio" class="mt-4 pt-4 border-t border-stone-200 hidden">
                        <span class="text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-2 block">Biblio
                            Essenziale per questo percorso:</span>
                        <div id="roadmap-biblio-list" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div id="custom-controls" class="hidden border-t border-stone-200 pt-4 flex gap-2 justify-end">
                        <button onclick="generateCustomStrategy()"
                            class="bg-rose-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-rose-600 transition-colors shadow-soft flex items-center gap-2">‚ú®
                            Chiedi a Jesse</button>
                        <button onclick="toggleEditMode()"
                            class="bg-white border border-stone-300 text-stone-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors">‚úèÔ∏è
                            Modifica</button>
                    </div>
                </div>
                <div class="space-y-6" id="chapters-container"></div>
            </div>

            <!-- NEW VIEW: COURSE DETAIL -->
            <div id="view-course-detail" class="hidden space-y-8 fade-in pb-40 min-h-full max-w-5xl mx-auto">
                <div class="flex justify-between items-end border-b border-stone-100 pb-6">
                    <div>
                        <button onclick="router('dashboard')"
                            class="text-xs text-stone-400 font-bold uppercase tracking-wider mb-1 hover:text-stone-900">‚Üê
                            Torna alla Dashboard</button>
                        <h2 class="text-3xl font-medium text-stone-900 serif" id="course-title">Dettaglio Corso</h2>
                        <p class="text-stone-500 text-sm mt-1" id="course-prof"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-mono text-rose-500 font-bold" id="course-date"></div>
                        <span class="text-[10px] text-stone-400 uppercase font-bold">Data Esame</span>
                    </div>
                </div>

                <div id="course-syllabus-container" class="space-y-6"></div>
            </div>

            <!-- NEW VIEW: SETTINGS MODAL -->
            <div id="settings-modal"
                class="hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-stone-100">
                    <h3 class="text-2xl font-bold text-stone-900 serif mb-2">Impostazioni AI</h3>
                    <p class="text-sm text-stone-500 mb-6">Configura le chiavi per l'Auto-Repair avanzato.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-2">OpenAI
                                API Key (Personale)</label>
                            <input type="password" id="openai-key-input"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300"
                                placeholder="sk-..." onchange="saveOpenerKey()">
                            <p class="text-[10px] text-stone-400 mt-2">
                                üîí Salvata solo nel tuo browser (LocalStorage). Non viene mai inviata al server di
                                Millino.
                                Serve per usare <strong>GPT-4o-mini</strong> come riparatore di JSON.
                            </p>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="closeSettingsModal()"
                            class="bg-stone-900 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-black transition-colors">Chiudi</button>
                    </div>
                </div>
            </div>

            <div id="view-citations" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <!-- ... unchanged ... -->
                <div class="flex justify-between items-center border-b border-stone-100 pb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Citation Manager</h2>
                    <button onclick="downloadBibliography()"
                        class="text-stone-600 text-xs font-bold border border-stone-200 px-3 py-1.5 rounded hover:bg-stone-50 transition-colors">üì•
                        Export .txt</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
                    <div class="lg:col-span-1 pro-card flex flex-col overflow-hidden">
                        <div class="p-3 bg-stone-50 border-b border-stone-100 flex justify-between items-center"><span
                                class="font-semibold text-stone-500 text-[10px] uppercase tracking-wider">Fonti</span><button
                                onclick="selectAllCitations()"
                                class="text-rose-500 text-[10px] font-bold hover:underline">Seleziona Tutti</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="citation-list"></div>
                    </div>
                    <div class="lg:col-span-2 pro-card flex flex-col">
                        <div class="p-3 bg-stone-50 border-b border-stone-100 flex gap-4 items-center justify-between">
                            <select id="citation-style" onchange="generateBibliography()"
                                class="bg-white border border-stone-200 rounded px-2 py-1 text-xs outline-none text-stone-600">
                                <option value="classic">üáÆüáπ Classica (Note)</option>
                                <option value="apa">APA 7</option>
                                <option value="chicago">Chicago</option>
                                <option value="bibtex">BibTeX</option>
                            </select>
                            <div class="flex gap-2">
                                <button onclick="copyFootnoteStyle()"
                                    class="text-xs font-bold text-rose-600 border border-rose-100 bg-rose-50 px-2 py-1 rounded hover:bg-rose-100">Copia
                                    Nota</button>
                                <button onclick="copyCitationOutput()"
                                    class="text-xs font-bold text-stone-600 hover:text-stone-900">Copia Biblio</button>
                            </div>
                        </div>
                        <textarea id="citation-output"
                            class="flex-1 p-6 font-mono text-xs text-stone-600 outline-none resize-none bg-white"
                            readonly placeholder="Output bibliografico..."></textarea>
                    </div>
                </div>
            </div>
            <!-- MODALS -->
            <!-- NEW: Course Editor Modal -->
            <div id="course-modal"
                class="fixed inset-0 bg-stone-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center fade-in">
                <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden m-4">
                    <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                        <h3 id="modal-course-title" class="font-serif text-2xl font-bold text-stone-900">Nuovo Corso
                        </h3>
                        <button onclick="closeCourseModal()" class="text-stone-400 hover:text-stone-900">‚úï</button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Nome
                                Corso</label>
                            <input type="text" id="edit-course-name"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-900 outline-none font-bold text-stone-800"
                                placeholder="Es. Filosofia Teoretica">
                        </div>
                        <div>
                            <label
                                class="text-[10px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Professore</label>
                            <input type="text" id="edit-course-prof"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-900 outline-none"
                                placeholder="Es. Prof. Simondon">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Data
                                Esame</label>
                            <input type="date" id="edit-course-date"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-900 outline-none">
                        </div>
                    </div>
                    <div class="p-4 border-t border-stone-100 bg-stone-50 flex justify-end gap-3">
                        <button onclick="closeCourseModal()"
                            class="px-4 py-2 text-stone-500 font-bold text-xs uppercase hover:bg-stone-200 rounded-lg">Annulla</button>
                        <button onclick="saveCourse()"
                            class="px-6 py-2 bg-stone-900 text-white font-bold text-xs uppercase rounded-lg shadow-lg hover:bg-black hover:scale-105 transition-all">Salva
                            Corso</button>
                    </div>
                </div>
            </div>

            <div id="book-modal"
                class="fixed inset-0 bg-stone-900/20 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
                <div
                    class="bg-white w-full max-w-2xl rounded-2xl shadow-float p-8 transform transition-all scale-100 border border-stone-100">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h3 id="modal-title" class="text-2xl font-serif font-medium text-stone-900 mb-1"></h3>
                            <p id="modal-author" class="text-rose-500 text-sm font-medium"></p>
                        </div>
                        <button onclick="closeModal()"
                            class="text-stone-300 hover:text-stone-600 text-2xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-6">
                        <div><label
                                class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Tag</label><input
                                type="text" id="modal-tags"
                                class="w-full p-3 bg-stone-50 rounded-lg border border-stone-200 text-sm outline-none focus:border-stone-400 transition-colors"
                                placeholder="#angoscia, #capitolo1..."></div>
                        <div><label
                                class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Note
                                personali</label><textarea id="modal-notes"
                                class="w-full h-40 p-3 bg-stone-50 rounded-lg border border-stone-200 text-sm resize-none outline-none focus:border-stone-400 transition-colors leading-relaxed"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-stone-100">
                        <button onclick="askAIAboutBook()"
                            class="px-4 py-2 bg-white border border-stone-200 text-stone-600 font-medium rounded-lg text-xs hover:border-rose-200 hover:text-rose-600 transition-all">Chiedi
                            a Jesse</button>
                        <button onclick="saveBookDetails()"
                            class="px-6 py-2 bg-stone-900 text-white font-medium rounded-lg text-xs hover:bg-black transition-colors shadow-soft">Salva
                            Modifiche</button>
                    </div>
                </div>
            </div>

            <div id="custom-modal"
                class="fixed inset-0 bg-stone-900/20 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-lg rounded-2xl shadow-float p-8 border border-stone-100">
                    <h3 class="text-xl font-serif font-bold mb-4">Genera Strategia con AI</h3>
                    <p class="text-sm text-stone-600 mb-4">Descrivi brevemente a Jesse di cosa vuoi che parli la tua
                        tesi.
                    </p>
                    <textarea id="custom-prompt-input"
                        class="w-full h-32 p-3 bg-stone-50 border border-stone-200 rounded-xl text-sm mb-4 outline-none focus:border-rose-300"
                        placeholder="Es: Voglio esplorare il concetto di alienazione in Marx e Simondon..."></textarea>
                    <div class="flex justify-end gap-2">
                        <button onclick="document.getElementById('custom-modal').classList.add('hidden')"
                            class="px-4 py-2 text-stone-500 text-xs font-bold hover:bg-stone-50 rounded-lg">Annulla</button>
                        <button onclick="runCustomAiGeneration()"
                            class="px-4 py-2 bg-rose-500 text-white text-xs font-bold rounded-lg hover:bg-rose-600">Genera</button>
                    </div>
                </div>
            </div>

            <!-- NEW VIEW: SETTINGS MODAL -->
            <div id="settings-modal"
                class="hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-stone-100">
                    <h3 class="text-2xl font-bold text-stone-900 serif mb-2">Impostazioni AI</h3>
                    <p class="text-sm text-stone-500 mb-6">Configura le chiavi per l'Auto-Repair avanzato.</p>
                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">OpenAI
                                API Key (Personale)</label>
                            <input type="password" id="openai-key-input"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300"
                                placeholder="sk-..." onchange="saveOpenerKey()">
                            <p class="text-[10px] text-stone-400 mt-2">
                                üîí Salvata solo nel tuo browser (LocalStorage).
                                <br>Se non la inserisci, il sistema prover√† a usare la chiave di sistema (Vercel).
                            </p>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button onclick="closeSettingsModal()"
                            class="bg-stone-900 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors">Chiudi</button>
                    </div>
                </div>
            </div>

            <div id="chat-widget"
                class="fixed bottom-6 right-6 w-[380px] h-[600px] bg-white rounded-2xl shadow-float border border-stone-200 flex flex-col z-50 chat-closed overflow-hidden origin-bottom-right transition-all duration-300">
                <div class="bg-stone-900 p-4 flex justify-between items-center shrink-0 w-full text-white">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-white overflow-hidden border-2 border-rose-500 relative shrink-0">
                            <img id="jesse-avatar" src="" alt="Jesse" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col">
                            <h4 class="font-bold text-sm leading-tight">Jesse the Assistant</h4>
                            <div class="text-[10px] text-stone-400">Research Doggo üê∂</div>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="document.getElementById('chat-messages').innerHTML=''"
                            class="text-stone-400 hover:text-white p-2 rounded hover:bg-stone-800 transition-colors"
                            title="Pulisci Chat">üóëÔ∏è</button>
                        <button onclick="toggleChat()"
                            class="text-stone-400 hover:text-white p-2 rounded hover:bg-stone-800 transition-colors text-lg font-bold leading-none"
                            title="Chiudi">√ó</button>
                    </div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-6 bg-[#FAFAFA]">
                    <div class="flex gap-3 fade-in mt-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden border border-stone-200 shrink-0"><img
                                src="jesse/psicologo.jpeg" class="w-full h-full object-cover jesse-mini-avatar"></div>
                        <div class="p-3 rounded-2xl text-sm max-w-[85%] msg-jesse">Bau! Ciao padrona, io sono Jesse. Sto
                            analizzando la tua richiesta... Se ti √® stato utile padrona, dammi del cibo, ho fame!!</div>
                    </div>
                </div>
                <div class="px-4 py-3 bg-stone-50 border-t border-stone-100 flex gap-2 overflow-x-auto scrollbar-hide">
                    <button onclick="setMode('Socrajess')"
                        class="whitespace-nowrap text-stone-600 hover:text-rose-600 text-[10px] font-bold border border-stone-200 bg-white px-3 py-1.5 rounded-full shadow-sm transition-colors hover:border-rose-300">Socrajess</button>
                    <button onclick="setMode('critic')"
                        class="whitespace-nowrap text-stone-600 hover:text-rose-600 text-[10px] font-bold border border-stone-200 bg-white px-3 py-1.5 rounded-full shadow-sm transition-colors hover:border-rose-300">Relatore</button>
                    <button onclick="setMode('discuss')"
                        class="whitespace-nowrap bg-stone-800 text-white hover:bg-stone-900 text-[10px] font-bold px-3 py-1.5 rounded-full shadow-sm transition-colors">üéì
                        Discussione</button>
                </div>
                <div class="p-3 bg-white border-t border-stone-100 shrink-0 relative">
                    <input type="text" id="chat-input" placeholder="Chiedi a Jesse..."
                        class="w-full pl-4 pr-12 py-3 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-stone-400 focus:bg-white outline-none transition-all placeholder-stone-400 text-stone-800"
                        onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()"
                        class="absolute right-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-stone-900 text-white flex items-center justify-center hover:bg-black transition-colors shadow-sm text-sm">‚û§</button>
                </div>
            </div>

            <button onclick="toggleChat()"
                class="fixed bottom-6 right-6 w-14 h-14 bg-stone-900 text-white rounded-full shadow-float flex items-center justify-center hover:scale-105 transition-transform z-40 group overflow-hidden border-2 border-white">
                <img src="" class="w-full h-full object-cover jesse-mini-avatar" alt="Chat">
            </button>

    </main>

    <audio id="audio-rain" loop src="https://assets.mixkit.co/active_storage/sfx/2499/2499-preview.mp3"></audio>
    <audio id="audio-cafe" loop src="https://assets.mixkit.co/active_storage/sfx/248/248-preview.mp3"></audio>
    <audio id="audio-fire" loop src="https://assets.mixkit.co/active_storage/sfx/1239/1239-preview.mp3"></audio>

    <script>
        // --- CONFIGURAZIONE JESSE ---
        const JESSE_IMG = "jesse/psicologo.jpeg";

        // --- ALBUM FOTO JESSE (67 FOTO) ---
        const JESSE_GALLERY = [
            "jesse/WhatsApp Image 2026-01-27 at 15.31.41.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.45.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.51 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.51.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.52 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.52 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.52.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.54 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.54.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.55.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.56 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.56 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.56.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.57 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.57.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.58.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.59 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.59 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.59.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.00 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.00.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.01.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.04 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.04.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.06 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.06 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.06.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.07 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.07.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.09.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.10 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.10.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.13 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.13 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.13.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.15 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.15 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.15.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.16 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.16.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.18 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.18 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.18.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.19 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.19 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.19.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.20 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.20 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.20.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.21 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.21.jpeg"
        ];

        // --- STATE MANAGEMENT ---
        let biblioData = [];
        let currentBookId = null;
        let wordHistory = JSON.parse(localStorage.getItem('word_history')) || [];
        let journalEntries = JSON.parse(localStorage.getItem('journal_entries')) || [];
        let aiMode = 'chat';
        let currentCourseId = null;
        let chartInstance = null;
        let customStrategy = { title: "Strategia Personalizzata", desc: "Generata da Jesse AI.", top_sources: [], chapters: [] };

        // NEW: Dynamic Course Management
        let courses = JSON.parse(localStorage.getItem('millino_courses')) || DEFAULT_COURSES;
        let editingCourseId = null;

        // NEW: Advanced Source Management State
        let pinnedSources = JSON.parse(localStorage.getItem('millino_pinned')) || [];
        let deletedSources = JSON.parse(localStorage.getItem('millino_deleted')) || [];
        let aiSelectedSources = []; // Temporary, per session

        // --- MASTER DB (85 Fonti) ---

        // --- ROADMAP DENSA (Con Obiettivi e Metodo) ---
        // --- ROADMAP DENSA (Con Obiettivi e Metodo) ---
        let detailedRoadmaps = {
            A: {
                title: "Strategia A: Ontologica (Simondon/Deleuze)",
                desc: "Un'indagine sui fondamenti dell'essere: dal 'principio' al 'processo' di individuazione.",
                top_sources: ["S01", "D01", "S02", "D13", "S11"],
                chapters: [
                    {
                        title: "1. La Crisi dell'Ilemorfismo",
                        goal: "Decostruire lo schema forma-materia come insufficiente per spiegare l'individuazione.",
                        objectives: [
                            "Analizzare la critica di Simondon allo schema ilemorfico.",
                            "Introdurre il concetto di 'metastabilit√†' come condizione pre-individuale.",
                            "Definire la differenza tra principio di individuazione e processo di individuazione."
                        ],
                        analysis: "Il capitolo si apre con la presa d'atto che la tradizione filosofica ha sempre cercato il principio (l'arch√©) dell'individuo, mancando l'individuazione come genesi. Lo schema ilemorfico presuppone l'individuo gi√† dato. Simondon propone invece di partire dal 'sistema sovrasaturo' o preindividuale.",
                        methodology: "Lettura incrociata dell'Introduzione di (S01) e del Capitolo 1 di (S02). Uso del metodo genetico.",
                        key_sources: ["S01", "S11"],
                        concepts: "Ilemorfismo, Metastabilit√†, Preindividuale"
                    },
                    {
                        title: "2. Il Tempo come Genesi",
                        goal: "Dimostrare che il tempo non √® un contenitore ma il risultato dell'individuazione.",
                        objectives: [
                            "Esaminare la 'Cronogenesi' in Simondon.",
                            "Confrontare con la sintesi passiva del tempo in Deleuze (D13).",
                            "Definire l'Aion come tempo dell'evento."
                        ],
                        analysis: "Se l'individuo non √® dato, ma diviene, il tempo √® la dimensione stessa di questo divenire. Non c'√® prima la materia e poi la forma nel tempo; il tempo scaturisce dalla risoluzione delle tensioni preindividuali.",
                        methodology: "Confronto tra ontologia fisica e ontologia biologica.",
                        key_sources: ["S01", "D13", "D07"],
                        concepts: "Cronogenesi, Aion, Sintesi Passiva"
                    },
                    {
                        title: "3. Etica del Divenire",
                        goal: "Sviluppare un'etica basata non su norme trascendenti ma sulla capacit√† di 'portare' il preindividuale.",
                        objectives: [
                            "Leggere l'angoscia in Simondon come segnale del preindividuale non risolto.",
                            "Collegare all'Amor Fati deleuziano.",
                            "Proporre un'etica della 'relazione transindividuale'."
                        ],
                        analysis: "L'etica non riguarda il giudizio su azioni compiute da un soggetto stabile, ma la gestione del potenziale di trasformazione. Il soggetto non √® un punto fisso, ma un tragitto. L'angoscia √® la percezione del 'troppo grande' in noi (il preindividuale).",
                        methodology: "Approccio etico-estetico.",
                        key_sources: ["D02", "S03", "D08"],
                        concepts: "Angoscia, Amor Fati, Transindividuale"
                    }
                ]
            },
            B: {
                title: "Strategia B: Tecno-Ecologica (Stiegler/Hui)",
                desc: "L'oggetto tecnico come milieu associato. La crisi ecologica come crisi della razionalit√† tecnica.",
                top_sources: ["S02", "T01", "E01", "T03", "T04"],
                chapters: [
                    {
                        title: "1. L'Oggetto Tecnico",
                        goal: "Ridefinire la tecnica non come strumento ma come modo di esistenza.",
                        objectives: ["Analizzare la genesi dell'oggetto tecnico (S02).", "Discutere la 'concretizzazione'."],
                        analysis: "La macchina non √® un utensile inerte. Ha una sua evoluzione (genesi) che tende verso la concretizzazione (funzionamento organico).",
                        methodology: "Analisi organologica.",
                        key_sources: ["S02", "T10"],
                        concepts: "Concretizzazione, Oggetto Tecnico"
                    },
                    {
                        title: "2. Cosmotecniche",
                        goal: "Superare l'universalismo tecnologico occidentale.",
                        objectives: ["Introdurre il concetto di Cosmotecnica (Hui).", "Confrontare tecniche e cosmologie."],
                        analysis: "Non esiste 'La Tecnica' al singolare, ma diverse cosmotecniche che uniscono ordine morale e cosmico. La modernit√† ha separato queste sfere.",
                        methodology: "Antropologia filosofica.",
                        key_sources: ["T03", "T04"],
                        concepts: "Cosmotecnica, Diversit√†"
                    },
                    {
                        title: "3. Terapia dell'Antropocene",
                        goal: "Proporre pratiche di cura farmacologica.",
                        objectives: ["Leggere il Pharmakon (Stiegler).", "Progettare una 'economia del contributo'."],
                        analysis: "La tecnologia √® sia veleno che cura (Pharmakon). Nell'Antropocene, dobbiamo inventare nuove pratiche di cura (terapie) per evitare la distruzione.",
                        methodology: "Decostruzione e farmacologia.",
                        key_sources: ["T01", "E01"],
                        concepts: "Pharmakon, Negantropia, Cura"
                    }
                ]
            },
            C: {
                title: "Strategia C: Politica (Societ√† del Controllo)",
                desc: "Dal controllo disciplinare alla modulazione algoritmica. Strategie di resistenza.",
                top_sources: ["S03", "D09", "C01"],
                chapters: [
                    {
                        title: "1. Mappare il Controllo",
                        goal: "Tracciare il passaggio da Foucault a Deleuze.",
                        objectives: ["Definire la societ√† disciplinare.", "Analizzare il 'dividuale' e la banche dati."],
                        analysis: "Non siamo pi√π chiusi in fabbriche o scuole (luoghi di reclusione), ma modulati in spazi aperti attraverso debiti, password e dati. L'individuo diventa 'dividuale'.",
                        methodology: "Cartografia politica.",
                        key_sources: ["D09", "S05"],
                        concepts: "Dividuale, Modulazione, Controllo"
                    },
                    {
                        title: "2. Il Transindividuale",
                        goal: "Pensare una politica oltre l'individuo liberale.",
                        objectives: ["Rileggere Simondon in chiave politica.", "Definire il transindividuale come risorsa comune."],
                        analysis: "La politica liberale si basa sull'individuo atomizzato. Il transindividuale √® ci√≤ che lega gli individui attraverso il preindividuale condiviso. √à la base per una nuova politica del comune.",
                        methodology: "Ontologia sociale.",
                        key_sources: ["S03", "C01"],
                        concepts: "Transindividuale, Comune, Relazione"
                    }
                ]
            }
        };

        // --- INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Immagini
            const mainAvatar = document.getElementById('jesse-avatar');
            if (mainAvatar) mainAvatar.src = JESSE_IMG;
            document.querySelectorAll('.jesse-mini-avatar').forEach(img => img.src = JESSE_IMG);

            // Avvio App
            mergeData();
            initApp();
            initAudio();
        });

        // --- FUNZIONI CORE ---
        function mergeData() {
            const savedProgress = JSON.parse(localStorage.getItem('millino_progress')) || [];
            const savedCustomBooks = JSON.parse(localStorage.getItem('millino_custom_books')) || [];

            let mergedMaster = MASTER_DB.map(m => {
                const s = savedProgress.find(x => x.id === m.id);
                return s ? { ...m, ...s } : { ...m, status: 'todo', notes: '', tags: [] };
            });

            // Combina Custom + Master
            biblioData = [...savedCustomBooks, ...mergedMaster];

            // OLD Saved Data Compat if needed, but COURSES are static now.
            // Still loading progress
            const savedCustomStrategy = localStorage.getItem('custom_roadmap');
            if (savedCustomStrategy) customStrategy = JSON.parse(savedCustomStrategy);
        }

        function saveData() {
            const progress = biblioData.map(b => ({ id: b.id, status: b.status, notes: b.notes, tags: b.tags }));
            localStorage.setItem('millino_progress', JSON.stringify(progress));
            const customBooks = biblioData.filter(b => !MASTER_DB.some(m => m.id === b.id));
            localStorage.setItem('millino_custom_books', JSON.stringify(customBooks));

            // NEW: Persist Pin/Delete/Courses
            localStorage.setItem('millino_pinned', JSON.stringify(pinnedSources));
            localStorage.setItem('millino_deleted', JSON.stringify(deletedSources));
            localStorage.setItem('millino_courses', JSON.stringify(courses));
        }

        function forceReset() { if (confirm("Vuoi resettare tutto?")) { localStorage.removeItem('millino_progress'); localStorage.removeItem('millino_custom_books'); localStorage.removeItem('millino_pinned'); localStorage.removeItem('millino_deleted'); localStorage.removeItem('custom_roadmap'); localStorage.removeItem('millino_courses'); location.reload(); } }

        // --- DYNAMIC COURSE CRUD ---
        function openCourseModal(id = null) {
            editingCourseId = id;
            const modal = document.getElementById('course-modal');
            const titleEl = document.getElementById('modal-course-title');

            if (id) {
                // Edit Text
                const course = courses.find(c => c.id === id);
                titleEl.textContent = "Modifica Corso";
                document.getElementById('edit-course-name').value = course.name;
                document.getElementById('edit-course-prof').value = course.prof;
                document.getElementById('edit-course-date').value = course.date;
                // Topics area currently simple JSON or text
                // For simplicity, we let user edit topics as JSON or basic text?
                // Request says "modify everything". Let's assume standard fields first.
                // Advanced: We could add a topics editor, but let's start with basic metadata.
            } else {
                // New
                titleEl.textContent = "Nuovo Corso";
                document.getElementById('edit-course-name').value = "";
                document.getElementById('edit-course-prof').value = "";
                document.getElementById('edit-course-date').value = "";
            }
            modal.classList.remove('hidden');
        }

        function closeCourseModal() { document.getElementById('course-modal').classList.add('hidden'); }

        function saveCourse() {
            const name = document.getElementById('edit-course-name').value;
            const prof = document.getElementById('edit-course-prof').value;
            const date = document.getElementById('edit-course-date').value;

            if (!name || !prof || !date) return alert("Compila tutti i campi!");

            if (editingCourseId) {
                // Update
                const c = courses.find(x => x.id === editingCourseId);
                c.name = name; c.prof = prof; c.date = date;
            } else {
                // Create
                const newC = {
                    id: "c_" + Date.now(),
                    name: name,
                    prof: prof,
                    date: date,
                    status: 'active',
                    topics: [] // Empty topics for new course
                };
                courses.push(newC);
            }
            saveData();
            closeCourseModal();
            // Refresh
            if (currentCourseId) {
                renderCourseDetail(currentCourseId);
            } else {
                renderDashboard();
            }
            router(currentCourseId ? 'course-detail' : 'dashboard');
        }

        function deleteCourse(id) {
            if (!confirm("Eliminare definitivamente questo corso?")) return;
            courses = courses.filter(c => c.id !== id);
            saveData();
            currentCourseId = null;
            renderDashboard();
            router('dashboard');
        }

        function initApp() {
            renderDashboard();
            router('dashboard');
            runSearch();
            renderStats();
            renderJournal();
            renderTracker();
            renderRoadmap(); // Initial render might be empty if no course selected? Or default
            renderCitationsList();
            renderConcepts();
        }
        function router(v) {
            ['dashboard', 'database', 'journal', 'tracker', 'roadmap', 'citations', 'concepts', 'course-detail'].forEach(x => {
                const el = document.getElementById('view-' + x);
                const nav = document.getElementById('nav-' + x);
                if (el) el.classList.add('hidden');
                if (nav) nav.classList.remove('nav-active');
            });
            const el = document.getElementById('view-' + v);
            const nav = document.getElementById('nav-' + v);
            if (el) el.classList.remove('hidden');
            if (nav) nav.classList.add('nav-active');

            // Mobile Sidebar handling
            if (window.innerWidth < 768) document.querySelector('aside').classList.add('hidden');
        }

        // --- DATABASE LOGIC ---
        function runSearch() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;

            // Filter Logic: Search Text + Category + NOT Deleted + (Optional) Current Course Context
            let filtered = biblioData.filter(i => {
                // 1. Exclude Deleted
                if (deletedSources.includes(i.id)) return false;

                // 2. Filter by Course (if active and not "All")
                // Note: If we are in "Database" view, maybe we want to see everything unless filtered?
                // Let's stick to the plan: Context filters Database View.
                if (currentCourseId) {
                    const course = COURSES.find(c => c.id === currentCourseId);
                    // If course exists, show only matching Subject OR items added by user (often no subject)
                    // Or keep it simpler: Matches Subject.
                    if (course && i.subject !== course.name && i.cat !== 'User Added') return false;
                }

                // 3. Text & Category
                return (i.title.toLowerCase().includes(txt) || i.author.toLowerCase().includes(txt)) && (cat === 'all' || i.cat === cat);
            });

            // Sort: Pinned First
            filtered.sort((a, b) => {
                const isPinnedA = pinnedSources.includes(a.id);
                const isPinnedB = pinnedSources.includes(b.id);
                if (isPinnedA && !isPinnedB) return -1;
                if (!isPinnedA && isPinnedB) return 1;
                return 0;
            });

            const list = document.getElementById('results-container');
            list.innerHTML = filtered.length ? '' : '<div class="text-center text-stone-400 py-8">Nessun libro trovato.</div>';

            filtered.forEach(item => {
                const isPinned = pinnedSources.includes(item.id);
                const isAiSelected = aiSelectedSources.includes(item.id);

                list.innerHTML += `
                <div class="pro-card p-4 flex flex-col md:flex-row gap-4 items-start cursor-pointer hover:border-stone-300 transition-colors ${isPinned ? 'border-l-4 border-l-rose-400 bg-rose-50/10' : ''}" onclick="openBookModal('${item.id}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1.5 flex-wrap">
                            <span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider">${item.cat}</span>
                            ${item.subject ? `<span class="text-[9px] font-bold text-rose-400 uppercase tracking-wider">‚Ä¢ ${item.subject}</span>` : ''}
                            <button onclick="event.stopPropagation(); cycleStatus('${item.id}')" class="badge uppercase ${item.status === 'done' ? 'badge-done' : (item.status === 'reading' ? 'badge-reading' : 'badge-todo')}">${item.status}</button>
                            ${item.notes ? '<span class="text-rose-500 text-[10px]">‚óè</span>' : ''}
                            ${isPinned ? '<span class="text-xs">üìå</span>' : ''}
                        </div>
                        <h3 class="text-lg font-medium text-stone-900 serif leading-snug mb-0.5">${item.title}</h3>
                        <div class="text-xs text-stone-500 font-medium">${item.author}, ${item.year}</div>
                    </div>
                    
                    <div class="flex items-center gap-2 md:self-center" onclick="event.stopPropagation()">
                        <button onclick="togglePin('${item.id}')" class="p-2 rounded-full hover:bg-stone-100 ${isPinned ? 'text-rose-500' : 'text-stone-300'}" title="${isPinned ? 'Rimuovi Pin' : 'Fissa in alto'}">
                           üìç
                        </button>
                         <label class="flex items-center gap-1 cursor-pointer p-2 rounded-full hover:bg-stone-100" title="Seleziona per AI">
                            <input type="checkbox" class="accent-stone-900 w-4 h-4" ${isAiSelected ? 'checked' : ''} onchange="toggleAiSelect('${item.id}')">
                            <span class="text-[10px] uppercase font-bold text-stone-400">AI</span>
                        </label>
                         <button onclick="deleteSource('${item.id}')" class="p-2 rounded-full hover:bg-red-50 text-stone-300 hover:text-red-500 transition-colors" title="Elimina">
                           üóëÔ∏è
                        </button>
                    </div>
                </div>`;
            });
        }

        // --- SOURCE MANAGEMENT ACTIONS ---
        function togglePin(id) {
            if (pinnedSources.includes(id)) pinnedSources = pinnedSources.filter(x => x !== id);
            else pinnedSources.push(id);
            saveData();
            runSearch();
        }

        function toggleAiSelect(id) {
            if (aiSelectedSources.includes(id)) aiSelectedSources = aiSelectedSources.filter(x => x !== id);
            else aiSelectedSources.push(id);
            // No save needed for session-only select, but re-render might help if we had visual state outside checkbox
            // runSearch(); // Optional, checkbox checked state is enough usually, but re-render is safer for syncing
        }

        function deleteSource(id) {
            const book = biblioData.find(b => b.id === id);
            if (confirm(`Sei sicuro di voler eliminare "${book.title}"?`)) {
                deletedSources.push(id);
                // Also remove from Pinned/AI Select to be clean
                pinnedSources = pinnedSources.filter(x => x !== id);
                aiSelectedSources = aiSelectedSources.filter(x => x !== id);
                saveData();
                runSearch();
            }
        }

        function addNewSourcePrompt() {
            const author = prompt("Autore (es. Rossi, M.):");
            if (!author) return;
            const title = prompt("Titolo del libro:");
            if (!title) return;
            const year = prompt("Anno:");

            const newId = "U" + Date.now();
            const newBook = { id: newId, author: author, title: title, year: year || "????", pub: "User Added", cat: "User Added", status: "todo", notes: "", tags: [] };

            biblioData.unshift(newBook);
            saveData();
            runSearch();
            alert("Libro aggiunto!");
        }

        function openBookModal(id) { currentBookId = id; const b = biblioData.find(x => x.id === id); document.getElementById('modal-title').innerText = b.title; document.getElementById('modal-author').innerText = b.author; document.getElementById('modal-notes').value = b.notes || ''; document.getElementById('modal-tags').value = (b.tags || []).join(', '); document.getElementById('book-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('book-modal').classList.add('hidden'); }
        function saveBookDetails() { const b = biblioData.find(x => x.id === currentBookId); b.notes = document.getElementById('modal-notes').value; b.tags = document.getElementById('modal-tags').value.split(',').map(t => t.trim()).filter(t => t); saveData(); closeModal(); runSearch(); renderConcepts(); }
        function cycleStatus(id) { const i = biblioData.findIndex(x => x.id === id); const map = { 'todo': 'reading', 'reading': 'done', 'done': 'todo' }; biblioData[i].status = map[biblioData[i].status]; if (biblioData[i].status === 'done') confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: ['#E7E5E4', '#F43F5E'] }); saveData(); renderStats(); runSearch(); }


        // --- DASHBOARD LOGIC (NEW) ---
        function renderDashboard() {
            const container = document.getElementById('course-grid');
            let html = courses.map(course => {
                const daysLeft = Math.ceil((new Date(course.date) - new Date()) / (1000 * 60 * 60 * 24));
                const totalTopics = course.topics.length;
                // Quick fake progress: count how many primary sources of this subject are "done"
                // Better metric: we don't have per-topic progress yet, so let's stick to reading stats for that subject
                const subjBooks = biblioData.filter(b => b.subject === course.name);
                const doneCount = subjBooks.filter(b => b.status === 'done').length;
                const progress = subjBooks.length > 0 ? Math.round((doneCount / subjBooks.length) * 100) : 0;

                return `
                <div class="pro-card p-6 border-l-4 ${daysLeft < 30 ? 'border-l-rose-500' : 'border-l-stone-800'} relative group cursor-pointer" onclick="selectCourse('${course.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">${course.prof}</span>
                            <h3 class="text-xl font-serif text-stone-900 font-medium">${course.name}</h3>
                        </div>
                        <div class="text-right">
                             <div class="text-lg font-mono font-bold ${daysLeft < 30 ? 'text-rose-600' : 'text-stone-700'}">${daysLeft}gg</div>
                             <div class="text-[9px] uppercase font-bold text-stone-400">All'esame</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs text-stone-500">
                            <span>Sillabo: ${totalTopics} Moduli</span>
                            <span>Letture: ${progress}%</span>
                        </div>
                        <div class="w-full bg-stone-100 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-stone-800 h-1.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                         <span class="text-xs bg-stone-900 text-white px-2 py-1 rounded">Vai al corso ‚Üí</span>
                    </div>
                </div>`;
            }).join('');

            // ADD NEW COURSE CARD
            html += `
            <div onclick="openCourseModal()" class="border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-stone-400 cursor-pointer hover:border-text-stone-600 hover:text-stone-600 hover:bg-stone-50 transition-colors min-h-[160px]">
                <div class="text-3xl mb-2">+</div>
                <div class="font-bold text-sm uppercase tracking-wider">Aggiungi Corso</div>
            </div>`;

            container.innerHTML = html;
        }

        function selectCourse(id) {
            currentCourseId = id;
            renderCourseDetail(id);
            router('course-detail');
        }

        function renderCourseDetail(id) {
            const course = courses.find(c => c.id === id);
            if (!course) return;

            document.getElementById('course-title').innerText = course.name;
            document.getElementById('course-prof').innerText = "Prof. " + course.prof;
            document.getElementById('course-date').innerText = course.date;

            // Add Edit/Delete Buttons to Detail Header (dynamically injected to avoid clutter)
            const headerActions = document.getElementById('course-detail-actions'); // Need to add this to HTML or reuse exists
            if (!headerActions) {
                // Creating a dynamic action bar if not exists in HTML (User didn't add it in my view)
                // Or I can inject it into 'course-date' parent?
                // Let's create a dedicated controls area in HTML later. 
                // For now, let's append distinct buttons to the description area.
            }

            // Re-render actions
            const dateBox = document.getElementById('course-date').parentNode;
            if (!document.getElementById('course-actions-wrap')) {
                const d = document.createElement('div');
                d.id = 'course-actions-wrap';
                d.className = "flex gap-2 justify-end mt-2";
                d.innerHTML = `
                 <button onclick="openCourseModal('${course.id}')" class="text-xs border border-stone-200 px-3 py-1 rounded hover:bg-stone-50">Modifica</button>
                 <button onclick="deleteCourse('${course.id}')" class="text-xs border border-red-100 text-red-500 px-3 py-1 rounded hover:bg-red-50">Elimina</button>
                 `;
                dateBox.appendChild(d);
            } else {
                // Update IDs for click handlers
                const w = document.getElementById('course-actions-wrap');
                w.innerHTML = `
                 <button onclick="openCourseModal('${course.id}')" class="text-xs border border-stone-200 px-3 py-1 rounded hover:bg-stone-50">Modifica</button>
                 <button onclick="deleteCourse('${course.id}')" class="text-xs border border-red-100 text-red-500 px-3 py-1 rounded hover:bg-red-50">Elimina</button>
                 `;
            }


            const box = document.getElementById('course-syllabus-container');
            box.innerHTML = '';

            if (course.topics.length === 0) {
                box.innerHTML = `<div class="text-center text-stone-400 py-10 italic">Nessun modulo nel sillabo. (L'editor dei moduli arriver√† presto!)</div>`;
            }

            // Helper for safe strings
            const safe = (str) => str ? str.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';

            course.topics.forEach((topic, idx) => {
                box.innerHTML += `
                <details class="group bg-white border border-stone-200 rounded-xl overflow-hidden hover:border-stone-300 transition-colors" ${idx === 0 ? 'open' : ''}>
                    <summary class="flex justify-between items-center p-5 cursor-pointer bg-stone-50/50 hover:bg-stone-50">
                        <h4 class="font-bold text-stone-800 text-lg serif">${topic.title}</h4>
                        <span class="text-stone-400 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="p-6 border-t border-stone-100 bg-white space-y-5">
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Obiettivo</span><p class="text-sm text-stone-800 font-medium leading-relaxed">${topic.goal}</p></div>
                            <div><span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Materiali</span><p class="text-sm text-stone-600 leading-relaxed">${(topic.texts || []).join(', ')}</p></div>
                        </div>
                         <div class="pt-4 mt-2 border-t border-stone-100 flex justify-end gap-2">
                             <button onclick="askAI('Spiegami ${safe(topic.title)} del corso ${safe(course.name)}')" class="bg-stone-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors">Chiedi a Jesse</button>
                        </div>
                    </div>
                </details>`;
            });
        }

        // --- ROADMAP LOGIC (THESIS ONLY) ---
        function renderRoadmap() {
            const sel = document.getElementById('roadmapSelect').value;
            const st = sel === 'custom' ? customStrategy : detailedRoadmaps[sel];

            document.getElementById('roadmap-title').innerText = st.title;
            document.getElementById('roadmap-desc').innerText = st.desc;
            document.getElementById('custom-controls').className = sel === 'custom' ? 'border-t border-stone-200 pt-4 flex gap-2 justify-end' : 'hidden';

            // Top Sources
            let bibContainer = document.getElementById('roadmap-biblio');
            let bibList = document.getElementById('roadmap-biblio-list');

            if (!bibContainer) {
                const descBox = document.getElementById('roadmap-desc').parentNode.parentNode;
                bibContainer = document.createElement('div');
                bibContainer.id = 'roadmap-biblio';
                bibContainer.className = "mt-4 pt-4 border-t border-stone-200 hidden";
                bibContainer.innerHTML = `<span class="text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-2 block">üìö Bibliografia Essenziale:</span><div id="roadmap-biblio-list" class="flex flex-wrap gap-2"></div>`;
                descBox.appendChild(bibContainer);
                bibListElement = document.getElementById('roadmap-biblio-list'); // Re-get after creation
            }

            // New logic for rendering top sources
            bibList = document.getElementById('roadmap-biblio-list'); // Get the actual list container
            bibList.innerHTML = ''; // Clear existing content

            if (st.top_sources && st.top_sources.length > 0) {
                bibContainer.classList.remove('hidden'); // Ensure container is visible
                bibList.innerHTML = st.top_sources.map(id => {
                    const book = biblioData.find(b => b.id === id);
                    if (!book) return '';
                    // Display: "Simondon - L'individuazione..."
                    return `<div class="bg-white p-2 rounded border border-stone-200 text-xs text-stone-600 flex items-center justify-between gap-2 max-w-full overflow-hidden">
                        <span class="font-bold whitespace-nowrap">${book.author}</span>
                        <span class="truncate italic opacity-80" title="${book.title}">${book.title}</span>
                        <span class="text-[9px] bg-stone-100 text-stone-400 px-1 rounded shrink-0">${book.year}</span>
                    </div>`;
                }).join('');
            } else {
                bibContainer.classList.add('hidden'); // Hide container if no sources
                bibList.innerHTML = '<div class="text-stone-400 text-xs italic">Nessuna fonte specifica selezionata.</div>';
            }

            // Chapters
            const c = document.getElementById('chapters-container');
            c.innerHTML = '';

            if (st.chapters.length === 0 && sel === 'custom') {
                c.innerHTML = '<div class="text-center text-stone-400 py-10 italic">Nessun capitolo. Chiedi a Jesse!</div>';
                return;
            }

            // HELPER_FIX: Safe string for onclick to prevent breaking on quotes
            const safe = (str) => str ? str.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';

            st.chapters.forEach((ch, idx) => {
                // If chapter lacks new detailed fields (legacy custom), fallback
                const objectivesHtml = ch.objectives ? `<ul class="list-disc list-inside text-stone-600 text-sm space-y-1 mb-3">${ch.objectives.map(o => `<li>${o}</li>`).join('')}</ul>` : '';
                const analysisHtml = ch.analysis ? `<div class="bg-stone-50 p-3 rounded-lg text-sm text-stone-700 italic border-l-2 border-stone-300 mb-3">${ch.analysis}</div>` : '';
                const methodologyHtml = ch.methodology ? `<div class="text-xs text-stone-500 mb-3"><strong class="uppercase tracking-wider text-rose-500">Metodologia:</strong> ${ch.methodology}</div>` : '';

                c.innerHTML += `
                <details class="group bg-white border border-stone-200 rounded-xl overflow-hidden hover:border-stone-300 transition-colors" ${idx === 0 ? 'open' : ''}>
                    <summary class="flex justify-between items-center p-5 cursor-pointer bg-stone-50/50 hover:bg-stone-50">
                        <h4 class="font-bold text-stone-800 text-lg serif">${ch.title}</h4>
                        <span class="text-stone-400 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="p-6 border-t border-stone-100 bg-white space-y-4">
                        <div class="uppercase text-[10px] font-bold text-stone-400 tracking-wider">Obiettivo: ${ch.goal}</div>
                        
                        ${objectivesHtml}
                        ${analysisHtml}
                        ${methodologyHtml}

                        <div class="pt-4 mt-2 border-t border-stone-100 flex justify-between items-center">
                             <div class="flex gap-2 text-xs text-stone-400 font-mono">
                                ${ch.concepts ? `<span>üîë ${ch.concepts}</span>` : ''}
                             </div>
                             <button onclick="askAI('Aiutami con il capitolo: ${safe(ch.title)}. Obiettivo: ${safe(ch.goal)}. Analisi: ${safe(ch.analysis)}')" class="bg-stone-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors shadow-sm flex items-center gap-2">
                                <span>üê∂</span> Chiedi a Jesse
                             </button>
                        </div>
                    </div>
                </details>`;
            });
        }

        // --- JESSE & CHAT ---
        function setMode(m) {
            aiMode = m;
            const msg = m === 'discuss' ? "Grrr... facciamo sul serio! Sono la commissione di laurea. Difendi la tua tesi, padrona!" : (m === 'Socrajess' ? "Modalit√† Socrajess on: ti risponder√≤ solo con domande, bau!" : "Modalit√† Relatore Severo: preparati, sar√≤ pignolissimo!");
            addMessage(msg, 'bot');
        }

        function toggleChat() {
            const w = document.getElementById('chat-widget');
            w.classList.toggle('chat-closed');
            w.classList.toggle('chat-open');
        }

        function addMessage(txt, role) {
            const box = document.getElementById('chat-messages');
            const html = marked.parse(txt);
            const isJesse = role === 'bot';
            box.innerHTML += `
            <div class="flex gap-3 fade-in mt-4 ${isJesse ? '' : 'flex-row-reverse'}">
                <div class="w-8 h-8 rounded-full overflow-hidden border border-stone-200 shrink-0 bg-white">
                    ${isJesse ? `<img src="${JESSE_IMG}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-stone-900 flex items-center justify-center text-white text-xs">TU</div>`}
                </div>
                <div class="p-3 rounded-2xl text-sm max-w-[85%] prose prose-sm ${isJesse ? 'msg-jesse' : 'msg-user'}">
                    ${html}
                </div>
            </div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function sendChat(mode = null, personaOverride = null) {
            const inp = document.getElementById('chat-input');
            const activeMode = mode || aiMode;
            const txt = inp.value.trim();
            if (!txt && activeMode === 'chat') return;

            addMessage(txt, 'user');
            inp.value = '';

            const loadId = 'load-' + Date.now();
            document.getElementById('chat-messages').innerHTML += `<div id="${loadId}" class="flex items-center gap-2 mt-4 ml-2"><img src="${JESSE_IMG}" class="w-6 h-6 rounded-full border border-stone-200 grayscale opacity-70"><span class="text-xs text-stone-500 italic animate-pulse">Jesse sta pensando...</span></div>`;

            // CONTEXT LOGIC: Selected > Pinned > Current Course > All
            let contextData = biblioData;
            // If user explicitly selected sources, use ONLY those
            if (aiSelectedSources.length > 0) {
                contextData = biblioData.filter(b => aiSelectedSources.includes(b.id));
            } else if (pinnedSources.length > 0) {
                // If nothing selected but items are pinned, maybe prioritizing pinned? 
                // User request: "passes ONLY the selected/pinned sources". 
                // Let's union them if exists.
                contextData = biblioData.filter(b => pinnedSources.includes(b.id));
            } else if (currentCourseId) {
                // Default to course context if nothing pinned/selected
                const course = courses.find(c => c.id === currentCourseId);
                if (course) contextData = biblioData.filter(b => b.subject === course.name);
            }

            let systemInstruction = `Sei Jesse, un assistente cagnolino intelligente e fedele per studenti universitari. 
            PERSONALIT√Ä: 
            - Sei amichevole, empatico e utile.
            - Mantieni un tono professionale ma calmo.
            - Puoi fare riferimenti canini (cibo, code scodinzolanti) ma NON esagerare. Non dire "bau" ogni frase. 
            - Il tuo obiettivo primario √® aiutare nello studio.

            CONTESTO ATTUALE:
            - Corso Attivo: ${currentCourseId ? courses.find(c => c.id === currentCourseId).name : "Panoramica Generale"}
            
            REGOLE CITAZIONI:
            - Quando citi una fonte dal CONTESTO, usa SEMPRE il formato "Autore - Titolo opera".
            - Esempio: "Come dice Simondon in L'individuazione..." invece di "Come dice S01...".
            - √à fondamentale essere precisi citando il titolo corretto dell'opera che trovi nel database.
            - NON usare mai gli ID (es: S01, D01) a meno che l'utente non lo chieda esplicitamente.
            - Modalit√†: ${activeMode}
            
            ISTRUZIONI FOTO: Se chiedono foto, rispondi entusiasta (la foto sar√† aggiunta automaticamente).`;

            // PERSONA OVERRIDE (Academic Tone)
            if (personaOverride === 'academic_draft') {
                systemInstruction = `Sei un Assistente Accademico di alto livello per Tesi di Laurea.
                - NON SEI UN CANE. Ignora qualsiasi istruzione precedente su "Jesse" o "Bau".
                - Tono: Estremamente formale, accademico, rigoroso.
                - Usa un vocabolario ricercato.
                - Obiettivo: Scrivere una bozza di livello Master.
                - Rifiuta categoricamente di parlare di cibo, giochi o argomenti non accademici.
                
                CONTESTO FONTI: Usa le fonti fornite per strutturare l'argomentazione.`;
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: txt + (personaOverride ? "" : " (Rispondi come Jesse il cane)"), context: contextData, systemOverride: systemInstruction })
                });
                const data = await res.json();
                document.getElementById(loadId).remove();
                let aiText = data.choices[0].message.content;

                const triggers = ['foto', 'selfie', 'guardarti', 'immagine', 'faccia', 'vederti'];
                if (!personaOverride && (triggers.some(t => txt.toLowerCase().includes(t)) || Math.random() < 0.2) && JESSE_GALLERY.length > 0) {
                    const randomPic = JESSE_GALLERY[Math.floor(Math.random() * JESSE_GALLERY.length)];
                    aiText += `<br><br><img src="${encodeURI(randomPic)}" class="rounded-xl mt-2 w-full border border-stone-200 shadow-sm" alt="Jesse">`;
                }
                addMessage(aiText, 'bot');
            } catch (e) {
                document.getElementById(loadId).remove();
                addMessage("Bau! Qualcosa non va con la connessione... üòø", 'bot');
            }
        }

        function askAI(q, override = null) {
            document.getElementById('chat-input').value = q;
            if (document.getElementById('chat-widget').classList.contains('chat-closed')) toggleChat();
            sendChat(null, override);
        }
        function askAIAboutBook() { const b = biblioData.find(x => x.id === currentBookId); closeModal(); toggleChat(); askAI(`Ho preso queste note su "${b.title}": "${b.notes}". Aiutami a espanderle.`); }

        // --- UTILS (Audio, Timer, Chart) ---
        function initAudio() {
            ['rain', 'cafe', 'fire'].forEach(id => { const el = document.getElementById('audio-' + id); if (el) el.volume = 0.5; });
        }
        function toggleSound(id) { const el = document.getElementById('audio-' + id); const btn = document.getElementById('btn-' + id); if (el.paused) { el.play(); btn.classList.remove('text-stone-300'); btn.classList.add('text-stone-900'); } else { el.pause(); btn.classList.add('text-stone-300'); btn.classList.remove('text-stone-900'); } }
        function stopAllSounds() { ['rain', 'cafe', 'fire'].forEach(id => { document.getElementById('audio-' + id).pause(); document.getElementById('btn-' + id).classList.add('text-stone-300'); document.getElementById('btn-' + id).classList.remove('text-stone-900'); }); }

        let timer, time = 1500, running = false, timerMode = 'focus'; // 'focus' (25m) or 'break' (7m)

        function toggleTimer() {
            const d = document.getElementById('zen-timer'); // Zen mode display
            const mainDisplay = document.getElementById('timer-display'); // Sidebar display
            const btn = document.getElementById('timer-btn');

            if (running) {
                clearInterval(timer);
                running = false;
                btn.innerText = timerMode === 'focus' ? "Riprendi Focus" : "Riprendi Pausa";
                btn.classList.remove('animate-pulse');
            } else {
                running = true;
                btn.innerText = "Pausa";
                btn.classList.add('animate-pulse');

                timer = setInterval(() => {
                    time--;
                    let m = Math.floor(time / 60), s = time % 60;
                    const t = `${m}:${s.toString().padStart(2, '0')}`;

                    mainDisplay.innerText = t;
                    d.innerText = t;
                    document.title = `${t} - Millino Fagiolino`;

                    if (time <= 0) {
                        clearInterval(timer);
                        running = false;
                        // Switch Mode
                        if (timerMode === 'focus') {
                            timerMode = 'break';
                            time = 7 * 60; // 7 minutes
                            alert("Ottimo lavoro! Ora 7 minuti di pausa obbligatoria.");
                            mainDisplay.classList.remove('text-rose-600');
                            mainDisplay.classList.add('text-teal-600'); // Greenish for break
                            btn.innerText = "Avvia Pausa";
                            btn.classList.remove('bg-stone-900');
                            btn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                        } else {
                            timerMode = 'focus';
                            time = 25 * 60;
                            alert("Pausa finita! Si torna a studiare.");
                            mainDisplay.classList.add('text-rose-600');
                            mainDisplay.classList.remove('text-teal-600');
                            btn.innerText = "Avvia Focus";
                            btn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                            btn.classList.add('bg-stone-900');
                        }
                        btn.classList.remove('animate-pulse');
                        // Update displays to new time immediately
                        let m2 = Math.floor(time / 60), s2 = time % 60;
                        const t2 = `${m2}:${s2.toString().padStart(2, '0')}`;
                        mainDisplay.innerText = t2;
                        d.innerText = t2;
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timer);
            running = false;
            timerMode = 'focus';
            time = 1500;
            document.getElementById('timer-display').innerText = "25:00";
            document.getElementById('timer-display').classList.add('text-rose-600');
            document.getElementById('timer-display').classList.remove('text-teal-600');
            document.getElementById('timer-btn').innerText = "Focus";
            document.getElementById('timer-btn').classList.remove('bg-teal-600', 'hover:bg-teal-700', 'animate-pulse');
            document.getElementById('timer-btn').classList.add('bg-stone-900');
            document.title = "Millino Fagiolino";
        }
        function toggleZenMode() { const z = document.getElementById('zen-mode'); z.classList.toggle('hidden'); }

        function renderTracker() {
            const ctx = document.getElementById('wordChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: wordHistory.map(h => h.date), datasets: [{ label: 'Parole', data: wordHistory.map(h => h.count), borderColor: '#1C1917', backgroundColor: 'rgba(28, 25, 23, 0.1)', tension: 0.3, fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#F5F5F4' }, border: { display: false } } } } });
        }
        function updateWordCount() { const v = parseInt(document.getElementById('word-input').value); if (v) { const d = new Date().toLocaleDateString('it-IT'); const i = wordHistory.findIndex(h => h.date === d); if (i >= 0) wordHistory[i].count = v; else wordHistory.push({ date: d, count: v }); localStorage.setItem('word_history', JSON.stringify(wordHistory)); renderTracker(); } }

        function selectAllCitations() { document.querySelectorAll('.cite-cb').forEach(cb => cb.checked = true); generateBibliography(); }
        function renderCitationsList() { const l = document.getElementById('citation-list'); l.innerHTML = ''; biblioData.forEach(i => { l.innerHTML += `<label class="flex items-center gap-3 p-2 hover:bg-stone-50 rounded-lg cursor-pointer"><input type="checkbox" class="accent-stone-900 cite-cb" value="${i.id}" onchange="generateBibliography()"><span class="text-xs text-stone-600 truncate">${i.title}</span></label>` }); }
        function copyCitationOutput() { const t = document.getElementById('citation-output'); t.select(); navigator.clipboard.writeText(t.value); alert("Copiato."); }
        function copyFootnoteStyle() { const c = Array.from(document.querySelectorAll('.cite-cb:checked')).map(x => x.value); const i = biblioData.filter(x => c.includes(x.id)); let o = i.map(x => `${x.author.split(',')[1].trim()} ${x.author.split(',')[0]}, *${x.title}*, ${x.pub}, Paris ${x.year}.`).join('\n'); document.getElementById('citation-output').value = o; copyCitationOutput(); }
        function generateBibliography() { const c = Array.from(document.querySelectorAll('.cite-cb:checked')).map(x => x.value); const i = biblioData.filter(x => c.includes(x.id)); let o = ""; const s = document.getElementById('citation-style').value; if (s === 'classic') { copyFootnoteStyle(); return; } i.forEach(x => { o += s === 'bibtex' ? `@book{${x.id}, title={${x.title}}...}\n` : `${x.author} (${x.year}). ${x.title}.\n\n` }); document.getElementById('citation-output').value = o; }
        function downloadBibliography() { const t = biblioData.filter(b => b.status === 'done' || b.status === 'reading').map(b => `${b.author} (${b.year}). ${b.title}.`).join('\n\n'); const b = new Blob([t], { type: 'text/plain' }); const u = window.URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = "bibliografia.txt"; a.click(); }

        function renderStats() {
            const done = biblioData.filter(i => i.status === 'done').length;
            const total = biblioData.length;
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            document.getElementById('reading-progress-text').innerText = pct + "%";
            document.getElementById('reading-progress-bar').style.width = pct + "%";
            document.getElementById('count-todo').innerText = biblioData.filter(i => i.status === 'todo').length;
            document.getElementById('count-reading').innerText = biblioData.filter(i => i.status === 'reading').length;
            document.getElementById('count-done').innerText = done;
            document.getElementById('total-sources-count').innerText = total;
        }
        function renderConcepts() {
            const tags = {}; biblioData.forEach(b => (b.tags || []).forEach(t => { if (!tags[t]) tags[t] = []; tags[t].push(b.title); }));
            const cloud = document.getElementById('concept-cloud');
            cloud.innerHTML = Object.keys(tags).length === 0 ? '<span class="text-stone-400 text-sm italic">Aggiungi tag ai libri per vedere le connessioni.</span>' : '';
            Object.keys(tags).forEach(tag => cloud.innerHTML += `<button onclick="filterByTag('${tag}')" class="bg-white border border-stone-200 px-3 py-1 rounded-full text-xs text-stone-600 hover:border-rose-300 hover:text-rose-600 transition-colors">#${tag} (${tags[tag].length})</button>`);
        }
        function filterByTag(tag) { document.getElementById('concept-results').innerHTML = `<h4 class="text-sm font-bold text-stone-900 mb-2">Libri collegati a #${tag}:</h4>` + biblioData.filter(b => (b.tags || []).includes(tag)).map(b => `<div class="bg-white p-3 rounded-lg border border-stone-100 text-sm text-stone-600">${b.title}</div>`).join(''); }
        function renderDeadline() { const d = localStorage.getItem('thesis_deadline'); if (d) { document.getElementById('deadline-input').value = d; const days = Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60 * 24)); document.getElementById('days-remaining').innerText = `${days} GIORNI`; document.getElementById('days-remaining').classList.remove('hidden'); document.getElementById('timeline-container').classList.remove('hidden'); document.getElementById('timeline-container').innerHTML = [{ title: "Bozza", days: 60 }, { title: "Revisione", days: 30 }, { title: "Impaginazione", days: 15 }].map(m => { const x = new Date(d); x.setDate(new Date(d).getDate() - m.days); return `<div class="bg-white p-4 rounded-xl border border-stone-100 shadow-sm"><div class="text-[10px] uppercase font-bold text-rose-400 tracking-wider mb-1">Entro il ${x.toLocaleDateString()}</div><h4 class="font-serif text-lg text-stone-800">${m.title}</h4></div>`; }).join(''); } }
        function saveDeadline() { localStorage.setItem('thesis_deadline', document.getElementById('deadline-input').value); renderDeadline(); }
        function generateCustomStrategy() { document.getElementById('custom-modal').classList.remove('hidden'); }
        async function runCustomAiGeneration() { const p = document.getElementById('custom-prompt-input').value; document.getElementById('custom-modal').classList.add('hidden'); toggleChat(); addMessage(`Jesse, crea una strategia per: ${p}`, 'user'); sendChat('chat'); }
        function toggleEditMode() { const t = prompt("Nuovo Titolo:", customStrategy.title); if (t) { customStrategy.title = t; localStorage.setItem('custom_roadmap', JSON.stringify(customStrategy)); renderRoadmap(); } }

        // --- SMART SCHEDULER LOGIC (AI POWERED) ---
        async function calculateStudySchedule() {
            const input = document.getElementById('schedule-input').value.toLowerCase();
            const resultBox = document.getElementById('schedule-result');
            const loader = document.getElementById('schedule-output');

            if (!input) return alert("Inserisci la tua disponibilit√†!");

            // UI Reset
            resultBox.classList.add('hidden');
            loader.classList.remove('hidden');

            const setStatus = (text) => {
                loader.innerHTML = `<div class="space-y-3"><div class="bg-stone-100 h-10 rounded w-3/4 animate-pulse"></div><div class="text-xs text-stone-400 font-mono">${text}</div></div>`;
            };

            setStatus("Generazione bozza (Qwen 72b)...");

            // Prepare Context
            const activeCourses = courses.map(c => `${c.name} (Esame: ${c.date})`).join(", ");
            const todoCount = biblioData.filter(b => b.status === 'todo').length;
            const context = `
            CURRENT DATE: ${new Date().toLocaleDateString()}
            ACTIVE COURSES: ${activeCourses}
            PENDING SOURCES: ${todoCount}
            USER CONSTRAINTS: "${input}"
            `;

            const systemPrompt = `
            Sei un Esperto Pianificatore Accademico.
            Il tuo obiettivo √® generare un JSON array valido rappresentante una settimana di studio OTTIMIZZATA.
            
            RULES:
            1. Output MUST be strictly a valid JSON Array. No markdown, no text before/after.
            2. Structure per day: { "day": "Luned√¨", "slots": [{ "time": "09:00-11:00", "activity": "Studio Profondo", "course": "Nome Corso", "focus": "Argomento specifico" }] }
            3. Respect User Constraints implicitly.
            4. Balance "Deep Work" (mattina/pomeriggio presto) with "Review" (sera).
            5. Insert specific breaks.
            `;

            try {
                // Phase 1: Qwen 72b, Phase 2: Mandatory Judge (DeepSeek)
                const schedule = await fetchScheduleWithRetry(input, context, systemPrompt, 1, 'qwen/qwen2.5-vl-72b-instruct', setStatus);
                renderSchedule(schedule);
                loader.classList.add('hidden');
                resultBox.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                loader.innerHTML = `<div class="text-red-500 font-bold">Errore: ${e.message}. Riprova.</div>`;
            }
        }

        // --- SETTINGS LOGIC ---
        function openSettingsModal() {
            document.getElementById('openai-key-input').value = localStorage.getItem('millino_openai_key') || '';
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveOpenerKey() {
            const key = document.getElementById('openai-key-input').value.trim();
            if (key) localStorage.setItem('millino_openai_key', key);
            else localStorage.removeItem('millino_openai_key');
        }

        async function fetchScheduleWithRetry(userPrompt, context, systemInst, retries = 1, genModel = null, statusCallback = null) {
            const callApi = async (body) => {
                const r = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const resData = await r.json();
                if (!r.ok) throw new Error(resData.error || "Errore API");
                return resData;
            };

            const callOpenAIDirect = async (messages) => {
                const key = localStorage.getItem('millino_openai_key');
                if (!key) throw new Error("Manca la chiave locale");
                const r = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: messages, temperature: 0.1 })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.error?.message || "Errore OpenAI");
                return { response: data.choices[0].message.content };
            };

            // PHASE 1: GENERATION (Qwen)
            if (statusCallback) statusCallback("Generazione bozza (Qwen 72b)...");
            let payload = { message: `Genera programma settimanale. ${context}`, systemOverride: systemInst, context: [], model: genModel };
            let response = await callApi(payload);
            let rawDraft = response.choices[0].message.content;
            let finalJson = tryParseJson(rawDraft);

            // PHASE 2: REPAIR (GPT-4o-mini Hybrid)
            const localKey = localStorage.getItem('millino_openai_key');
            if (statusCallback) statusCallback(localKey ? "GPT-4o-mini (Locale): Riparazione..." : "GPT-4o-mini (Server): Riparazione...");

            const judgePrompt = `SYSTEM: Sei un Riparatore di JSON. USER CONSTRAINTS: "${userPrompt}" CONTEXT: ${context} INPUT DRAFT: ${rawDraft} TASK: 1. Rispetta vincoli. 2. Fix JSON. OUTPUT: SOLO JSON ARRAY.`;

            try {
                let repairResponse;
                if (localKey) {
                    repairResponse = await callOpenAIDirect([{ role: "user", content: judgePrompt }]);
                } else {
                    repairResponse = await callApi({ message: judgePrompt, model: "gpt-4o-mini", systemOverride: "Output ONLY JSON." });
                    repairResponse = { response: repairResponse.choices[0].message.content };
                }
                finalJson = tryParseJson(repairResponse.response);
            } catch (e) {
                console.warn("Repair failed:", e);
                if (!finalJson) throw new Error("Salvataggio fallito: " + e.message);
            }

            if (!finalJson) throw new Error("Generazione fallita.");
            return finalJson;
        }
        // --- ICS EXPORT LOGIC ---
        function downloadIcs() {
            if (!lastGeneratedSchedule) return alert("Nessun programma da esportare!");

            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Millino Fagiolino//IT\nCALSCALE:GREGORIAN\n";
            const daysMap = { "luned√¨": 1, "marted√¨": 2, "mercoled√¨": 3, "gioved√¨": 4, "venerd√¨": 5, "sabato": 6, "domenica": 0 };

            const getNextDate = (dayName) => {
                const d = new Date();
                const targetDay = daysMap[dayName.toLowerCase().trim()];
                if (targetDay === undefined) return d;

                const currentDay = d.getDay();
                let diff = targetDay - currentDay;
                if (diff <= 0) diff += 7;
                d.setDate(d.getDate() + diff);
                return d;
            };

            const formatIcsDate = (date, timeStr) => {
                const [hours, minutes] = timeStr.split(':');
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                return `${y}${m}${d}T${hours}${minutes}00`;
            };

            lastGeneratedSchedule.forEach(day => {
                if (!day.slots) return;
                const eventDate = getNextDate(day.day);

                day.slots.forEach(slot => {
                    if (!slot.time.includes('-')) return;
                    const [startStr, endStr] = slot.time.split('-');

                    icsContent += "BEGIN:VEVENT\n";
                    icsContent += `SUMMARY:üéì ${slot.course || 'Studio'} - ${slot.activity}\n`;
                    icsContent += `DESCRIPTION:${slot.focus || ''}\n`;
                    icsContent += `DTSTART:${formatIcsDate(eventDate, startStr)}\n`;
                    icsContent += `DTEND:${formatIcsDate(eventDate, endStr)}\n`;
                    icsContent += "END:VEVENT\n";
                });
            });

            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Programma_Studio_${new Date().toLocaleDateString().replace(/\//g, '-')}.ics`;
            a.click();
        }

        function tryParseJson(str) {
            if (!str) return null;
            try { return JSON.parse(str); } catch (e) {
                try { return JSON.parse(str.match(/\[[\s\S]*\]/)[0]); } catch (e2) { return null; }
            }
        }

        let lastGeneratedSchedule = null;

        function renderSchedule(scheduleData) {
            lastGeneratedSchedule = scheduleData;
            const container = document.getElementById('schedule-result');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-serif font-bold text-stone-900">Programma Ottimizzato</h3>
                    <div class="flex gap-2">
                         <button onclick="downloadIcs()" class="px-4 py-2 bg-stone-100 text-stone-600 font-bold text-xs rounded-lg hover:bg-stone-200 border border-stone-200 flex items-center gap-2">
                            üìÖ Esporta
                        </button>
                        <button onclick="calculateStudySchedule()" class="px-4 py-2 bg-stone-900 text-white font-bold text-xs rounded-lg hover:bg-black flex items-center gap-2">
                            üîÑ Rigenera
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${scheduleData.map(day => `
                        <div class="bg-white p-5 rounded-xl border border-stone-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-rose-500 mb-4 uppercase tracking-wider text-xs border-b border-stone-50 pb-2">${day.day}</h4>
                            <div class="space-y-3">
                                ${day.slots.map(slot => `
                                    <div class="flex gap-3 text-sm group">
                                        <span class="font-mono text-stone-400 font-bold text-xs min-w-[70px] pt-0.5">${slot.time}</span>
                                        <div>
                                            <div class="font-bold text-stone-800 group-hover:text-rose-600 transition-colors">${slot.activity}</div>
                                            <div class="text-xs text-stone-500 italic">${slot.course ? slot.course + ': ' : ''}${slot.focus}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

    </script>
</body>

</html>