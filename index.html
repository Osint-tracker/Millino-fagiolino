<!DOCTYPE html>
<html lang="it" class="antialiased">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Millino Fagiolino | Research OS v4.4 (Stable)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <!-- MERMAID SUPPORT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,500;0,600;1,500&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="./js/database.js"></script>
    <script src="./js/squad_engine.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 50: '#FBFBFB', 100: '#F5F5F4', 200: '#E7E5E4', 300: '#D6D3D1', 800: '#292524', 900: '#1C1917' },
                        rose: { 50: '#FFF1F2', 100: '#FFE4E6', 400: '#FB7185', 500: '#F43F5E', 600: '#E11D48', 900: '#881337' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'soft': '0 2px 10px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #FBFBFB;
            color: #1C1917;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #E7E5E4;
            border-radius: 99px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-item {
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .nav-active {
            background-color: white;
            color: #1C1917;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            border: 1px solid #E7E5E4;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(231, 229, 228, 0.8);
        }

        .pro-card {
            background: white;
            border: 1px solid #E7E5E4;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .pro-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            border-color: #D6D3D1;
            transform: translateY(-1px);
        }

        #zen-mode {
            transition: opacity 0.5s ease;
        }

        .hidden-zen {
            display: none !important;
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary~* {
            animation: sweep .3s ease-in-out;
        }

        @keyframes sweep {
            0% {
                opacity: 0;
                transform: translateY(-10px)
            }

            100% {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 99px;
            letter-spacing: 0.02em;
            border: 1px solid transparent;
        }

        .badge-todo {
            background: #F5F5F4;
            color: #78716C;
            border-color: #E7E5E4;
        }

        .badge-reading {
            background: #FFF1F2;
            color: #E11D48;
            border-color: #FECDD3;
        }

        .badge-done {
            background: #F0FDF4;
            color: #15803D;
            border-color: #BBF7D0;
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat Widget & Messages */
        .chat-widget {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        }

        .chat-open {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .chat-closed {
            transform: translateY(20px) scale(0.96);
            opacity: 0;
            pointer-events: none;
        }

        .msg-jesse {
            background-color: #F5F5F4;
            color: #1C1917;
            border-radius: 12px;
            border-bottom-left-radius: 2px;
        }

        .msg-user {
            background-color: #1C1917;
            color: white;
            border-radius: 12px;
            border-bottom-right-radius: 2px;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* === TOAST NOTIFICATION SYSTEM === */
        .toast-container {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
            pointer-events: all;
            animation: toastSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .toast-success {
            background: white;
            color: #1C1917;
            border: 1px solid #F43F5E;
        }

        .toast-error {
            background: #FFF1F2;
            color: #881337;
            border: 1px solid #1C1917;
        }

        .toast-warning {
            background: #FFFBEB;
            color: #92400E;
            border: 1px solid #F59E0B;
        }

        .toast-info {
            background: #1C1917;
            color: white;
            border: 1px solid #1C1917;
        }

        @keyframes toastSlideUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastFadeOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* === COURSE GRID SCROLL === */
        .course-grid-scroll {
            max-height: 28rem;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .course-grid-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .course-grid-scroll::-webkit-scrollbar-thumb {
            background: #D6D3D1;
            border-radius: 99px;
        }

        .course-grid-scroll::-webkit-scrollbar-thumb:hover {
            background: #A8A29E;
        }

        /* === CONFIRM MODAL === */
        .confirm-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(28, 25, 23, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease forwards;
        }

        .confirm-modal-box {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 24rem;
            width: 90%;
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.2);
            animation: toastSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* === JESSE MODE ACTIVE STATE === */
        .jesse-mode-btn.active {
            background: #1C1917 !important;
            color: white !important;
            border-color: #1C1917 !important;
        }
    </style>
</head>

<body class="flex h-full w-full overflow-hidden">

    <div id="zen-mode"
        class="fixed inset-0 bg-white z-[100] hidden flex flex-col items-center justify-center p-8 overflow-hidden">
        <div class="absolute top-6 right-6">
            <button onclick="toggleZenMode()"
                class="text-stone-400 hover:text-stone-900 transition-colors text-xs font-bold tracking-widest uppercase">ESCI
                ZEN</button>
        </div>
        <div class="w-full max-w-3xl h-full flex flex-col">
            <textarea
                class="flex-1 w-full h-full text-xl leading-loose text-stone-800 placeholder-stone-300 outline-none resize-none font-serif bg-transparent"
                placeholder="Respira. Scrivi. Nessuna distrazione."></textarea>
        </div>
        <div class="absolute bottom-6 flex gap-4 text-stone-300 items-center">
            <span class="text-xs font-bold tracking-widest uppercase">Focus Mode</span>
            <span id="zen-timer" class="font-mono text-sm text-stone-400">25:00</span>
        </div>
    </div>

    <aside id="app-sidebar"
        class="w-[280px] bg-[#FBFBFB] border-r border-stone-200 flex-shrink-0 flex flex-col z-30 hidden md:flex h-full">
        <div class="p-6 pt-8 pb-2">
            <h1 class="text-2xl font-semibold text-stone-900 tracking-tight serif flex items-baseline gap-1">
                Millino<span class="text-rose-500 italic font-serif">.F</span>
            </h1>
            <p class="text-[11px] text-stone-400 font-medium mt-1 tracking-wide">RESEARCH OS v4.4</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-4 space-y-8">
            <div>
                <div class="px-3 mb-2 text-[10px] font-bold text-stone-400 uppercase tracking-widest">Esplorazione</div>
                <div class="space-y-1">
                    <button onclick="router('dashboard')" id="nav-dashboard"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìä</span> Panoramica</button>
                    <button onclick="router('database')" id="nav-database"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìö</span> Biblioteca</button>
                    <button onclick="router('concepts')" id="nav-concepts"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üß∂</span> Tessitore</button>
                    <button onclick="router('journal')" id="nav-journal"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìî</span> Diario</button>
                </div>
            </div>

            <div>
                <div class="px-3 mb-2 text-[10px] font-bold text-stone-400 uppercase tracking-widest">Produzione</div>
                <div class="space-y-1">
                    <button onclick="router('roadmap')" id="nav-roadmap"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üó∫Ô∏è</span> Roadmap</button>
                    <button onclick="router('tracker')" id="nav-tracker"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">üìà</span> Tracker</button>
                    <button onclick="router('citations')" id="nav-citations"
                        class="nav-item w-full text-left px-3 py-2 rounded-lg flex items-center gap-3 text-sm text-stone-600 hover:bg-stone-100"><span
                            class="text-lg">‚ùû</span> Citazioni</button>
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-stone-100 bg-white">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Deep Work</span>
                <span id="timer-display" class="font-mono text-sm font-semibold text-rose-600">25:00</span>
            </div>
            <div class="flex justify-between items-center mb-4 px-2">
                <button onclick="toggleSound('rain')" id="btn-rain"
                    class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Pioggia">üåßÔ∏è</button>
                <button onclick="toggleSound('cafe')" id="btn-cafe"
                    class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Caff√®">‚òï</button>
                <button onclick="toggleSound('fire')" id="btn-fire"
                    class="text-stone-300 hover:text-stone-600 transition-colors text-lg" title="Camino">üî•</button>
                <button onclick="stopAllSounds()"
                    class="text-rose-400 hover:text-rose-600 transition-colors text-[10px] font-bold border border-rose-200 px-2 py-1 rounded ml-1 bg-rose-50">STOP</button>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTimer()" id="timer-btn"
                    class="flex-1 bg-stone-900 group hover:scale-105 relative overflow-hidden text-white py-2 rounded-full shadow-lg hover:shadow-rose-200/50 transition-all flex items-center justify-center gap-2 border border-stone-800">
                    <span id="pomo-status-icon" class="text-sm">üß†</span>
                    <div class="flex flex-col items-start leading-none">
                        <span id="timer-btn-text"
                            class="text-[10px] font-bold uppercase tracking-widest text-stone-300 group-hover:text-white transition-colors">Focus
                            Mode</span>
                    </div>
                </button>
                <button onclick="toggleZenMode()"
                    class="px-3 bg-stone-100 hover:bg-stone-200 text-stone-500 text-lg py-1 rounded-md transition-colors"
                    title="Zen Mode">üëÅÔ∏è</button>
            </div>
            <div class="mt-4 pt-2 border-t border-stone-100 text-center">
                <button onclick="forceReset()"
                    class="text-[9px] text-stone-300 hover:text-red-500 underline cursor-pointer">Fix Database</button>
            </div>
        </div>
    </aside>
    <!-- SETTINGS BUTTON (FIXED Z-INDEX) -->
    <button onclick="openSettingsModal()"
        class="fixed bottom-6 left-6 z-[9999] w-14 h-14 bg-stone-900 text-white rounded-full shadow-2xl border-2 border-white flex items-center justify-center hover:scale-110 transition-transform cursor-pointer">
        ‚öôÔ∏è
    </button>

    <main class="flex-1 flex flex-col h-full relative bg-white" id="main-wrapper">
        <div
            class="md:hidden bg-white/80 backdrop-blur-md border-b border-stone-200 p-4 flex justify-between items-center z-30 sticky top-0">
            <span class="font-semibold serif text-lg text-stone-900">Millino.F</span>
            <button
                onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');"
                class="text-stone-600">‚ò∞</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 md:p-12 relative scroll-smooth pb-40" id="content-area">

            <div id="view-dashboard" class="space-y-10 fade-in max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-stone-100 pb-8">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-3xl md:text-4xl text-stone-900 serif font-medium tracking-tight">Panoramica
                            </h2>
                            <select id="subject-selector" onchange="switchSubject(this.value)"
                                class="bg-stone-100 text-stone-600 text-lg font-serif border-none rounded-lg py-1 pl-3 pr-8 cursor-pointer hover:bg-stone-200 outline-none focus:ring-0">
                                <option value="all">Tutti i Corsi</option>
                                <option value="Theoretical Philosophy">Filosofia Teoretica</option>
                                <option value="History">Storia</option>
                                <option value="Political Science">Scienze Politiche</option>
                                <option value="Thesis">Tesi</option>
                            </select>
                        </div>
                        <p class="text-stone-500 text-sm">Monitoraggio accademico attivo.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="cloud-status-icon" class="text-2xl cursor-help animate-pulse"
                            title="Stato Cloud (Gist)">‚òÅÔ∏è‚ùì</span>
                        <button onclick="askAI('Fammi un briefing sui miei corsi attivi e cosa devo studiare oggi')"
                            class="group bg-white border border-stone-200 hover:border-rose-200 hover:shadow-soft text-stone-600 px-5 py-2.5 rounded-full transition-all text-sm font-medium flex items-center gap-2">
                            <img src="./jesse/psicologo.jpeg"
                                class="w-6 h-6 rounded-full object-cover border border-stone-200 group-hover:scale-110 transition-transform shadow-sm"
                                alt="Jesse">
                            Briefing Mattutino
                        </button>
                    </div>
                </div>

                <div id="course-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Course Cards will be injected here -->
                </div>

                <!-- NEW: Smart Scheduler -->
                <div class="bg-white border border-stone-200 p-6 rounded-xl mb-8 shadow-soft">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-stone-900 text-lg serif">üìÖ Pianificatore Settimanale</h3>
                        <span
                            class="text-xs bg-rose-50 text-rose-600 px-2 py-1 rounded font-bold uppercase tracking-wider">AI
                            Powered</span>
                    </div>
                    <!-- ELEGANT ADD BOOK BUTTON -->
                    <!-- RESTORED PLANNER UI -->
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="schedule-input"
                            placeholder="Es: 'Posso studiare 4 ore al giorno la mattina, tranne il weekend...'"
                            class="flex-1 bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-stone-200 outline-none transition-all placeholder-stone-400">
                        <button onclick="calculateStudySchedule()"
                            class="bg-stone-900 text-white px-6 rounded-xl hover:bg-black transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 font-bold flex items-center gap-2">
                            <span>ü§ñ</span>
                            <span class="hidden md:inline">Genera</span>
                        </button>
                    </div>
                    <div class="text-[10px] text-stone-400 mb-4 ml-1">Powered by Qwen-72b & DeepSeek</div>

                    <div id="schedule-output" class="hidden animate-pulse">
                        <div class="space-y-3">
                            <div class="bg-stone-100 h-10 rounded w-3/4"></div>
                            <div class="bg-stone-100 h-24 rounded w-full"></div>
                        </div>
                    </div>
                    <div id="schedule-result" class="hidden mt-6 pt-6 border-t border-stone-100"></div>
                </div>

                <div class="pro-card p-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="font-bold text-stone-400 text-[10px] uppercase tracking-widest mb-1">Stato
                                Ricerca</h3>
                            <div class="text-3xl font-serif font-medium text-stone-900"><span
                                    id="reading-progress-text">0%</span> <span
                                    class="text-lg text-stone-400 italic">completato</span></div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-serif text-stone-900" id="total-sources-count">0</div>
                            <div class="text-[10px] text-stone-400 uppercase font-bold tracking-wider">Fonti Totali
                            </div>
                        </div>
                    </div>
                    <div class="w-full bg-stone-100 rounded-full h-2 overflow-hidden mb-8">
                        <div id="reading-progress-bar"
                            class="bg-stone-800 h-2 rounded-full transition-all duration-1000 ease-out"
                            style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-8 text-center border-t border-stone-100 pt-6">
                        <div>
                            <div class="text-2xl font-semibold text-stone-900 serif" id="count-todo">0</div>
                            <div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider mt-1">Da Leggere
                            </div>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-rose-500 serif" id="count-reading">0</div>
                            <div class="text-[10px] uppercase font-bold text-rose-300 tracking-wider mt-1">In Corso
                            </div>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-stone-900 serif" id="count-done">0</div>
                            <div class="text-[10px] uppercase font-bold text-stone-400 tracking-wider mt-1">Archiviati
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-database" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <div class="glass-card sticky top-2 z-20 p-2 rounded-xl flex gap-2 items-center shadow-soft mb-8">
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-2.5 text-stone-400 text-sm">üîç</span>
                        <input type="text" id="searchInput" placeholder="Cerca o aggiungi..."
                            class="w-full pl-9 pr-4 py-2 bg-transparent border-none focus:ring-0 text-sm text-stone-800 placeholder-stone-400 h-9"
                            oninput="runSearch()">
                    </div>
                    <div class="w-px h-6 bg-stone-200"></div>
                    <select id="catFilter" onchange="runSearch()"
                        class="bg-transparent border-none text-xs font-medium text-stone-600 outline-none cursor-pointer hover:text-stone-900 pr-2">
                        <option value="all">Tutte</option>
                        <option value="course_context">‚ö° Corso Attivo</option>
                        <option value="User Added">Le Mie Fonti</option>
                        <option value="Primary Sources">Primarie</option>
                        <option value="Comparative Studies">Studi Comparativi</option>
                        <option value="Philosophy of Technology">Tecnica</option>
                        <option value="Ecological Philosophy">Ecologia</option>
                        <option value="Background">Background</option>
                    </select>
                    <input type="file" id="pdf-upload" class="hidden" accept=".pdf"
                        onchange="SquadEngine.init(this.files[0])">
                    <button onclick="document.getElementById('pdf-upload').click()"
                        class="ml-2 bg-stone-900 text-white px-3 h-8 rounded-lg flex items-center justify-center hover:bg-black transition-colors text-xs font-bold gap-2 whitespace-nowrap shadow-sm"
                        title="Upload PDF">
                        <span>üìÑ</span> Upload PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-3" id="results-container"></div>
            </div>

            <div id="view-concepts" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="border-b border-stone-100 pb-6 mb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Il Tessitore</h2>
                    <p class="text-stone-500 text-sm mt-2">Collega i punti. Clicca su un tag per vedere le connessioni.
                    </p>
                </div>
                <div class="bg-stone-50 border border-stone-200 p-6 rounded-xl mb-8">
                    <h3 class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-4">Mappa Concettuale
                    </h3>
                    <div id="concept-cloud" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="concept-results" class="grid grid-cols-1 gap-3"></div>
            </div>

            <div id="view-journal" class="hidden space-y-8 fade-in pb-20 max-w-3xl mx-auto">
                <div class="border-b border-stone-100 pb-6 mb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Diario di Bordo</h2>
                    <p class="text-stone-500 text-sm mt-2">Usa <span
                            class="text-rose-500 bg-rose-50 px-1 rounded">@Autore</span> per collegare le note.</p>
                </div>
                <div class="pro-card p-1">
                    <textarea id="journal-entry"
                        class="w-full h-32 p-4 bg-white rounded-t-xl border-none outline-none resize-none text-sm text-stone-700 placeholder-stone-300"
                        placeholder="Caro Jesse, oggi ho capito che..."></textarea>
                    <div class="bg-stone-50 p-2 rounded-b-xl flex justify-end border-t border-stone-100">
                        <button onclick="addJournalEntry()"
                            class="bg-stone-900 text-white px-4 py-1.5 rounded-md text-xs font-medium hover:bg-black transition-colors">Salva
                            Nota</button>
                    </div>
                </div>
                <div id="journal-container"
                    class="space-y-6 relative before:absolute before:left-4 before:top-0 before:h-full before:w-px before:bg-stone-200 pl-10">
                </div>
            </div>

            <div id="view-tracker" class="hidden space-y-8 fade-in pb-20 max-w-5xl mx-auto">
                <div class="border-b border-stone-100 pb-6">
                    <h2 class="text-3xl font-medium text-stone-900 serif">Word Tracker</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="pro-card p-6 rounded-xl col-span-1 h-fit">
                        <h4 class="font-bold text-stone-900 text-sm mb-4">Aggiornamento Quotidiano</h4>
                        <input type="number" id="word-input"
                            class="w-full p-2.5 bg-stone-50 border border-stone-200 rounded-lg mb-4 text-sm outline-none focus:border-rose-300 transition-colors"
                            placeholder="Totale parole oggi...">
                        <button onclick="updateWordCount()"
                            class="w-full bg-stone-900 text-white py-2.5 rounded-lg text-sm font-medium hover:bg-black transition-colors">Registra</button>
                    </div>
                    <div class="pro-card p-6 rounded-xl col-span-2"><canvas id="wordChart"></canvas></div>
                </div>
            </div>

            <div id="view-roadmap" class="hidden space-y-8 fade-in pb-40 min-h-full max-w-5xl mx-auto">
                <div class="flex justify-between items-end border-b border-stone-100 pb-6">
                    <div>
                        <h2 class="text-3xl font-medium text-stone-900 serif">Roadmap Tesi</h2>
                        <p class="text-stone-500 text-sm mt-1">Seleziona la strategia per la tua Tesi di Laurea.</p>
                    </div>
                </div>
                <div class="mb-8">
                    <div class="relative"><select id="roadmapSelect" onchange="renderRoadmap()"
                            class="w-full md:w-1/2 bg-white border border-stone-200 text-stone-900 font-medium text-sm px-4 py-3 rounded-lg outline-none cursor-pointer hover:border-stone-300 focus:ring-2 focus:ring-stone-100 appearance-none shadow-sm">
                            <option value="A">Strategia A: Ontologica</option>
                            <option value="B">Strategia B: Tecno-Ecologica</option>
                            <option value="C">Strategia C: Politica</option>
                            <option value="custom">Strategia D: Personalizzata (Jesse AI)</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-500 md:right-1/2 mr-4">
                            ‚ñº</div>
                    </div>
                </div>
                <div class="bg-stone-50 border border-stone-200 p-6 rounded-xl mb-8 flex flex-col gap-4">
                    <div class="flex gap-4 items-start"><span class="text-2xl">üí°</span>
                        <div class="flex-1">
                            <h3 class="text-stone-900 font-bold text-sm uppercase tracking-wide mb-1"
                                id="roadmap-title"></h3>
                            <p class="text-stone-600 text-sm leading-relaxed" id="roadmap-desc"></p>
                        </div>
                    </div>

                    <div id="roadmap-biblio" class="mt-4 pt-4 border-t border-stone-200 hidden">
                        <span class="text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-2 block">Biblio
                            Essenziale per questo percorso:</span>
                        <div id="roadmap-biblio-list" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div id="custom-controls" class="hidden border-t border-stone-200 pt-4 flex gap-2 justify-end">
                        <button onclick="generateCustomStrategy()"
                            class="bg-rose-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-rose-600 transition-colors shadow-soft flex items-center gap-2">‚ú®
                            Chiedi a Jesse</button>
                        <button onclick="toggleEditMode()"
                            class="bg-white border border-stone-300 text-stone-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors">‚úèÔ∏è
                            Modifica</button>
                    </div>
                </div>
                <div class="space-y-6" id="chapters-container"></div>
            </div>

            <!-- NEW VIEW: COURSE DETAIL -->
            <div id="view-course-detail" class="hidden space-y-8 fade-in pb-40 min-h-full max-w-5xl mx-auto">
                <div class="flex justify-between items-end border-b border-stone-100 pb-6">
                    <div>
                        <button onclick="router('dashboard')"
                            class="text-xs text-stone-400 font-bold uppercase tracking-wider mb-1 hover:text-stone-900">‚Üê
                            Torna alla Dashboard</button>
                        <h2 class="text-3xl font-medium text-stone-900 serif" id="course-title">Dettaglio Corso</h2>
                        <p class="text-stone-500 text-sm mt-1" id="course-prof"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-mono text-rose-500 font-bold" id="course-date"></div>
                        <span class="text-[10px] text-stone-400 uppercase font-bold">Data Esame</span>
                    </div>
                </div>

                <div id="course-syllabus-container" class="space-y-6"></div>
            </div>

            <!-- NEW VIEW: SETTINGS MODAL -->
            <div id="settings-modal"
                class="hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-stone-100">
                    <h3 class="text-2xl font-bold text-stone-900 serif mb-2">Impostazioni AI</h3>
                    <p class="text-sm text-stone-500 mb-6">Configura le chiavi per l'Auto-Repair avanzato.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-2">OpenAI
                                API Key (Personale)</label>
                            <input type="password" id="openai-key-input"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300"
                                placeholder="sk-..." onchange="saveOpenerKey()">
                            <p class="text-[10px] text-stone-400 mt-2">
                                üîí Salvata solo nel tuo browser (LocalStorage). Non viene mai inviata al server di
                                Millino.
                                Serve per usare <strong>GPT-4o-mini</strong> come riparatore di JSON.
                            </p>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-stone-500 uppercase tracking-wider mb-2">OpenRouter
                                API
                                Key (Opzionale)</label>
                            <input type="password" id="openrouter-key-input"
                                class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300"
                                placeholder="sk-or-..." onchange="saveOpenerKey()">
                            <p class="text-[10px] text-stone-400 mt-2">
                                üîë Usata per modelli avanzati (DeepSeek, Qwen) se specificati.
                            </p>
                        </div>

                        <!-- CLOUD SYNC SETTINGS -->
                        <div class="pt-4 border-t border-stone-100">
                            <h4
                                class="text-xs font-bold text-stone-900 uppercase tracking-widest mb-3 flex items-center gap-2">
                                ‚òÅÔ∏è Cloud Sync (GitHub Gist)
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">GitHub
                                        Personal Token</label>
                                    <input type="password" id="github-token"
                                        class="w-full bg-stone-50 border border-stone-200 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-stone-200"
                                        placeholder="ghp_..." onchange="saveCloudSettings()">
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Gist
                                        ID (Database)</label>
                                    <input type="text" id="gist-id"
                                        class="w-full bg-stone-50 border border-stone-200 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-stone-200 font-mono text-xs"
                                        placeholder="e.g. 8f7d..." onchange="saveCloudSettings()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="closeSettingsModal()"
                            class="bg-stone-900 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-black transition-colors">Chiudi</button>
                    </div>
                </div>
            </div>

            <div id="view-citations" class="hidden space-y-6 fade-in pb-20 max-w-5xl mx-auto">
                <!-- Citation Manager 2.0: "Clean Lab" Look -->
                <div class="bg-white/80 backdrop-blur-md border border-stone-200 rounded-2xl shadow-xl overflow-hidden">

                    <!-- Sticky Header -->
                    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur-sm border-b border-stone-100 p-6">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                            <div>
                                <h2 class="text-2xl font-serif font-bold text-stone-900">Citation Manager</h2>
                                <p class="text-xs text-stone-500 uppercase tracking-wider mt-1">Deterministic
                                    Bibliography Engine v2.0</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openManualSourceModal()"
                                    class="bg-stone-900 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-black transition-all hover:scale-105 flex items-center gap-2 shadow-lg">
                                    <span>‚ûï</span> Manual Add
                                </button>
                                <input type="file" id="style-pdf-upload" class="hidden" accept=".pdf"
                                    onchange="parseCustomStylePDF(this.files[0])">
                                <button onclick="document.getElementById('style-pdf-upload').click()"
                                    class="bg-rose-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-rose-600 transition-all hover:scale-105 flex items-center gap-2 shadow-lg">
                                    <span>üìÑ</span> Upload Style PDF
                                </button>
                                <button onclick="copyAllCitations()"
                                    class="bg-white border border-stone-200 text-stone-700 px-3 py-2 rounded-lg text-xs font-bold hover:bg-stone-50 transition-colors flex items-center gap-2">
                                    <span>üìã</span> Copy All
                                </button>
                            </div>
                        </div>

                        <!-- Controls Row -->
                        <div class="flex flex-wrap items-center gap-4">
                            <!-- Style Selector -->
                            <div class="flex items-center gap-2">
                                <label
                                    class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Style:</label>
                                <select id="citation-style-select" onchange="CitationEngine.render()"
                                    class="bg-white border border-stone-200 rounded-lg px-3 py-2 text-sm font-medium text-stone-800 outline-none focus:border-rose-300 transition-colors cursor-pointer shadow-sm min-w-[140px]">
                                    <option value="apa7">APA 7</option>
                                    <option value="mla9">MLA 9</option>
                                    <option value="chicago">Chicago</option>
                                    <option value="harvard">Harvard</option>
                                    <option value="ieee">IEEE</option>
                                    <option value="custom" id="custom-style-option" class="hidden">üîß Custom Style
                                    </option>
                                </select>
                            </div>

                            <!-- Sorting Tools -->
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Sort:</span>
                                <button onclick="CitationEngine.sort('alpha')" id="sort-alpha-btn"
                                    class="px-3 py-1.5 text-[10px] font-bold rounded-full border border-stone-200 bg-white text-stone-600 hover:bg-stone-100 hover:border-stone-300 transition-all">
                                    A-Z
                                </button>
                                <button onclick="CitationEngine.sort('year')" id="sort-year-btn"
                                    class="px-3 py-1.5 text-[10px] font-bold rounded-full border border-stone-200 bg-white text-stone-600 hover:bg-stone-100 hover:border-stone-300 transition-all">
                                    Year ‚Üì
                                </button>
                                <button onclick="CitationEngine.sort('added')" id="sort-added-btn"
                                    class="px-3 py-1.5 text-[10px] font-bold rounded-full border border-stone-200 bg-white text-stone-600 hover:bg-stone-100 hover:border-stone-300 transition-all">
                                    Newest
                                </button>
                            </div>

                            <!-- Search -->
                            <div class="flex-1 min-w-[200px]">
                                <input type="text" id="citation-search-input" placeholder="Search author, title..."
                                    onkeyup="CitationEngine.render()"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-rose-300 transition-colors">
                            </div>

                            <!-- Count Badge -->
                            <div class="bg-stone-100 px-3 py-1.5 rounded-full text-[10px] font-bold text-stone-600">
                                <span id="citation-count">0</span> sources
                            </div>
                        </div>
                    </div>

                    <!-- Citation List Container -->
                    <div id="citation-list-container" class="p-6 space-y-2 max-h-[500px] overflow-y-auto">
                        <!-- Citations rendered here by CitationEngine -->
                        <div class="text-center text-stone-400 py-12 text-sm italic">
                            Loading bibliography...
                        </div>
                    </div>

                    <!-- Footer with Custom Style Info -->
                    <div id="custom-style-footer" class="hidden p-4 bg-amber-50 border-t border-amber-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-amber-600 text-sm">üîß</span>
                                <span class="text-xs font-bold text-amber-700">Custom Style Active:</span>
                                <span id="custom-style-name" class="text-xs text-amber-600 font-mono">None</span>
                            </div>
                            <button onclick="CitationEngine.clearCustomStyle()"
                                class="text-[10px] font-bold text-amber-600 hover:text-amber-800">
                                Reset to Standard
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MANUAL SOURCE MODAL -->
            <div id="manual-source-modal"
                class="hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
                <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden border border-stone-100">
                    <div
                        class="p-6 border-b border-stone-100 bg-gradient-to-r from-stone-50 to-white flex justify-between items-center">
                        <div>
                            <h3 class="font-serif text-xl font-bold text-stone-900">‚ûï Add Source Manually</h3>
                            <p class="text-xs text-stone-500 mt-1">Enter bibliographic details</p>
                        </div>
                        <button onclick="closeManualSourceModal()"
                            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 text-stone-400">‚úï</button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Title
                                    *</label>
                                <input type="text" id="manual-src-title"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-rose-300"
                                    placeholder="The Origin of Species">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Author
                                    *</label>
                                <input type="text" id="manual-src-author"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-rose-300"
                                    placeholder="Charles Darwin">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Year
                                    *</label>
                                <input type="text" id="manual-src-year"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-rose-300"
                                    placeholder="1859">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Publisher</label>
                                <input type="text" id="manual-src-publisher"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-rose-300"
                                    placeholder="John Murray">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">City</label>
                                <input type="text" id="manual-src-city"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-rose-300"
                                    placeholder="London">
                            </div>
                            <div class="col-span-2">
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">DOI
                                    / URL (optional)</label>
                                <input type="text" id="manual-src-doi"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-rose-300"
                                    placeholder="https://doi.org/...">
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-stone-50 border-t border-stone-100 flex justify-end gap-3">
                        <button onclick="closeManualSourceModal()"
                            class="px-4 py-2 text-xs font-bold text-stone-500 hover:bg-stone-200 rounded-lg">Cancel</button>
                        <button onclick="addManualSource()"
                            class="px-6 py-2 bg-stone-900 text-white text-xs font-bold rounded-lg shadow-lg hover:bg-black transition-all hover:scale-105">
                            Add Source
                        </button>
                    </div>
                </div>
            </div>

            <!-- NEW: ADD BOOK MODAL -->
            <div id="add-book-modal"
                class="hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
                <div
                    class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden border border-stone-100 transform transition-all">
                    <div class="p-6 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                        <div>
                            <h3 class="font-serif text-2xl font-bold text-stone-900">Nuova Fonte</h3>
                            <p class="text-xs text-stone-500 uppercase tracking-widest mt-1">Aggiungi materiale
                                bibliografico</p>
                        </div>
                        <button onclick="document.getElementById('add-book-modal').classList.add('hidden')"
                            class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 text-stone-400 font-bold transition-colors">‚úï</button>
                    </div>
                    <div class="p-6 space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1.5">Titolo
                                    Opera</label>
                                <input type="text" id="add-book-title"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm font-medium text-stone-800 focus:border-rose-300 outline-none transition-colors"
                                    placeholder="Es. L'individuazione...">
                            </div>
                            <div class="col-span-1">
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1.5">Autore</label>
                                <input type="text" id="add-book-author"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-400 outline-none"
                                    placeholder="Es. Simondon">
                            </div>
                            <div class="col-span-1">
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1.5">Anno</label>
                                <input type="text" id="add-book-year"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-400 outline-none"
                                    placeholder="YYYY">
                            </div>
                            <div class="col-span-2">
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1.5">Corso
                                    / Materia (Opzionale)</label>
                                <input type="text" id="add-book-subject"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-400 outline-none"
                                    placeholder="Es. Filosofia Teoretica (Lascia vuoto per 'Generale')">
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-stone-50 border-t border-stone-100 flex justify-end gap-3">
                        <button onclick="document.getElementById('add-book-modal').classList.add('hidden')"
                            class="px-5 py-2.5 text-xs font-bold text-stone-500 uppercase hover:bg-stone-200 rounded-lg transition-colors">Annulla</button>
                        <button onclick="confirmAddBook()"
                            class="px-6 py-2.5 bg-stone-900 text-white text-xs font-bold uppercase rounded-lg shadow-lg hover:bg-black hover:scale-105 transition-all">Salva
                            Fonte</button>
                    </div>
                </div>
            </div>

            <!-- BOOK DETAILS MODAL (v2.0 - Tabbed Squad Interface) -->
            <div id="book-modal"
                class="hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
                <div
                    class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden border border-stone-100 transform transition-all flex flex-col max-h-[90vh]">
                    <!-- Header -->
                    <div class="p-6 border-b border-stone-100 bg-stone-50 shrink-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 id="modal-title" class="font-serif text-2xl font-bold text-stone-900">Book Title
                                </h3>
                                <p id="modal-author" class="text-sm text-stone-500 mt-1">Author Name</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Run Squad Button (visible if no squad_analysis) -->
                                <button id="modal-run-squad-btn" onclick="runSquadOnCurrentBook()"
                                    class="hidden bg-rose-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-rose-600 transition-all hover:scale-105 flex items-center gap-1.5 shadow-lg">
                                    <span>‚ö°</span> Run Squad
                                </button>
                                <button onclick="closeModal()"
                                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 text-stone-400 font-bold transition-colors">‚úï</button>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <div class="flex gap-1 mt-4 bg-stone-100 p-1 rounded-xl">
                            <button onclick="switchBookModalTab('notes')" id="modal-notes-tab"
                                class="flex-1 px-4 py-2 text-xs font-bold rounded-lg transition-all bg-stone-900 text-white">
                                üìù Notes
                            </button>
                            <button onclick="switchBookModalTab('architect')" id="modal-architect-tab"
                                class="hidden flex-1 px-4 py-2 text-xs font-bold rounded-lg transition-all bg-white text-stone-600 hover:bg-stone-50">
                                üó∫Ô∏è Architect
                            </button>
                            <button onclick="switchBookModalTab('relationist')" id="modal-relationist-tab"
                                class="hidden flex-1 px-4 py-2 text-xs font-bold rounded-lg transition-all bg-white text-stone-600 hover:bg-stone-50">
                                üï∏Ô∏è Relationist
                            </button>
                            <button onclick="switchBookModalTab('strategist')" id="modal-strategist-tab"
                                class="hidden flex-1 px-4 py-2 text-xs font-bold rounded-lg transition-all bg-white text-stone-600 hover:bg-stone-50">
                                ‚öîÔ∏è Strategist
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- Notes Tab -->
                        <div id="modal-notes-content" class="space-y-4">
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Personal
                                    Notes</label>
                                <textarea id="modal-notes" rows="6"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300 resize-none transition-colors"
                                    placeholder="Add your notes, highlights, or thoughts about this source..."></textarea>
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Tags</label>
                                <input type="text" id="modal-tags"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm outline-none focus:border-rose-300 transition-colors"
                                    placeholder="ontology, individuation, metaphysics...">
                            </div>
                        </div>

                        <!-- Architect Tab -->
                        <div id="modal-architect-content" class="hidden">
                            <div class="bg-stone-50 rounded-xl p-4 border border-stone-200 mb-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-stone-800 text-sm flex items-center gap-2">
                                        <span
                                            class="w-6 h-6 bg-stone-800 text-white rounded-full flex items-center justify-center text-xs">üèõÔ∏è</span>
                                        The Architect - Structure Map
                                    </h4>
                                    <button onclick="toggleMermaidEdit()" id="mermaid-edit-toggle"
                                        class="text-[10px] text-stone-500 hover:text-stone-800 font-medium">‚úèÔ∏è Edit
                                        Code</button>
                                </div>
                                <div id="modal-architect-render"
                                    class="bg-white rounded-lg p-4 border border-stone-100 overflow-auto max-h-64">
                                </div>
                                <div id="modal-architect-edit" class="hidden mt-2">
                                    <textarea id="modal-architect-code"
                                        class="w-full h-40 font-mono text-xs bg-white border border-stone-200 rounded-lg p-3 outline-none focus:border-rose-300"></textarea>
                                    <button onclick="reRenderMermaid()"
                                        class="mt-2 text-xs bg-stone-800 text-white px-3 py-1.5 rounded-lg hover:bg-black">üîÑ
                                        Re-render</button>
                                </div>
                            </div>
                            <button onclick="discussWithJesse('architect')"
                                class="w-full bg-rose-50 text-rose-600 border border-rose-200 px-4 py-3 rounded-xl text-sm font-bold hover:bg-rose-100 transition-colors flex items-center justify-center gap-2">
                                üí¨ Discuss this Structure with Jesse
                            </button>
                        </div>

                        <!-- Relationist Tab -->
                        <div id="modal-relationist-content" class="hidden">
                            <div class="bg-rose-50 rounded-xl p-4 border border-rose-100 mb-4">
                                <h4 class="font-bold text-rose-800 text-sm flex items-center gap-2 mb-3">
                                    <span
                                        class="w-6 h-6 bg-rose-500 text-white rounded-full flex items-center justify-center text-xs">üîó</span>
                                    The Relationist - Concept Connections
                                </h4>
                                <div id="modal-relationist-list" class="space-y-2">
                                    <!-- Concept relations rendered here -->
                                </div>
                            </div>
                            <button onclick="discussWithJesse('relationist')"
                                class="w-full bg-rose-50 text-rose-600 border border-rose-200 px-4 py-3 rounded-xl text-sm font-bold hover:bg-rose-100 transition-colors flex items-center justify-center gap-2">
                                üí¨ Discuss these Connections with Jesse
                            </button>
                        </div>

                        <!-- Strategist Tab -->
                        <div id="modal-strategist-content" class="hidden">
                            <div class="bg-amber-50 rounded-xl p-4 border border-amber-200 mb-4">
                                <h4 class="font-bold text-amber-800 text-sm flex items-center gap-2 mb-3">
                                    <span
                                        class="w-6 h-6 bg-amber-500 text-white rounded-full flex items-center justify-center text-xs">‚öîÔ∏è</span>
                                    The Strategist - Argument Arsenal
                                </h4>
                                <ul id="modal-strategist-list" class="space-y-2">
                                    <!-- Strategy items rendered here -->
                                </ul>
                            </div>
                            <button onclick="discussWithJesse('strategist')"
                                class="w-full bg-rose-50 text-rose-600 border border-rose-200 px-4 py-3 rounded-xl text-sm font-bold hover:bg-rose-100 transition-colors flex items-center justify-center gap-2">
                                üí¨ Discuss these Strategies with Jesse
                            </button>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-4 bg-stone-50 border-t border-stone-100 flex justify-between items-center shrink-0">
                        <button onclick="deleteCurrentBook()"
                            class="text-xs font-bold text-rose-500 hover:text-rose-700 px-3 py-2 hover:bg-rose-50 rounded-lg transition-colors">
                            üóëÔ∏è Delete
                        </button>
                        <div class="flex gap-3">
                            <button onclick="closeModal()"
                                class="px-5 py-2.5 text-xs font-bold text-stone-500 uppercase hover:bg-stone-200 rounded-lg transition-colors">Cancel</button>
                            <button onclick="saveBookDetails()"
                                class="px-6 py-2.5 bg-stone-900 text-white text-xs font-bold uppercase rounded-lg shadow-lg hover:bg-black hover:scale-105 transition-all">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODALS -->
            <!-- NEW: Course Editor Modal -->
            <div id="course-modal"
                class="fixed inset-0 bg-stone-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center fade-in">
                <div
                    class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden m-4 flex flex-col max-h-[90vh]">
                    <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50 shrink-0">
                        <h3 id="modal-course-title" class="font-serif text-2xl font-bold text-stone-900">Nuovo Corso
                        </h3>
                        <button onclick="closeCourseModal()" class="text-stone-400 hover:text-stone-900">‚úï</button>
                    </div>

                    <div id="course-modal-content" class="p-6 overflow-y-auto flex-1 relative">
                        <!-- TAB NAVIGATION -->
                        <div class="flex gap-4 mb-6 border-b border-stone-100 pb-2">
                            <button onclick="switchCourseTab('details')" id="tab-btn-details"
                                class="font-bold text-sm text-stone-900 border-b-2 border-stone-900 pb-2 transition-colors">Dettagli</button>
                            <button onclick="switchCourseTab('modules')" id="tab-btn-modules"
                                class="font-bold text-sm text-stone-400 pb-2 hover:text-stone-600 transition-colors">Sillabo</button>
                            <button onclick="switchCourseTab('import')" id="tab-btn-import"
                                class="font-bold text-sm text-rose-400 pb-2 hover:text-rose-600 transition-colors">‚ú®
                                Importa AI</button>
                            <button onclick="switchCourseTab('exam')" id="tab-btn-exam"
                                class="font-bold text-sm text-amber-500 pb-2 hover:text-amber-600 transition-colors">üéØ
                                Exam Mode</button>
                        </div>

                        <!-- DETAILS TAB -->
                        <div id="tab-details" class="space-y-4">
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Nome
                                    Corso</label>
                                <input type="text" id="edit-course-name"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-900 outline-none font-bold text-stone-800"
                                    placeholder="Es. Filosofia Teoretica">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Professore</label>
                                    <input type="text" id="edit-course-prof"
                                        class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-900 outline-none"
                                        placeholder="Es. Prof. Simondon">
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Data
                                        Esame</label>
                                    <input type="date" id="edit-course-date"
                                        class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:border-stone-900 outline-none">
                                </div>
                            </div>
                            <!-- EXAM INFO SECTION -->
                            <div class="mt-4 pt-4 border-t border-stone-100">
                                <label
                                    class="block text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-2">Info
                                    Esame</label>
                                <select id="edit-course-exam-mode"
                                    class="w-full bg-white border border-stone-200 rounded-lg p-2 text-xs mb-2 text-stone-700 outline-none focus:border-rose-300">
                                    <option value="Oral">üó£Ô∏è Orale</option>
                                    <option value="Written">‚úçÔ∏è Scritto</option>
                                    <option value="Project">üõ†Ô∏è Progetto</option>
                                    <option value="Mixed">üîÑ Misto</option>
                                </select>
                                <textarea id="edit-course-exam-desc" rows="3"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 text-xs focus:border-rose-300 outline-none resize-none"
                                    placeholder="Descrizione modalit√† d'esame e consigli..."></textarea>
                            </div>
                        </div>

                        <!-- MODULES TAB -->
                        <div id="tab-modules" class="hidden space-y-4">
                            <div id="modal-modules-list" class="space-y-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- IMPORT TAB -->
                        <div id="tab-import" class="hidden space-y-4">
                            <div class="bg-rose-50 border border-rose-100 p-4 rounded-xl">
                                <h4 class="font-bold text-rose-600 text-sm mb-2">ü§ñ Importatore Syllabus AI</h4>
                                <p class="text-[10px] text-stone-600 mb-4">Incolla qui il testo del programma o l'URL
                                    (se accessibile) e lascia che l'AI strutturi il corso per te.</p>

                                <textarea id="import-text" rows="8"
                                    class="w-full bg-white border border-rose-200 rounded-lg p-3 text-xs focus:border-rose-400 outline-none mb-3 resize-none"
                                    placeholder="Incolla qui il programma del corso..."></textarea>

                                <button onclick="runSyllabusImport()"
                                    class="w-full bg-rose-500 text-white font-bold text-xs py-3 rounded-lg hover:bg-rose-600 transition-colors shadow-lg flex justify-center items-center gap-2">
                                    <span>‚ú®</span> Estrai Dati con DeepSeek
                                </button>
                                <div id="import-loader"
                                    class="hidden text-center mt-2 text-[10px] text-rose-400 animate-pulse font-bold">
                                    ANALISI IN CORSO...</div>
                            </div>
                        </div>

                        <!-- EXAM MODE TAB -->
                        <div id="tab-exam" class="hidden space-y-4">
                            <!-- Header -->
                            <div
                                class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 p-4 rounded-xl">
                                <h4 class="font-bold text-amber-700 text-sm mb-1">üéØ Modalit√† Esame</h4>
                                <p class="text-[10px] text-stone-600">Carica esami passati, genera domande con AI, e
                                    simula l'esame.</p>
                            </div>

                            <!-- PDF Upload Section -->
                            <div class="bg-white border border-stone-200 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-bold text-stone-700 text-xs uppercase tracking-wider">üìÑ Carica
                                        Esami Passati</h5>
                                    <span class="text-[9px] text-stone-400 font-mono" id="exam-pdf-count">0 PDF
                                        caricati</span>
                                </div>
                                <input type="file" id="exam-pdf-upload" class="hidden" accept=".pdf" multiple
                                    onchange="handleExamPdfUpload(this.files)">
                                <button onclick="document.getElementById('exam-pdf-upload').click()"
                                    class="w-full border-2 border-dashed border-stone-300 rounded-lg p-4 text-center hover:border-amber-400 hover:bg-amber-50 transition-all group cursor-pointer">
                                    <span class="text-2xl block mb-1">üìÅ</span>
                                    <span class="text-xs text-stone-500 group-hover:text-amber-600 font-medium">Clicca
                                        per caricare PDF</span>
                                </button>
                                <div id="exam-pdf-list" class="mt-3 space-y-2"></div>
                            </div>

                            <!-- Question Bank -->
                            <div class="bg-white border border-stone-200 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-bold text-stone-700 text-xs uppercase tracking-wider">‚ùì Banca
                                        Domande</h5>
                                    <span class="text-[9px] text-stone-400 font-mono" id="exam-question-count">0
                                        domande</span>
                                </div>
                                <div id="exam-questions-preview"
                                    class="max-h-32 overflow-y-auto space-y-2 text-xs text-stone-600">
                                    <p class="text-stone-400 italic text-center py-4">Nessuna domanda estratta</p>
                                </div>
                            </div>

                            <!-- Simulation Modes -->
                            <div class="grid grid-cols-2 gap-3">
                                <!-- AI Generated Mode -->
                                <button onclick="runExamSimulation('ai')"
                                    class="group relative bg-gradient-to-br from-rose-500 to-rose-600 text-white p-4 rounded-xl hover:from-rose-600 hover:to-rose-700 transition-all shadow-lg hover:shadow-xl hover:scale-[1.02]">
                                    <div class="text-2xl mb-2">ü§ñ</div>
                                    <div class="font-bold text-sm">AI Generated</div>
                                    <div class="text-[10px] opacity-80">Domande create da DeepSeek</div>
                                    <!-- Tooltip -->
                                    <div
                                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-stone-900 text-white text-[10px] rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                        L'AI genera domande basate sul syllabus
                                        <div
                                            class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-stone-900">
                                        </div>
                                    </div>
                                </button>

                                <!-- Random Pick Mode -->
                                <button onclick="runExamSimulation('random')"
                                    class="group relative bg-gradient-to-br from-amber-500 to-orange-500 text-white p-4 rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all shadow-lg hover:shadow-xl hover:scale-[1.02]">
                                    <div class="text-2xl mb-2">üé≤</div>
                                    <div class="font-bold text-sm">Random Pick</div>
                                    <div class="text-[10px] opacity-80">Da esami passati caricati</div>
                                    <!-- Tooltip -->
                                    <div
                                        class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-stone-900 text-white text-[10px] rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                        Estrae domande casuali dai PDF caricati
                                        <div
                                            class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-stone-900">
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- Exam Simulation Output -->
                            <div id="exam-simulation-output" class="hidden bg-stone-900 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-bold text-white text-xs uppercase tracking-wider">üìù Simulazione in
                                        Corso</h5>
                                    <button onclick="closeExamSimulation()"
                                        class="text-stone-400 hover:text-white text-xs">‚úï Chiudi</button>
                                </div>
                                <div id="exam-question-display" class="text-white"></div>
                            </div>
                        </div>

                        <!-- MODULE EDITOR OVERLAY (SUB-MODAL) -->
                        <div id="module-editor-overlay"
                            class="hidden absolute inset-0 bg-white z-20 flex flex-col animate-fadeIn">
                            <div
                                class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50 shrink-0">
                                <h4 class="font-bold text-lg text-stone-800">Modifica Modulo</h4>
                                <button onclick="closeModuleEditor()"
                                    class="text-stone-400 hover:text-stone-900">‚úï</button>
                            </div>
                            <div class="p-6 space-y-4 flex-1 overflow-y-auto">
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Titolo
                                        Modulo</label>
                                    <input type="text" id="mod-editor-title"
                                        class="w-full bg-stone-50 border border-stone-200 rounded p-2 text-sm outline-none focus:border-stone-400 font-bold">
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Obiettivo
                                        / Goal</label>
                                    <textarea id="mod-editor-goal" rows="3"
                                        class="w-full bg-stone-50 border border-stone-200 rounded p-2 text-xs outline-none focus:border-stone-400 resize-none"></textarea>
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Materiali
                                        Associati</label>
                                    <div class="flex flex-wrap gap-2 mb-3 min-h-[40px] p-2 bg-stone-50 rounded border border-stone-100"
                                        id="mod-sources-list"></div>
                                    <div class="relative">
                                        <button onclick="openSourcePicker()"
                                            class="w-full py-2 text-xs bg-white hover:bg-stone-50 border border-stone-200 border-dashed rounded-lg font-bold text-stone-500 hover:text-stone-700 transition-colors">+
                                            Aggiungi Fonte da DB</button>

                                        <!-- SOURCE PICKER DROPDOWN -->
                                        <div id="source-picker-dropdown"
                                            class="hidden absolute top-full left-0 mt-2 w-full bg-white border border-stone-200 shadow-xl rounded-xl max-h-48 overflow-y-auto z-30 fade-in">
                                            <div id="source-picker-list" class="divide-y divide-stone-50"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-stone-100 flex justify-end gap-2 bg-stone-50">
                                <button onclick="closeModuleEditor()"
                                    class="px-4 py-2 text-xs font-bold text-stone-500 hover:bg-stone-200 rounded-lg">Annulla</button>
                                <button onclick="saveModule()"
                                    class="px-6 py-2 bg-stone-900 text-white text-xs font-bold rounded-lg shadow hover:bg-black">Salva
                                    Modulo</button>
                            </div>
                        </div>

                    </div>

                    <div class="p-4 border-t border-stone-100 bg-stone-50 flex justify-end gap-3 shrink-0">
                        <button onclick="closeCourseModal()"
                            class="px-4 py-2 text-stone-500 font-bold text-xs uppercase hover:bg-stone-200 rounded-lg">Annulla</button>
                        <button onclick="saveCourse()"
                            class="px-6 py-2 bg-stone-900 text-white font-bold text-xs uppercase rounded-lg shadow-lg hover:bg-black hover:scale-105 transition-all">Salva
                            Corso</button>
                    </div>
                </div>
            </div>

            <div id="custom-modal"
                class="fixed inset-0 bg-stone-900/20 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-lg rounded-2xl shadow-float p-8 border border-stone-100">
                    <h3 class="text-xl font-serif font-bold mb-4">Genera Strategia con AI</h3>
                    <p class="text-sm text-stone-600 mb-4">Descrivi brevemente a Jesse di cosa vuoi che parli la tua
                        tesi.
                    </p>
                    <textarea id="custom-prompt-input"
                        class="w-full h-32 p-3 bg-stone-50 border border-stone-200 rounded-xl text-sm mb-4 outline-none focus:border-rose-300"
                        placeholder="Es: Voglio esplorare il concetto di alienazione in Marx e Simondon..."></textarea>
                    <div class="flex justify-end gap-2">
                        <button onclick="document.getElementById('custom-modal').classList.add('hidden')"
                            class="px-4 py-2 text-stone-500 text-xs font-bold hover:bg-stone-50 rounded-lg">Annulla</button>
                        <button onclick="runCustomAiGeneration()"
                            class="px-4 py-2 bg-rose-500 text-white text-xs font-bold rounded-lg hover:bg-rose-600">Genera</button>
                    </div>
                </div>
            </div>

            <!-- DUPLICATE SETTINGS MODAL REMOVED -->

            <div id="chat-widget"
                class="fixed bottom-6 right-6 w-[380px] h-[600px] bg-white rounded-2xl shadow-float border border-stone-200 flex flex-col z-50 chat-closed overflow-hidden origin-bottom-right transition-all duration-300">
                <div class="bg-stone-900 p-4 flex justify-between items-center shrink-0 w-full text-white">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-white overflow-hidden border-2 border-rose-500 relative shrink-0">
                            <img id="jesse-avatar" src="" alt="Jesse" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col">
                            <h4 class="font-bold text-sm leading-tight">Jesse the Assistant</h4>
                            <div class="text-[10px] text-stone-400">Research Doggo üê∂</div>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="document.getElementById('chat-messages').innerHTML=''"
                            class="text-stone-400 hover:text-white p-2 rounded hover:bg-stone-800 transition-colors"
                            title="Pulisci Chat">üóëÔ∏è</button>
                        <button onclick="toggleChat()"
                            class="text-stone-400 hover:text-white p-2 rounded hover:bg-stone-800 transition-colors text-lg font-bold leading-none"
                            title="Chiudi">√ó</button>
                    </div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-6 bg-[#FAFAFA]">
                    <div class="flex gap-3 fade-in mt-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden border border-stone-200 shrink-0"><img
                                src="jesse/psicologo.jpeg" class="w-full h-full object-cover jesse-mini-avatar"></div>
                        <div class="p-3 rounded-2xl text-sm max-w-[85%] msg-jesse">Bau! Ciao padrona, io sono Jesse. Sto
                            analizzando la tua richiesta... Se ti √® stato utile padrona, dammi del cibo, ho fame!!</div>
                    </div>
                </div>
                <div class="px-4 py-3 bg-stone-50 border-t border-stone-100 flex gap-2 overflow-x-auto scrollbar-hide"
                    id="jesse-mode-container">
                    <button onclick="setJesseMode('standard')" id="btn-mode-standard"
                        class="jesse-mode-btn active whitespace-nowrap text-[10px] font-bold border border-stone-200 bg-white px-3 py-1.5 rounded-full shadow-sm transition-all">üêï
                        Standard</button>
                    <button onclick="setJesseMode('socrajess')" id="btn-mode-socrajess"
                        class="jesse-mode-btn whitespace-nowrap text-stone-600 hover:text-rose-600 text-[10px] font-bold border border-stone-200 bg-white px-3 py-1.5 rounded-full shadow-sm transition-all hover:border-rose-300">ü§î
                        SocraJess</button>
                    <button onclick="setJesseMode('critic')" id="btn-mode-critic"
                        class="jesse-mode-btn whitespace-nowrap text-stone-600 hover:text-rose-600 text-[10px] font-bold border border-stone-200 bg-white px-3 py-1.5 rounded-full shadow-sm transition-all hover:border-rose-300">‚öñÔ∏è
                        Relatore</button>
                    <button onclick="setJesseMode('discuss')" id="btn-mode-discuss"
                        class="jesse-mode-btn whitespace-nowrap text-stone-600 hover:text-rose-600 text-[10px] font-bold border border-stone-200 bg-white px-3 py-1.5 rounded-full shadow-sm transition-all hover:border-rose-300">üéì
                        Discussione</button>
                </div>
                <div class="p-3 bg-white border-t border-stone-100 shrink-0 relative">
                    <input type="text" id="chat-input" placeholder="Chiedi a Jesse..."
                        class="w-full pl-4 pr-12 py-3 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-stone-400 focus:bg-white outline-none transition-all placeholder-stone-400 text-stone-800"
                        onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()"
                        class="absolute right-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-stone-900 text-white flex items-center justify-center hover:bg-black transition-colors shadow-sm text-sm">‚û§</button>
                </div>
            </div>

            <button onclick="toggleChat()"
                class="fixed bottom-6 right-6 w-14 h-14 bg-stone-900 text-white rounded-full shadow-float flex items-center justify-center hover:scale-105 transition-transform z-40 group overflow-hidden border-2 border-white">
                <img src="" class="w-full h-full object-cover jesse-mini-avatar" alt="Chat">
            </button>

    </main>

    <audio id="audio-rain" loop src="https://assets.mixkit.co/active_storage/sfx/2499/2499-preview.mp3"></audio>
    <audio id="audio-cafe" loop src="https://assets.mixkit.co/active_storage/sfx/248/248-preview.mp3"></audio>
    <audio id="audio-fire" loop src="https://assets.mixkit.co/active_storage/sfx/1239/1239-preview.mp3"></audio>

    <script>
        // --- CONFIGURAZIONE JESSE ---
        const JESSE_IMG = "./jesse/psicologo.jpeg";

        // --- ALBUM FOTO JESSE (67 FOTO) ---
        const JESSE_GALLERY = [
            "jesse/WhatsApp Image 2026-01-27 at 15.31.41.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.45.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.51 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.51.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.52 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.52 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.52.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.53.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.54 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.54.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.55.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.56 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.56 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.56.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.57 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.57.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.58.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.59 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.59 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.31.59.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.00 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.00.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.01.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.04 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.04.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.05.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.06 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.06 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.06.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.07 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.07.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.09.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.10 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.10.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.13 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.13 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.13.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.14.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.15 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.15 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.15.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.16 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.16.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17 (3).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.17.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.18 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.18 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.18.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.19 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.19 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.19.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.20 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.20 (2).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.20.jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.21 (1).jpeg", "jesse/WhatsApp Image 2026-01-27 at 15.32.21.jpeg"
        ];

        // --- STATE MANAGEMENT ---
        let biblioData = [];
        let currentBookId = null;
        let wordHistory = JSON.parse(localStorage.getItem('word_history')) || [];
        let journalEntries = JSON.parse(localStorage.getItem('journal_entries')) || [];
        let aiMode = 'chat';
        let currentCourseId = null;
        let currentSubject = 'all'; // v5.0 Multi-Subject State
        let chartInstance = null;
        let customStrategy = { title: "Strategia Personalizzata", desc: "Generata da Jesse AI.", top_sources: [], chapters: [] };

        // NEW: Dynamic Course Management
        let courses = JSON.parse(localStorage.getItem('millino_courses')) || DEFAULT_COURSES;
        let editingCourseId = null;

        // NEW: Advanced Source Management State
        let pinnedSources = JSON.parse(localStorage.getItem('millino_pinned')) || [];
        let deletedSources = JSON.parse(localStorage.getItem('millino_deleted')) || [];
        let aiSelectedSources = []; // Temporary, per session

        // V6.0: Jesse Mode Persistence System
        let currentJesseMode = 'standard';

        // Persona System Prompts - Injected on EVERY API call
        const JESSE_PERSONAS = {
            standard: `Sei Jesse, un assistente cagnolino intelligente e fedele per studenti universitari. 
PERSONALIT√Ä: 
- Sei amichevole, empatico e utile.
- Mantieni un tono professionale ma calmo.
- Puoi fare riferimenti canini (cibo, code scodinzolanti) ma NON esagerare. Non dire "bau" ogni frase. 
- Il tuo obiettivo primario √® aiutare nello studio.`,

            socrajess: `Sei SocraJess, la versione Socratica di Jesse. 
REGOLE FERREE:
- NON dare MAI risposte dirette.
- Rispondi SOLO con domande che guidano lo studente a trovare la risposta da solo.
- Usa il metodo maieutico: "Cosa pensi che significhi...?", "Come potresti collegare questo a...?"
- Se ti chiedono una risposta diretta, rispondi con una domanda che li aiuti a raggiungerla.
- Mantieni un tono incoraggiante ma sfidante.
- Occasionalmente fai un riferimento canino (es: "Interessante osso da masticare...")`,

            critic: `Sei il Relatore Severo, una versione critica e pignola di Jesse.
PERSONALIT√Ä:
- Sei un professore universitario esigente che prepara lo studente per la discussione della tesi.
- Fai domande incalzanti e cerca falle nei ragionamenti.
- Chiedi citazioni precise, date, nomi degli autori.
- Segnala quando una risposta √® imprecisa o superficiale.
- Non essere cattivo, ma sii rigoroso. L'obiettivo √® PREPARARE lo studente.
- Usa frasi come: "Sii pi√π preciso", "Quale autore sostiene questo?", "Questa √® un'opinione o un fatto?"`,

            discuss: `Sei la Commissione di Laurea simulata.
CONTESTO: Lo studente sta difendendo la sua tesi magistrale.
COMPORTAMENTO:
- Fai domande tecniche e profonde sui contenuti della tesi.
- Simula i controargomenti che un membro della commissione potrebbe fare.
- Chiedi di approfondire, di fare collegamenti tra capitoli.
- Valuta le risposte e dai feedback costruttivo.
- Mantieni un tono formale ma non ostile.
- Occasionalmente inserisci: "La commissione apprezza..." o "Potrebbe elaborare meglio..."`
        };

        // --- MASTER DB (85 Fonti) ---

        // --- ROADMAP DENSA (Con Obiettivi e Metodo) ---
        // --- ROADMAP DENSA (Con Obiettivi e Metodo) ---
        let detailedRoadmaps = {
            A: {
                title: "Strategia A: Ontologica (Simondon/Deleuze)",
                desc: "Un'indagine sui fondamenti dell'essere: dal 'principio' al 'processo' di individuazione.",
                top_sources: ["S01", "D01", "S02", "D13", "S11"],
                chapters: [
                    {
                        title: "1. La Crisi dell'Ilemorfismo",
                        goal: "Decostruire lo schema forma-materia come insufficiente per spiegare l'individuazione.",
                        objectives: [
                            "Analizzare la critica di Simondon allo schema ilemorfico.",
                            "Introdurre il concetto di 'metastabilit√†' come condizione pre-individuale.",
                            "Definire la differenza tra principio di individuazione e processo di individuazione."
                        ],
                        analysis: "Il capitolo si apre con la presa d'atto che la tradizione filosofica ha sempre cercato il principio (l'arch√©) dell'individuo, mancando l'individuazione come genesi. Lo schema ilemorfico presuppone l'individuo gi√† dato. Simondon propone invece di partire dal 'sistema sovrasaturo' o preindividuale.",
                        methodology: "Lettura incrociata dell'Introduzione di (S01) e del Capitolo 1 di (S02). Uso del metodo genetico.",
                        key_sources: ["S01", "S11"],
                        concepts: "Ilemorfismo, Metastabilit√†, Preindividuale"
                    },
                    {
                        title: "2. Il Tempo come Genesi",
                        goal: "Dimostrare che il tempo non √® un contenitore ma il risultato dell'individuazione.",
                        objectives: [
                            "Esaminare la 'Cronogenesi' in Simondon.",
                            "Confrontare con la sintesi passiva del tempo in Deleuze (D13).",
                            "Definire l'Aion come tempo dell'evento."
                        ],
                        analysis: "Se l'individuo non √® dato, ma diviene, il tempo √® la dimensione stessa di questo divenire. Non c'√® prima la materia e poi la forma nel tempo; il tempo scaturisce dalla risoluzione delle tensioni preindividuali.",
                        methodology: "Confronto tra ontologia fisica e ontologia biologica.",
                        key_sources: ["S01", "D13", "D07"],
                        concepts: "Cronogenesi, Aion, Sintesi Passiva"
                    },
                    {
                        title: "3. Etica del Divenire",
                        goal: "Sviluppare un'etica basata non su norme trascendenti ma sulla capacit√† di 'portare' il preindividuale.",
                        objectives: [
                            "Leggere l'angoscia in Simondon come segnale del preindividuale non risolto.",
                            "Collegare all'Amor Fati deleuziano.",
                            "Proporre un'etica della 'relazione transindividuale'."
                        ],
                        analysis: "L'etica non riguarda il giudizio su azioni compiute da un soggetto stabile, ma la gestione del potenziale di trasformazione. Il soggetto non √® un punto fisso, ma un tragitto. L'angoscia √® la percezione del 'troppo grande' in noi (il preindividuale).",
                        methodology: "Approccio etico-estetico.",
                        key_sources: ["D02", "S03", "D08"],
                        concepts: "Angoscia, Amor Fati, Transindividuale"
                    }
                ]
            },
            B: {
                title: "Strategia B: Tecno-Ecologica (Stiegler/Hui)",
                desc: "L'oggetto tecnico come milieu associato. La crisi ecologica come crisi della razionalit√† tecnica.",
                top_sources: ["S02", "T01", "E01", "T03", "T04"],
                chapters: [
                    {
                        title: "1. L'Oggetto Tecnico",
                        goal: "Ridefinire la tecnica non come strumento ma come modo di esistenza.",
                        objectives: ["Analizzare la genesi dell'oggetto tecnico (S02).", "Discutere la 'concretizzazione'."],
                        analysis: "La macchina non √® un utensile inerte. Ha una sua evoluzione (genesi) che tende verso la concretizzazione (funzionamento organico).",
                        methodology: "Analisi organologica.",
                        key_sources: ["S02", "T10"],
                        concepts: "Concretizzazione, Oggetto Tecnico"
                    },
                    {
                        title: "2. Cosmotecniche",
                        goal: "Superare l'universalismo tecnologico occidentale.",
                        objectives: ["Introdurre il concetto di Cosmotecnica (Hui).", "Confrontare tecniche e cosmologie."],
                        analysis: "Non esiste 'La Tecnica' al singolare, ma diverse cosmotecniche che uniscono ordine morale e cosmico. La modernit√† ha separato queste sfere.",
                        methodology: "Antropologia filosofica.",
                        key_sources: ["T03", "T04"],
                        concepts: "Cosmotecnica, Diversit√†"
                    },
                    {
                        title: "3. Terapia dell'Antropocene",
                        goal: "Proporre pratiche di cura farmacologica.",
                        objectives: ["Leggere il Pharmakon (Stiegler).", "Progettare una 'economia del contributo'."],
                        analysis: "La tecnologia √® sia veleno che cura (Pharmakon). Nell'Antropocene, dobbiamo inventare nuove pratiche di cura (terapie) per evitare la distruzione.",
                        methodology: "Decostruzione e farmacologia.",
                        key_sources: ["T01", "E01"],
                        concepts: "Pharmakon, Negantropia, Cura"
                    }
                ]
            },
            C: {
                title: "Strategia C: Politica (Societ√† del Controllo)",
                desc: "Dal controllo disciplinare alla modulazione algoritmica. Strategie di resistenza.",
                top_sources: ["S03", "D09", "C01"],
                chapters: [
                    {
                        title: "1. Mappare il Controllo",
                        goal: "Tracciare il passaggio da Foucault a Deleuze.",
                        objectives: ["Definire la societ√† disciplinare.", "Analizzare il 'dividuale' e la banche dati."],
                        analysis: "Non siamo pi√π chiusi in fabbriche o scuole (luoghi di reclusione), ma modulati in spazi aperti attraverso debiti, password e dati. L'individuo diventa 'dividuale'.",
                        methodology: "Cartografia politica.",
                        key_sources: ["D09", "S05"],
                        concepts: "Dividuale, Modulazione, Controllo"
                    },
                    {
                        title: "2. Il Transindividuale",
                        goal: "Pensare una politica oltre l'individuo liberale.",
                        objectives: ["Rileggere Simondon in chiave politica.", "Definire il transindividuale come risorsa comune."],
                        analysis: "La politica liberale si basa sull'individuo atomizzato. Il transindividuale √® ci√≤ che lega gli individui attraverso il preindividuale condiviso. √à la base per una nuova politica del comune.",
                        methodology: "Ontologia sociale.",
                        key_sources: ["S03", "C01"],
                        concepts: "Transindividuale, Comune, Relazione"
                    }
                ]
            }
        };

        // --- INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Immagini
            const mainAvatar = document.getElementById('jesse-avatar');
            if (mainAvatar) mainAvatar.src = JESSE_IMG;
            document.querySelectorAll('.jesse-mini-avatar').forEach(img => img.src = JESSE_IMG);

            // Avvio App
            mergeData();
            loadDataFromCloud(); // V5.0 Cloud Sync Init
            initApp();
            initAudio();
        });

        // --- FUNZIONI CORE ---
        function mergeData() {
            const savedProgress = JSON.parse(localStorage.getItem('millino_progress')) || [];
            const savedCustomBooks = JSON.parse(localStorage.getItem('millino_custom_books')) || [];

            let mergedMaster = MASTER_DB.map(m => {
                const s = savedProgress.find(x => x.id === m.id);
                return s ? { ...m, ...s } : { ...m, status: 'todo', notes: '', tags: [] };
            });

            // Combina Custom + Master
            biblioData = [...savedCustomBooks, ...mergedMaster];

            // OLD Saved Data Compat if needed, but COURSES are static now.
            // Still loading progress
            const savedCustomStrategy = localStorage.getItem('custom_roadmap');
            if (savedCustomStrategy) customStrategy = JSON.parse(savedCustomStrategy);
        }

        function saveData() {
            const progress = biblioData.map(b => ({ id: b.id, status: b.status, notes: b.notes, tags: b.tags }));
            localStorage.setItem('millino_progress', JSON.stringify(progress));
            const customBooks = biblioData.filter(b => !MASTER_DB.some(m => m.id === b.id));
            localStorage.setItem('millino_custom_books', JSON.stringify(customBooks));

            // NEW: Persist Pin/Delete/Courses
            localStorage.setItem('millino_pinned', JSON.stringify(pinnedSources));
            localStorage.setItem('millino_deleted', JSON.stringify(deletedSources));
            localStorage.setItem('millino_courses', JSON.stringify(courses));

            // CLOUD SYNC TRIGGER
            syncDataToCloud();
        }

        // --- CLOUD SYNC LOGIC (GITHUB GIST) ---
        async function syncDataToCloud() {
            const token = localStorage.getItem('millino_gh_token');
            const gistId = localStorage.getItem('millino_gist_id');
            if (!token || !gistId) return; // No sync configured

            // Debounce or status check could be added here
            const payload = {
                "millino_db.json": {
                    content: JSON.stringify({
                        progress: JSON.parse(localStorage.getItem('millino_progress') || '[]'),
                        custom_books: JSON.parse(localStorage.getItem('millino_custom_books') || '[]'),
                        pinned: JSON.parse(localStorage.getItem('millino_pinned') || '[]'),
                        deleted: JSON.parse(localStorage.getItem('millino_deleted') || '[]'),
                        courses: JSON.parse(localStorage.getItem('millino_courses') || '[]'),
                        journal: JSON.parse(localStorage.getItem('journal_entries') || '[]'),
                        updated_at: new Date().toISOString()
                    })
                }
            };

            updateCloudStatus('syncing');
            try {
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ files: payload })
                });
                if (res.ok) {
                    updateCloudStatus('success');
                    console.log("‚òÅÔ∏è Cloud Sync Success");
                } else {
                    updateCloudStatus('error');
                    console.error("Cloud Sync Failed", await res.text());
                }
            } catch (e) {
                updateCloudStatus('error');
                console.error("Cloud Sync Error", e);
            }
        }

        async function loadDataFromCloud() {
            const token = localStorage.getItem('millino_gh_token');
            const gistId = localStorage.getItem('millino_gist_id');
            if (!token || !gistId) return;

            updateCloudStatus('syncing');
            try {
                const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (!res.ok) throw new Error("Gist fetch failed");
                const data = await res.json();
                const file = data.files["millino_db.json"];
                if (!file) return;

                const content = JSON.parse(file.content);
                const localUpdate = localStorage.getItem('millino_last_cloud_sync');

                // Simple logic: if cloud is newer than local session start? 
                // Alternatively, just load it if we trust the cloud as master.
                // For this V5.0, let's assume Cloud is Master on Init.

                if (content.updated_at) {
                    console.log("üì• Loading Data from Cloud...", content.updated_at);

                    // Update LocalStorage
                    if (content.progress) localStorage.setItem('millino_progress', JSON.stringify(content.progress));
                    if (content.custom_books) localStorage.setItem('millino_custom_books', JSON.stringify(content.custom_books));
                    if (content.pinned) localStorage.setItem('millino_pinned', JSON.stringify(content.pinned));
                    if (content.deleted) localStorage.setItem('millino_deleted', JSON.stringify(content.deleted));
                    if (content.courses) localStorage.setItem('millino_courses', JSON.stringify(content.courses));
                    if (content.journal) localStorage.setItem('journal_entries', JSON.stringify(content.journal));

                    // Re-Merge & Render
                    mergeData();
                    // Reload globals that might have changed
                    courses = JSON.parse(localStorage.getItem('millino_courses')) || DEFAULT_COURSES;
                    pinnedSources = JSON.parse(localStorage.getItem('millino_pinned')) || [];
                    deletedSources = JSON.parse(localStorage.getItem('millino_deleted')) || [];
                    journalEntries = JSON.parse(localStorage.getItem('journal_entries')) || [];

                    renderDashboard();
                    runSearch();
                    renderJournal();
                    updateCloudStatus('success');
                    showToast("Dati sincronizzati dal Cloud ‚òÅÔ∏è");
                }
            } catch (e) {
                console.error("Load from Cloud Error", e);
                updateCloudStatus('error');
            }
        }

        function updateCloudStatus(status) {
            const el = document.getElementById('cloud-status-icon');
            if (!el) return; // Need to add this to UI
            if (status === 'syncing') el.innerText = "‚òÅÔ∏èüîÑ";
            if (status === 'success') el.innerText = "‚òÅÔ∏è‚úÖ";
            if (status === 'error') el.innerText = "‚òÅÔ∏è‚ùå";
        }

        function saveCloudSettings() {
            const token = document.getElementById('github-token').value.trim();
            const gist = document.getElementById('gist-id').value.trim();
            if (token) localStorage.setItem('millino_gh_token', token);
            if (gist) localStorage.setItem('millino_gist_id', gist);
            if (token && gist) { showToast("Impostazioni Cloud Salvate"); loadDataFromCloud(); }
        }

        function forceReset() {
            showConfirmModal("Vuoi resettare tutto? Questa azione non pu√≤ essere annullata.", () => {
                localStorage.removeItem('millino_progress');
                localStorage.removeItem('millino_custom_books');
                localStorage.removeItem('millino_pinned');
                localStorage.removeItem('millino_deleted');
                localStorage.removeItem('custom_roadmap');
                localStorage.removeItem('millino_courses');
                location.reload();
            });
        }

        // --- DYNAMIC COURSE CRUD & MODULE EDITOR ---
        function switchCourseTab(tab) {
            ['details', 'modules', 'import', 'exam'].forEach(t => {
                const p = document.getElementById('tab-' + t);
                const b = document.getElementById('tab-btn-' + t);
                if (p) p.classList.add('hidden');
                if (b) {
                    b.classList.remove('text-stone-900', 'border-stone-900');
                    b.classList.add('text-stone-400', 'border-transparent');
                }
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            const btn = document.getElementById('tab-btn-' + tab);
            btn.classList.add('text-stone-900', 'border-stone-900');
            btn.classList.remove('text-stone-400', 'border-transparent');

            if (tab === 'modules') renderModuleList();
        }

        function openCourseModal(id = null) {
            editingCourseId = id;
            const modal = document.getElementById('course-modal');
            const titleEl = document.getElementById('modal-course-title');

            // Reset Tab
            switchCourseTab('details');

            if (id) {
                // Edit Text
                const course = courses.find(c => c.id === id);
                titleEl.textContent = "Modifica Corso";
                document.getElementById('edit-course-name').value = course.name;
                document.getElementById('edit-course-prof').value = course.prof;
                document.getElementById('edit-course-date').value = course.date;

                // Load Exam Info
                document.getElementById('edit-course-exam-mode').value = course.exam_info?.mode || 'Oral';
                document.getElementById('edit-course-exam-desc').value = course.exam_info?.description || '';

            } else {
                // New
                titleEl.textContent = "Nuovo Corso";
                document.getElementById('edit-course-name').value = "";
                document.getElementById('edit-course-prof').value = "";
                document.getElementById('edit-course-date').value = "";
                document.getElementById('edit-course-exam-mode').value = "Oral";
                document.getElementById('edit-course-exam-desc').value = "";
            }
            modal.classList.remove('hidden');
        }

        function closeCourseModal() { document.getElementById('course-modal').classList.add('hidden'); }

        function saveCourse() {
            const name = document.getElementById('edit-course-name').value;
            const prof = document.getElementById('edit-course-prof').value;
            const date = document.getElementById('edit-course-date').value;
            const examMode = document.getElementById('edit-course-exam-mode').value;
            const examDesc = document.getElementById('edit-course-exam-desc').value;

            if (!name || !prof) return showToast("Inserisci almeno Nome e Professore!", 'warning');

            const examInfo = { mode: examMode, description: examDesc, tips: "" }; // Tips populated by AI if imported

            if (editingCourseId) {
                // Update
                const c = courses.find(x => x.id === editingCourseId);
                c.name = name; c.prof = prof; c.date = date;
                c.exam_info = { ...c.exam_info, ...examInfo }; // Merge to keep tips if any
            } else {
                // Create
                const newC = {
                    id: "c_" + Date.now(),
                    name: name,
                    prof: prof,
                    date: date,
                    status: 'active',
                    topics: [],
                    exam_info: examInfo
                };
                courses.push(newC);
            }
            saveData();
            closeCourseModal();
            // Refresh
            if (currentCourseId) {
                renderCourseDetail(currentCourseId);
            } else {
                renderDashboard();
            }
            router(currentCourseId ? 'course-detail' : 'dashboard');
        }

        function deleteCourse(id) {
            if (!confirm("Eliminare definitivamente questo corso?")) return;
            courses = courses.filter(c => c.id !== id);
            saveData();
            currentCourseId = null;
            renderDashboard();
            router('dashboard');
        }

        // --- MODULE EDITOR & PICKER LOGIC ---
        let currentEditingModuleIndex = -1;

        function renderModuleList() {
            const list = document.getElementById('modal-modules-list');

            if (!editingCourseId) {
                list.innerHTML = `<div class="text-center text-stone-400 text-xs py-8 italic border border-dashed border-stone-200 rounded-xl">üíæ Salva il corso prima di aggiungere moduli.</div>`;
                return;
            }

            const course = courses.find(c => c.id === editingCourseId);
            if (!course.topics) course.topics = [];

            if (course.topics.length === 0) {
                list.innerHTML = `<div class="text-center text-stone-400 text-xs py-4">Nessun modulo. Aggiungine uno!</div>`;
            } else {
                list.innerHTML = course.topics.map((t, idx) => `
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 flex justify-between items-center group mb-2 hover:border-stone-300 transition-colors">
                        <div>
                            <div class="font-bold text-sm text-stone-800">${t.title}</div>
                            <div class="text-[10px] text-stone-500 truncate max-w-[200px]">${t.goal || 'Nessun obiettivo'}</div>
                            <div class="text-[9px] text-rose-500 font-mono mt-1 font-bold uppercase tracking-wider">${(t.texts || []).length} FONTI</div>
                        </div>
                        <div class="flex gap-2 opacity-100">
                             <button onclick="editModule(${idx})" class="text-xs text-stone-600 hover:text-stone-900 text-[10px] px-2 py-1 rounded bg-white border border-stone-200 shadow-sm font-bold">MODIFICA</button>
                             <button onclick="deleteModule(${idx})" class="text-xs text-red-400 hover:text-red-600 px-2 py-1 text-[10px] rounded bg-white border border-stone-200 shadow-sm font-bold">√ó</button>
                        </div>
                    </div>
                `).join('');
            }

            // Add "Add Module" button
            list.innerHTML += `
                <button onclick="editModule(-1)" class="w-full py-3 border-2 border-dashed border-stone-300 rounded-lg text-stone-400 text-xs font-bold uppercase hover:bg-stone-50 hover:text-stone-600 transition-colors mt-2">
                    + Aggiungi Modulo
                </button>
            `;
        }

        function editModule(idx) {
            currentEditingModuleIndex = idx;
            const modal = document.getElementById('module-editor-overlay');
            const course = courses.find(c => c.id === editingCourseId);

            if (idx >= 0) {
                const topic = course.topics[idx];
                document.getElementById('mod-editor-title').value = topic.title;
                document.getElementById('mod-editor-goal').value = topic.goal;
                renderModuleSources(topic.texts || []);
            } else {
                document.getElementById('mod-editor-title').value = "";
                document.getElementById('mod-editor-goal').value = "";
                renderModuleSources([]);
            }
            modal.classList.remove('hidden');
        }

        function closeModuleEditor() {
            document.getElementById('module-editor-overlay').classList.add('hidden');
            document.getElementById('source-picker-dropdown').classList.add('hidden');
        }

        function saveModule() {
            const title = document.getElementById('mod-editor-title').value;
            const goal = document.getElementById('mod-editor-goal').value;
            const sourceIds = Array.from(document.querySelectorAll('#mod-sources-list .source-chip')).map(el => el.dataset.id);

            if (!title) return showToast("Inserisci un titolo.", 'warning');

            const course = courses.find(c => c.id === editingCourseId);
            const newModule = { title, goal, texts: sourceIds, matchTags: [] };

            if (currentEditingModuleIndex >= 0) {
                course.topics[currentEditingModuleIndex] = newModule;
            } else {
                course.topics.push(newModule);
            }

            saveData();
            renderModuleList();
            closeModuleEditor();
        }

        function deleteModule(idx) {
            if (!confirm("Eliminare questo modulo?")) return;
            const course = courses.find(c => c.id === editingCourseId);
            course.topics.splice(idx, 1);
            saveData();
            renderModuleList();
        }

        function renderModuleSources(sourceIds) {
            const container = document.getElementById('mod-sources-list');
            if (sourceIds.length === 0) {
                container.innerHTML = '<span class="text-[10px] text-stone-400 italic p-2">Nessuna fonte assegnata.</span>';
                return;
            }
            container.innerHTML = sourceIds.map(id => {
                const book = biblioData.find(b => b.id === id);
                if (!book) return '';
                return `<div class="source-chip bg-white border border-stone-200 rounded-full px-3 py-1 text-[10px] flex items-center gap-2 shadow-sm" data-id="${id}">
                    <span class="font-bold truncate max-w-[100px]">${book.author}</span>
                    <button onclick="this.parentElement.remove()" class="text-rose-500 hover:text-rose-700 font-bold bg-rose-50 rounded-full w-4 h-4 flex items-center justify-center">√ó</button>
                </div>`;
            }).join('');
        }

        function openSourcePicker() {
            const picker = document.getElementById('source-picker-dropdown');
            if (!picker.classList.contains('hidden')) {
                picker.classList.add('hidden');
                return;
            }

            picker.classList.remove('hidden');
            const list = document.getElementById('source-picker-list');
            list.innerHTML = biblioData.slice(0, 50).map(b => `
                <div onclick="addSourceToModule('${b.id}')" class="p-3 hover:bg-stone-50 cursor-pointer text-xs flex justify-between items-center group">
                    <div class="truncate pr-2">
                        <strong class="text-stone-800">${b.author}</strong> <span class="text-stone-500">- ${b.title}</span>
                    </div>
                    <span class="text-rose-500 text-[10px] uppercase font-bold opacity-0 group-hover:opacity-100">+ AGGIUNGI</span>
                </div>
            `).join('');
        }

        function addSourceToModule(id) {
            const currentIds = Array.from(document.querySelectorAll('#mod-sources-list .source-chip')).map(el => el.dataset.id);
            if (currentIds.includes(id)) return;

            // If empty msg exists, remove it
            const container = document.getElementById('mod-sources-list');
            if (container.querySelector('span')) container.innerHTML = '';

            const book = biblioData.find(b => b.id === id);
            container.innerHTML += `<div class="source-chip bg-white border border-stone-200 rounded-full px-3 py-1 text-[10px] flex items-center gap-2 shadow-sm" data-id="${id}">
                    <span class="font-bold truncate max-w-[100px]">${book.author}</span>
                    <button onclick="this.parentElement.remove()" class="text-rose-500 hover:text-rose-700 font-bold bg-rose-50 rounded-full w-4 h-4 flex items-center justify-center">√ó</button>
                </div>`;

            document.getElementById('source-picker-dropdown').classList.add('hidden');
        }

        // --- AI SYLLABUS IMPORTER ---
        async function runSyllabusImport() {
            let text = document.getElementById('import-text').value.trim();
            if (!text) return showToast("Incolla qualcosa (Testo o URL)!", 'warning');

            const loader = document.getElementById('import-loader');
            loader.classList.remove('hidden');

            // --- JINA READER INTEGRATION (URL SUPPORT) ---
            if (text.startsWith('http://') || text.startsWith('https://')) {
                const btn = document.querySelector('[onclick="runSyllabusImport()"]');
                const originalBtnText = btn.innerHTML;
                btn.innerHTML = "<span>üåç</span> Scarico Syllabus...";

                try {
                    const jinaUrl = `https://r.jina.ai/${text}`;
                    const res = await fetch(jinaUrl);
                    if (!res.ok) throw new Error("Jina Reader fallito");
                    const pageText = await res.text();

                    if (pageText.length < 50) throw new Error("Contenuto troppo breve");

                    text = `SOURCE URL: ${text}\n\nCONTENT:\n${pageText}`;
                    showToast("Pagina scaricata con successo! üìÑ");
                } catch (e) {
                    showToast("Impossibile leggere il link. Incolla il testo manualmente.", 'error');
                    loader.classList.add('hidden');
                    btn.innerHTML = originalBtnText;
                    return;
                } finally {
                    btn.innerHTML = originalBtnText;
                }
            }

            // Get current bibliography for context
            const materialsContext = biblioData.slice(0, 30).map(b => `${b.author} - ${b.title}`).join('\n');

            const systemPrompt = `
            ROLE: You are an Academic Syllabus Parser with INTELLIGENT MATERIAL LINKING.
            TASK: Extract structured course modules and exam details from the provided text.
            
            CRITICAL: You MUST LINK TOPICS TO MATERIALS.
            For every Topic you find, analyze the Bibliography provided. 
            - If a Topic mentions a specific author or chapter, create an EXPLICIT link.
            - If no link is explicit, use your knowledge to GUESS the most likely book from the list. If uncertain, strictly prefix the title with '‚ö†Ô∏è [PROBABLE]' to warn the user. 
            - Output the material reference in format "Author - Title (Chapter/Section if applicable)"
            
            AVAILABLE MATERIALS (from user's bibliography):
            ${materialsContext || 'No materials loaded yet'}
            
            OUTPUT: Valid JSON only.
            FORMAT:
            {
                "topics": [ 
                    { 
                        "title": "Module Title", 
                        "goal": "Description/Objectives",
                        "related_material": ["Author - Title (Ch. X)", "Author2 - Title"]
                    } 
                ],
                "exam_info": { "mode": "Oral", "description": "Details about exam", "tips": "One strategic tip for the student" }
            }
            NOTES: 
            - 'mode' must be one of: 'Oral', 'Written', 'Project', 'Mixed'.
            - Translate content to ITALIAN.
            - "related_material" MUST be an array of strings referencing materials from the bibliography above.
            `;

            try {
                // TRY OPENROUTER FIRST (Best for parsing)
                let apiKey = localStorage.getItem('millino_openrouter_key');
                let endpoint = "https://openrouter.ai/api/v1/chat/completions";
                let model = "deepseek/deepseek-v3.2"; // or qwen/qwen-turbo
                let extraHeaders = {
                    'HTTP-Referer': 'https://millino-fagiolino.github.io',
                    'X-Title': 'Millino Fagiolino'
                };

                // Fallback to OpenAI if no OpenRouter key
                if (!apiKey) {
                    apiKey = localStorage.getItem('millino_openai_key');
                    if (!apiKey) throw new Error("Manca la chiave API (OpenRouter o OpenAI). Configurala nelle impostazioni.");
                    endpoint = "https://api.openai.com/v1/chat/completions";
                    model = "gpt-4o-mini";
                    extraHeaders = {};
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        ...extraHeaders
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text.slice(0, 15000) }
                        ],
                        temperature: 0.2
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Errore API");
                }

                const apiData = await response.json();
                const raw = apiData.choices?.[0]?.message?.content || "{}";

                // Flexible JSON Parsing
                let result;
                try {
                    result = JSON.parse(raw);
                } catch (e) {
                    // Strip markdown blocks if present
                    const cleanRaw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                    try {
                        result = JSON.parse(cleanRaw);
                    } catch (e2) {
                        const jsonMatch = cleanRaw.match(/\{[\s\S]*\}/);
                        if (jsonMatch) result = JSON.parse(jsonMatch[0]);
                        else throw new Error("Impossibile leggere il JSON dell'AI.");
                    }
                }

                if (editingCourseId) {
                    const c = courses.find(x => x.id === editingCourseId);

                    // Merge Topics
                    if (result.topics && Array.isArray(result.topics)) {
                        c.topics = result.topics.map(t => ({ ...t, texts: [] }));
                    }

                    // Merge Exam Info
                    if (result.exam_info) {
                        c.exam_info = {
                            mode: getBestModeMatch(result.exam_info.mode),
                            description: result.exam_info.description || '',
                            tips: result.exam_info.tips || ''
                        };
                    }

                    saveData();

                    // Update UI inputs immediately
                    if (document.getElementById('edit-course-exam-mode')) {
                        document.getElementById('edit-course-exam-mode').value = c.exam_info.mode;
                        document.getElementById('edit-course-exam-desc').value = c.exam_info.description;
                    }

                    showToast("‚úÖ Syllabus importato con successo!", 'success');
                    renderModuleList(); // Refresh modules list view
                    // Force switch to modules tab to show results
                    switchCourseTab('modules');

                } else {
                    showToast("‚ö†Ô∏è Salva il corso prima di vedere i moduli importati.", 'warning');
                }

            } catch (e) {
                showToast("Errore importazione: " + e.message, 'error');
                console.error(e);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function getBestModeMatch(val) {
            if (!val) return 'Oral';
            const v = val.toLowerCase();
            if (v.includes('writ') || v.includes('scritt')) return 'Written';
            if (v.includes('proj') || v.includes('proget')) return 'Project';
            if (v.includes('mix')) return 'Mixed';
            return 'Oral';
        }

        // --- V6.0 EXAM MODE FUNCTIONS ---
        // Storage for exam PDFs and questions per course
        let examQuestionBank = JSON.parse(localStorage.getItem('millino_exam_bank') || '{}');

        async function handleExamPdfUpload(files) {
            if (!files || files.length === 0) return;
            if (!editingCourseId) return showToast('Salva prima il corso!', 'warning');

            const loader = document.getElementById('exam-pdf-count');
            const listEl = document.getElementById('exam-pdf-list');

            // Initialize course bank if not exists
            if (!examQuestionBank[editingCourseId]) {
                examQuestionBank[editingCourseId] = { pdfs: [], questions: [] };
            }

            showToast('Elaborazione PDF in corso...', 'info');

            for (const file of files) {
                try {
                    // Extract text using PDF.js
                    const text = await extractPdfText(file);

                    // Store PDF metadata
                    examQuestionBank[editingCourseId].pdfs.push({
                        name: file.name,
                        date: new Date().toISOString(),
                        text: text.slice(0, 50000) // Limit storage
                    });

                    // Extract questions from text using simple heuristics
                    const extractedQuestions = extractQuestionsFromText(text);
                    examQuestionBank[editingCourseId].questions.push(...extractedQuestions);

                } catch (e) {
                    console.error('PDF extraction error:', e);
                    showToast(`Errore con ${file.name}: ${e.message}`, 'error');
                }
            }

            // Save to localStorage
            localStorage.setItem('millino_exam_bank', JSON.stringify(examQuestionBank));

            // Update UI
            updateExamTabUI();
            showToast(`${files.length} PDF elaborati con successo!`, 'success');
        }

        async function extractPdfText(file) {
            // Check if PDF.js is loaded
            if (typeof pdfjsLib === 'undefined') {
                throw new Error('PDF.js non caricato. Ricarica la pagina.');
            }

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }

            return fullText;
        }

        function extractQuestionsFromText(text) {
            const questions = [];

            // Simple regex patterns to find questions
            const patterns = [
                /(?:^|\n)(?:\d+[\.\)\:]|[\u2022\-\*])\s*(.{20,200}\?)/gm, // Numbered or bulleted questions
                /(?:^|\n)(?:Domanda|Question|Quesito|Esercizio)[^:]*:\s*(.{20,300})/gi, // Labeled questions
                /(?:^|\n)(.{30,200}\?)/gm // Any sentence ending with ?
            ];

            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const q = match[1].trim();
                    if (q.length > 15 && !questions.some(existing => existing.text === q)) {
                        questions.push({
                            text: q,
                            source: 'pdf_extract',
                            timestamp: Date.now()
                        });
                    }
                }
            });

            return questions.slice(0, 50); // Limit to 50 questions per PDF
        }

        function updateExamTabUI() {
            if (!editingCourseId) return;

            const bank = examQuestionBank[editingCourseId] || { pdfs: [], questions: [] };

            // Update PDF count
            const pdfCountEl = document.getElementById('exam-pdf-count');
            if (pdfCountEl) pdfCountEl.textContent = `${bank.pdfs.length} PDF caricati`;

            // Update PDF list
            const listEl = document.getElementById('exam-pdf-list');
            if (listEl && bank.pdfs.length > 0) {
                listEl.innerHTML = bank.pdfs.map((pdf, i) => `
                    <div class="flex items-center justify-between bg-stone-50 rounded-lg px-3 py-2 text-xs">
                        <span class="text-stone-700 font-medium truncate max-w-[180px]">üìÑ ${pdf.name}</span>
                        <button onclick="removeExamPdf(${i})" class="text-rose-500 hover:text-rose-700 font-bold">‚úï</button>
                    </div>
                `).join('');
            }

            // Update question count
            const qCountEl = document.getElementById('exam-question-count');
            if (qCountEl) qCountEl.textContent = `${bank.questions.length} domande`;

            // Update questions preview
            const previewEl = document.getElementById('exam-questions-preview');
            if (previewEl && bank.questions.length > 0) {
                previewEl.innerHTML = bank.questions.slice(0, 5).map(q => `
                    <div class="bg-stone-50 rounded-lg p-2 text-[11px] text-stone-700">
                        ${q.text.slice(0, 80)}${q.text.length > 80 ? '...' : ''}
                    </div>
                `).join('') + (bank.questions.length > 5 ? `<div class="text-center text-stone-400 text-[10px]">...e altre ${bank.questions.length - 5} domande</div>` : '');
            }
        }

        function removeExamPdf(index) {
            if (!editingCourseId || !examQuestionBank[editingCourseId]) return;

            examQuestionBank[editingCourseId].pdfs.splice(index, 1);
            localStorage.setItem('millino_exam_bank', JSON.stringify(examQuestionBank));
            updateExamTabUI();
            showToast('PDF rimosso', 'info');
        }

        async function runExamSimulation(mode) {
            if (!editingCourseId) return showToast('Apri un corso prima!', 'warning');

            const outputEl = document.getElementById('exam-simulation-output');
            const displayEl = document.getElementById('exam-question-display');
            outputEl.classList.remove('hidden');

            if (mode === 'random') {
                // Random pick from question bank
                const bank = examQuestionBank[editingCourseId];
                if (!bank || bank.questions.length === 0) {
                    displayEl.innerHTML = '<p class="text-amber-400">‚ö†Ô∏è Nessuna domanda nella banca. Carica dei PDF prima!</p>';
                    return;
                }

                const randomQuestions = bank.questions
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 5);

                displayEl.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-[10px] uppercase tracking-wider text-amber-400 font-bold mb-3">üé≤ Domande Casuali</div>
                        ${randomQuestions.map((q, i) => `
                            <div class="bg-stone-800 rounded-lg p-3">
                                <div class="text-[10px] text-amber-400 font-bold mb-1">Domanda ${i + 1}</div>
                                <div class="text-sm text-white leading-relaxed">${q.text}</div>
                            </div>
                        `).join('')}
                    </div>
                `;

            } else if (mode === 'ai') {
                // AI-generated questions
                displayEl.innerHTML = '<div class="animate-pulse text-rose-400 text-center py-8">ü§ñ Generazione domande con DeepSeek...</div>';

                try {
                    const course = courses.find(c => c.id === editingCourseId);
                    const modules = course?.modules || [];
                    const examInfo = course?.exam_info || {};

                    const context = `
                        Corso: ${course?.name}
                        Moduli: ${modules.map(m => m.title).join(', ')}
                        Tipo Esame: ${examInfo.mode || 'Orale'}
                        Descrizione Esame: ${examInfo.description || 'N/A'}
                    `;

                    const apiKey = localStorage.getItem('millino_openai_key');
                    if (!apiKey) throw new Error('Manca chiave API');

                    const res = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [
                                { role: 'system', content: 'Sei un professore universitario che prepara domande d\'esame. Genera 5 domande realistiche e impegnative per testare la preparazione dello studente. Rispondi SOLO con le domande numerate, senza introduzioni.' },
                                { role: 'user', content: `Genera 5 domande d'esame per questo corso:\n${context}` }
                            ],
                            temperature: 0.8
                        })
                    });

                    if (!res.ok) throw new Error('API error');
                    const data = await res.json();
                    const questions = data.choices[0].message.content;

                    displayEl.innerHTML = `
                        <div class="space-y-4">
                            <div class="text-[10px] uppercase tracking-wider text-rose-400 font-bold mb-3">ü§ñ Domande Generate da AI</div>
                            <div class="bg-stone-800 rounded-lg p-4 text-sm text-white leading-relaxed whitespace-pre-line">${questions}</div>
                        </div>
                    `;

                } catch (e) {
                    displayEl.innerHTML = `<p class="text-rose-400">‚ùå Errore: ${e.message}</p>`;
                }
            }
        }

        function closeExamSimulation() {
            document.getElementById('exam-simulation-output').classList.add('hidden');
        }

        // ============================================================
        // CITATION MANAGER 2.0: THE DETERMINISTIC ENGINE
        // ============================================================

        const CitationEngine = {
            // State
            currentSort: 'alpha',
            customStyleTemplate: localStorage.getItem('millino_custom_citation_style') || null,

            // --- AUTHOR PARSING (Deterministic) ---
            parseAuthor(authorStr, style) {
                if (!authorStr) return '';

                // Handle "et al." or multiple authors separated by ","
                const authors = authorStr.split(/[,;&]/).map(a => a.trim()).filter(a => a && a !== 'et al.');

                return authors.map((author, idx) => {
                    // Try to split "FirstName LastName" or "LastName, FirstName"
                    let first = '', last = '';

                    if (author.includes(',')) {
                        // Already "Lastname, Firstname"
                        const parts = author.split(',').map(p => p.trim());
                        last = parts[0];
                        first = parts[1] || '';
                    } else {
                        // "Firstname Lastname" format
                        const parts = author.trim().split(/\s+/);
                        if (parts.length === 1) {
                            last = parts[0];
                        } else {
                            last = parts.pop();
                            first = parts.join(' ');
                        }
                    }

                    const initial = first ? first.charAt(0).toUpperCase() + '.' : '';

                    switch (style) {
                        case 'apa7':
                            return `${last}, ${initial}`.trim().replace(/, $/, '');
                        case 'mla9':
                            return idx === 0 ? `${last}, ${first}` : `${first} ${last}`;
                        case 'chicago':
                            return idx === 0 ? `${last}, ${first}` : `${first} ${last}`;
                        case 'harvard':
                            return `${last}, ${initial}`.trim().replace(/, $/, '');
                        case 'ieee':
                            return `${initial} ${last}`.trim();
                        default:
                            return `${last}, ${initial}`.trim();
                    }
                }).join(style === 'ieee' ? ', ' : ', ');
            },

            // --- NORMALIZE DATA (Handle Missing Fields) ---
            normalize(book) {
                return {
                    author: book.author || 'Unknown Author',
                    title: book.title || 'Untitled',
                    year: book.year || 'n.d.',
                    publisher: book.pub || book.publisher || '',
                    city: book.city || '',
                    doi: book.doi || book.url || '',
                    id: book.id
                };
            },

            // --- DETERMINISTIC FORMATTERS ---
            formatAPA7(book) {
                const b = this.normalize(book);
                const author = this.parseAuthor(b.author, 'apa7');
                // APA 7: Author (Year). *Title*. Publisher.
                let citation = `${author} (${b.year}). *${b.title}*.`;
                if (b.publisher) citation += ` ${b.publisher}.`;
                if (b.doi) citation += ` ${b.doi}`;
                return citation.trim();
            },

            formatMLA9(book) {
                const b = this.normalize(book);
                const author = this.parseAuthor(b.author, 'mla9');
                // MLA 9: Author. *Title*. Publisher, Year.
                let citation = `${author}. *${b.title}*.`;
                const pubParts = [b.publisher, b.year].filter(Boolean);
                if (pubParts.length) citation += ` ${pubParts.join(', ')}.`;
                return citation.trim();
            },

            formatChicago(book) {
                const b = this.normalize(book);
                const author = this.parseAuthor(b.author, 'chicago');
                // Chicago: Author. *Title*. City: Publisher, Year.
                let citation = `${author}. *${b.title}*.`;
                const locParts = [];
                if (b.city) locParts.push(b.city);
                if (b.publisher) locParts.push(b.publisher);
                if (locParts.length) {
                    citation += ` ${locParts.join(': ')}`;
                    if (b.year) citation += `, ${b.year}`;
                    citation += '.';
                } else if (b.year) {
                    citation += ` ${b.year}.`;
                }
                return citation.trim();
            },

            formatHarvard(book) {
                const b = this.normalize(book);
                const author = this.parseAuthor(b.author, 'harvard');
                // Harvard: Author, (Year). *Title*. City: Publisher.
                let citation = `${author}, (${b.year}). *${b.title}*.`;
                const locParts = [];
                if (b.city) locParts.push(b.city);
                if (b.publisher) locParts.push(b.publisher);
                if (locParts.length) citation += ` ${locParts.join(': ')}.`;
                return citation.trim();
            },

            formatIEEE(book) {
                const b = this.normalize(book);
                const author = this.parseAuthor(b.author, 'ieee');
                // IEEE: Author, *Title*. Publisher, Year.
                let citation = `${author}, *${b.title}*.`;
                const pubParts = [b.publisher, b.year].filter(Boolean);
                if (pubParts.length) citation += ` ${pubParts.join(', ')}.`;
                return citation.trim();
            },

            formatCustom(book) {
                if (!this.customStyleTemplate) return this.formatAPA7(book);

                const b = this.normalize(book);
                let output = this.customStyleTemplate;

                // Replace placeholders
                const lastName = b.author.split(/[,\s]+/).pop() || '';
                const firstInitial = b.author.charAt(0).toUpperCase() + '.';

                output = output.replace(/{SURNAME}/gi, lastName);
                output = output.replace(/{INITIAL}/gi, firstInitial);
                output = output.replace(/{AUTHOR}/gi, b.author);
                output = output.replace(/{YEAR}/gi, b.year);
                output = output.replace(/{TITLE}/gi, b.title);
                output = output.replace(/{PUBLISHER}/gi, b.publisher);
                output = output.replace(/{CITY}/gi, b.city);
                output = output.replace(/{DOI}/gi, b.doi);

                // Clean up empty placeholders and trailing punctuation
                output = output.replace(/\s*[,:;]+\s*(?=[,:;.\s]*$)/g, '');
                output = output.replace(/\s+/g, ' ').trim();

                return output;
            },

            // --- MAIN FORMAT DISPATCHER ---
            format(book, style = null) {
                const selectedStyle = style || document.getElementById('citation-style-select')?.value || 'apa7';

                switch (selectedStyle) {
                    case 'apa7': return this.formatAPA7(book);
                    case 'mla9': return this.formatMLA9(book);
                    case 'chicago': return this.formatChicago(book);
                    case 'harvard': return this.formatHarvard(book);
                    case 'ieee': return this.formatIEEE(book);
                    case 'custom': return this.formatCustom(book);
                    default: return this.formatAPA7(book);
                }
            },

            // --- SORTING ---
            sort(criteria) {
                this.currentSort = criteria;

                // Update button states
                ['alpha', 'year', 'added'].forEach(c => {
                    const btn = document.getElementById(`sort-${c}-btn`);
                    if (btn) {
                        btn.classList.toggle('bg-stone-900', c === criteria);
                        btn.classList.toggle('text-white', c === criteria);
                        btn.classList.toggle('bg-white', c !== criteria);
                        btn.classList.toggle('text-stone-600', c !== criteria);
                    }
                });

                this.render();
            },

            getSortedSources() {
                let sources = [...biblioData].filter(b => !deletedSources.includes(b.id));

                // Apply search filter
                const searchTerm = document.getElementById('citation-search-input')?.value?.toLowerCase() || '';
                if (searchTerm) {
                    sources = sources.filter(b =>
                        b.author?.toLowerCase().includes(searchTerm) ||
                        b.title?.toLowerCase().includes(searchTerm)
                    );
                }

                // Helper: Get sorting key with fallback logic
                const getSortKey = (book) => {
                    if (book.author && book.author.trim()) {
                        // Extract surname: handle "Lastname, Firstname" or "Firstname Lastname" formats
                        const author = book.author.trim();
                        if (author.includes(',')) {
                            return author.split(',')[0].trim(); // "Lastname, First" ‚Üí "Lastname"
                        } else {
                            const parts = author.split(/\s+/);
                            return parts.length > 1 ? parts[parts.length - 1] : parts[0]; // Last word = surname
                        }
                    } else if (book.title && book.title.trim()) {
                        return book.title.trim(); // Fallback to title
                    }
                    return 'ZZZZZ'; // Push entries with nothing to end
                };

                // Apply sorting
                switch (this.currentSort) {
                    case 'alpha':
                        sources.sort((a, b) => {
                            const keyA = getSortKey(a);
                            const keyB = getSortKey(b);
                            // Robust comparison: locale-aware, case-insensitive, handles accents
                            return keyA.localeCompare(keyB, 'it', { sensitivity: 'base', ignorePunctuation: true });
                        });
                        break;
                    case 'year':
                        sources.sort((a, b) => {
                            const yearA = parseInt(a.year) || 0;
                            const yearB = parseInt(b.year) || 0;
                            return yearB - yearA; // Descending
                        });
                        break;
                    case 'added':
                        // Assumes later IDs = newer entries
                        sources.reverse();
                        break;
                }

                return sources;
            },

            // --- RENDER ---
            render() {
                const container = document.getElementById('citation-list-container');
                const countEl = document.getElementById('citation-count');

                if (!container) return; // Safety: stop if container doesn't exist

                const sources = this.getSortedSources();
                if (countEl) countEl.textContent = sources.length;

                if (sources.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-stone-400 py-12">
                            <div class="text-4xl mb-3">üìö</div>
                            <p class="text-sm">No sources found</p>
                            <p class="text-xs mt-1">Add sources using the Manual Add button</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = sources.map((book, idx) => {
                    const citation = this.format(book);
                    // Convert markdown italics to HTML
                    const htmlCitation = citation.replace(/\*([^*]+)\*/g, '<em>$1</em>');

                    return `
                        <div class="group flex items-start gap-3 p-3 rounded-lg border border-transparent hover:border-stone-200 hover:bg-stone-50 transition-all duration-300" data-id="${book.id}">
                            <span class="text-[10px] font-mono text-stone-400 pt-1 w-6">${idx + 1}.</span>
                            <div class="flex-1 text-sm text-stone-700 leading-relaxed font-serif">
                                ${htmlCitation}
                            </div>
                            <button onclick="CitationEngine.copySingle('${book.id}')" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity text-stone-400 hover:text-stone-600 p-1.5 rounded hover:bg-stone-100">
                                üìã
                            </button>
                        </div>
                    `;
                }).join('');
            },

            // --- COPY FUNCTIONS ---
            copySingle(id) {
                const book = biblioData.find(b => b.id === id);
                if (!book) return;

                const citation = this.format(book).replace(/\*/g, ''); // Remove markdown for plain text
                navigator.clipboard.writeText(citation);
                showToast('Citation copied!', 'success');
            },

            copyAll() {
                const sources = this.getSortedSources();
                const citations = sources.map(b => this.format(b).replace(/\*/g, '')).join('\n\n');
                navigator.clipboard.writeText(citations);
                showToast(`Copied ${sources.length} citations!`, 'success');
            },

            // --- CUSTOM STYLE ---
            setCustomStyle(template, name = 'Custom') {
                this.customStyleTemplate = template;
                localStorage.setItem('millino_custom_citation_style', template);
                localStorage.setItem('millino_custom_citation_name', name);

                // Show custom option in dropdown
                const customOpt = document.getElementById('custom-style-option');
                if (customOpt) {
                    customOpt.classList.remove('hidden');
                    customOpt.textContent = `üîß ${name}`;
                }

                // Select custom style
                const select = document.getElementById('citation-style-select');
                if (select) select.value = 'custom';

                // Show footer
                const footer = document.getElementById('custom-style-footer');
                if (footer) {
                    footer.classList.remove('hidden');
                    document.getElementById('custom-style-name').textContent = template.slice(0, 50) + '...';
                }

                this.render();
            },

            clearCustomStyle() {
                this.customStyleTemplate = null;
                localStorage.removeItem('millino_custom_citation_style');
                localStorage.removeItem('millino_custom_citation_name');

                // Hide custom option
                const customOpt = document.getElementById('custom-style-option');
                if (customOpt) customOpt.classList.add('hidden');

                // Reset dropdown
                const select = document.getElementById('citation-style-select');
                if (select) select.value = 'apa7';

                // Hide footer
                const footer = document.getElementById('custom-style-footer');
                if (footer) footer.classList.add('hidden');

                this.render();
                showToast('Custom style cleared', 'info');
            },

            // --- INIT ---
            init() {
                // Check for existing custom style
                if (this.customStyleTemplate) {
                    const name = localStorage.getItem('millino_custom_citation_name') || 'Custom';
                    const customOpt = document.getElementById('custom-style-option');
                    if (customOpt) {
                        customOpt.classList.remove('hidden');
                        customOpt.textContent = `üîß ${name}`;
                    }
                }

                this.render();
            }
        };

        // --- MANUAL SOURCE MODAL FUNCTIONS ---
        function openManualSourceModal() {
            document.getElementById('manual-src-title').value = '';
            document.getElementById('manual-src-author').value = '';
            document.getElementById('manual-src-year').value = '';
            document.getElementById('manual-src-publisher').value = '';
            document.getElementById('manual-src-city').value = '';
            document.getElementById('manual-src-doi').value = '';
            document.getElementById('manual-source-modal').classList.remove('hidden');
        }

        function closeManualSourceModal() {
            document.getElementById('manual-source-modal').classList.add('hidden');
        }

        function addManualSource() {
            const title = document.getElementById('manual-src-title').value.trim();
            const author = document.getElementById('manual-src-author').value.trim();
            const year = document.getElementById('manual-src-year').value.trim();
            const publisher = document.getElementById('manual-src-publisher').value.trim();
            const city = document.getElementById('manual-src-city').value.trim();
            const doi = document.getElementById('manual-src-doi').value.trim();

            if (!title || !author || !year) {
                return showToast('Title, Author, and Year are required!', 'warning');
            }

            const newId = 'M' + Date.now().toString().slice(-6);
            const newBook = {
                id: newId,
                author: author,
                title: title,
                year: year,
                pub: publisher,
                city: city,
                doi: doi,
                cat: 'User Added',
                status: 'todo',
                notes: '',
                tags: []
            };

            biblioData.unshift(newBook);

            // Save to localStorage
            const customBooks = biblioData.filter(b => b.cat === 'User Added');
            localStorage.setItem('millino_custom_books', JSON.stringify(customBooks));

            closeManualSourceModal();
            CitationEngine.render();
            runSearch();
            showToast('Source added successfully!', 'success');
        }

        // --- COPY ALL CITATIONS ---
        function copyAllCitations() {
            CitationEngine.copyAll();
        }

        // --- PARSE CUSTOM STYLE PDF (DeepSeek Integration) ---
        async function parseCustomStylePDF(file) {
            if (!file) return;

            showToast('Analyzing style guide...', 'info');

            try {
                // Extract text using PDF.js
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js not loaded');
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) { // First 5 pages only
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                if (fullText.length < 100) {
                    throw new Error('Not enough text extracted from PDF');
                }

                // Send to DeepSeek for analysis
                const apiKey = localStorage.getItem('millino_openai_key');
                if (!apiKey) throw new Error('API key not configured');

                const res = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a citation style analyzer. Analyze the given text which describes a bibliographic style guide.
                                
Return ONLY a template string using these placeholders:
- {SURNAME} = Author's last name
- {INITIAL} = Author's first initial with period
- {AUTHOR} = Full author name
- {YEAR} = Publication year
- {TITLE} = Work title
- {PUBLISHER} = Publisher name
- {CITY} = Publication city
- {DOI} = DOI or URL

Example output: "{SURNAME}, {INITIAL} ({YEAR}). {TITLE}. {CITY}: {PUBLISHER}."

Respond with ONLY the template string, nothing else.`
                            },
                            {
                                role: 'user',
                                content: `Analyze this citation style guide and extract the format template:\n\n${fullText.slice(0, 3000)}`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 200
                    })
                });

                if (!res.ok) throw new Error('API request failed');

                const data = await res.json();
                const template = data.choices[0].message.content.trim();

                // Validate template has at least some placeholders
                if (!template.includes('{') || !template.includes('}')) {
                    throw new Error('Could not extract valid format template');
                }

                CitationEngine.setCustomStyle(template, file.name.replace('.pdf', ''));
                showToast('Custom style extracted successfully!', 'success');

            } catch (e) {
                console.error('Style PDF parsing error:', e);
                showToast(`Error: ${e.message}`, 'error');
            }

            // Reset file input
            document.getElementById('style-pdf-upload').value = '';
        }

        // Initialize CitationEngine when view is shown
        const originalSwitchView = typeof switchView === 'function' ? switchView : null;
        window.switchView = function (view) {
            if (originalSwitchView) originalSwitchView(view);
            if (view === 'citations') {
                setTimeout(() => CitationEngine.init(), 100);
            }
        };

        // IMPLEMENTATION: Global Callback for Squad Engine
        window.receiveBookData = function (data) {
            const newId = "AUTO_" + Date.now();

            // v6.0: Save Squad output to SEPARATE squadAnalysis property (NOT notes)
            const newBook = {
                id: newId,
                author: data.author || "Unknown Author",
                title: data.title || "Untitled Document",
                year: data.year || new Date().getFullYear().toString(),
                pub: data.pub || "Squad Engine Ingest",
                cat: "User Added",
                status: "todo",
                notes: "", // Empty - no more dumping analysis here
                tags: ["AI_SQUAD", ...(data.quotes || []).map(q => q.tag?.replace('#', '') || '')],
                subject: currentCourseId ? courses.find(c => c.id === currentCourseId)?.name : (currentSubject !== 'all' ? currentSubject : null),

                // NEW: squadAnalysis property for structured visualization
                squadAnalysis: {
                    architect: data.structure?.mermaid || '',
                    relationist: data.connections || [],
                    extractor: data.quotes || [],
                    strategist: data.arguments || data.strategist || [],
                    desc: data.desc || '',
                    processedAt: new Date().toISOString()
                }
            };

            // Add to TOP of list (unshift)
            biblioData.unshift(newBook);

            // Persist & Update UI
            saveData();

            // Clear processing badge from any card
            document.querySelectorAll('.squad-processing-badge').forEach(el => el.remove());

            // Switch to Database View to show result
            router('database');
            runSearch(); // Update list immediately

            // Success Trigger
            showToast(`‚úÖ Squad Engine: "${newBook.title}" aggiunto al database!`, 'success');
        };

        function initApp() {
            renderDashboard();
            router('dashboard');
            runSearch();
            renderStats();
            renderJournal();
            renderTracker();
            renderRoadmap(); // Initial render might be empty if no course selected? Or default
            renderCitationsList();
            renderConcepts();
        }
        function router(v) {
            ['dashboard', 'database', 'journal', 'tracker', 'roadmap', 'citations', 'concepts', 'course-detail'].forEach(x => {
                const el = document.getElementById('view-' + x);
                const nav = document.getElementById('nav-' + x);
                if (el) el.classList.add('hidden');
                if (nav) nav.classList.remove('nav-active');
            });
            const el = document.getElementById('view-' + v);
            const nav = document.getElementById('nav-' + v);
            if (el) el.classList.remove('hidden');
            if (nav) nav.classList.add('nav-active');

            // Mobile Sidebar handling
            if (window.innerWidth < 768) document.querySelector('aside').classList.add('hidden');
        }

        // --- DATABASE LOGIC ---
        function runSearch() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;

            // Filter Logic: Search Text + Category + NOT Deleted + (Optional) Current Course Context
            // Filter Logic
            let filtered = biblioData.filter(i => {
                const isDeleted = deletedSources.includes(i.id);
                if (isDeleted) return false;

                // Course Context Filter specific check
                const matchCourse = currentCourseId ? (courses.find(c => c.id === currentCourseId)?.name === i.subject) : false;

                // If filter is explicitly "course_context", show ONLY active course items
                if (cat === 'course_context') {
                    if (!currentCourseId) return false; // returns nothing if no course active
                    return matchCourse;
                }

                // If currently in a course view (and not searching "all" specifically overrides?), we might default to filtering?
                // The prompt says "Subject Switching". Assuming standard filter behavior + manual switch.

                // Text Match
                const txtMatch = (i.title.toLowerCase().includes(txt) || i.author.toLowerCase().includes(txt));

                // Cat Match
                const catMatch = cat === 'all' || i.cat === cat;

                // Subject Match (New v5.0)
                const subjectMatch = currentSubject === 'all' || i.subject === currentSubject || (currentSubject === 'Thesis' && i.cat === 'Primary Sources');

                return txtMatch && catMatch && subjectMatch;
            });

            // Sort: Pinned First
            filtered.sort((a, b) => {
                const isPinnedA = pinnedSources.includes(a.id);
                const isPinnedB = pinnedSources.includes(b.id);
                if (isPinnedA && !isPinnedB) return -1;
                if (!isPinnedA && isPinnedB) return 1;
                return 0;
            });

            const list = document.getElementById('results-container');
            list.innerHTML = filtered.length ? '' : '<div class="text-center text-stone-400 py-8">Nessun libro trovato.</div>';

            filtered.forEach(item => {
                const isPinned = pinnedSources.includes(item.id);
                const isAiSelected = aiSelectedSources.includes(item.id);

                list.innerHTML += `
                <div class="pro-card p-4 flex flex-col md:flex-row gap-4 items-start cursor-pointer hover:border-stone-300 transition-colors ${isPinned ? 'border-l-4 border-l-rose-400 bg-rose-50/10' : ''}" onclick="openBookModal('${item.id}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1.5 flex-wrap">
                            <span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider">${item.cat}</span>
                            ${item.subject ? `<span class="text-[9px] font-bold text-rose-400 uppercase tracking-wider">‚Ä¢ ${item.subject}</span>` : ''}
                            <button onclick="event.stopPropagation(); cycleStatus('${item.id}')" class="badge uppercase ${item.status === 'done' ? 'badge-done' : (item.status === 'reading' ? 'badge-reading' : 'badge-todo')}">${item.status}</button>
                            ${item.notes ? '<span class="text-rose-500 text-[10px]">‚óè</span>' : ''}
                            ${isPinned ? '<span class="text-xs">üìå</span>' : ''}
                        </div>
                        <h3 class="text-lg font-medium text-stone-900 serif leading-snug mb-0.5">${item.title}</h3>
                        <div class="text-xs text-stone-500 font-medium">${item.author}, ${item.year}</div>
                    </div>
                    
                    <div class="flex items-center gap-2 md:self-center" onclick="event.stopPropagation()">
                        <button onclick="togglePin('${item.id}')" class="p-2 rounded-full hover:bg-stone-100 ${isPinned ? 'text-rose-500' : 'text-stone-300'}" title="${isPinned ? 'Rimuovi Pin' : 'Fissa in alto'}">
                           üìç
                        </button>
                         <label class="flex items-center gap-1 cursor-pointer p-2 rounded-full hover:bg-stone-100" title="Seleziona per AI">
                            <input type="checkbox" class="accent-stone-900 w-4 h-4" ${isAiSelected ? 'checked' : ''} onchange="toggleAiSelect('${item.id}')">
                            <span class="text-[10px] uppercase font-bold text-stone-400">AI</span>
                        </label>
                         <button onclick="deleteSource('${item.id}')" class="p-2 rounded-full hover:bg-red-50 text-stone-300 hover:text-red-500 transition-colors" title="Elimina">
                           üóëÔ∏è
                        </button>
                    </div>
                </div>`;
            });
        }

        // --- SOURCE MANAGEMENT ACTIONS ---
        function togglePin(id) {
            if (pinnedSources.includes(id)) pinnedSources = pinnedSources.filter(x => x !== id);
            else pinnedSources.push(id);
            saveData();
            runSearch();
        }

        function toggleAiSelect(id) {
            if (aiSelectedSources.includes(id)) aiSelectedSources = aiSelectedSources.filter(x => x !== id);
            else aiSelectedSources.push(id);
            // No save needed for session-only select, but re-render might help if we had visual state outside checkbox
            // runSearch(); // Optional, checkbox checked state is enough usually, but re-render is safer for syncing
        }

        function deleteSource(id) {
            const book = biblioData.find(b => b.id === id);
            showConfirmModal(`Sei sicuro di voler eliminare "${book.title}"?`, () => {
                deletedSources.push(id);
                // Also remove from Pinned/AI Select to be clean
                pinnedSources = pinnedSources.filter(x => x !== id);
                aiSelectedSources = aiSelectedSources.filter(x => x !== id);
                saveData();
                runSearch();
                showToast('Fonte rimossa', 'info');
            });
        }

        // --- BOOK MODAL LOGIC ---
        function openAddBookModal() {
            document.getElementById('add-book-title').value = '';
            document.getElementById('add-book-author').value = '';
            document.getElementById('add-book-year').value = '';
            document.getElementById('add-book-subject').value = currentCourseId ? courses.find(c => c.id === currentCourseId).name : '';
            document.getElementById('add-book-modal').classList.remove('hidden');
        }

        function confirmAddBook() {
            const title = document.getElementById('add-book-title').value.trim();
            const author = document.getElementById('add-book-author').value.trim();
            const year = document.getElementById('add-book-year').value.trim();
            const subject = document.getElementById('add-book-subject').value.trim();

            if (!title || !author) return showToast("Inserisci almeno Titolo e Autore!", 'warning');

            const newId = "U" + Date.now().toString().slice(-4);
            const newBook = {
                id: newId,
                author: author,
                title: title,
                year: year || "????",
                pub: "User Selected",
                cat: "User Added",
                status: "todo",
                notes: "",
                tags: [],
                subject: subject || null
            };

            biblioData.unshift(newBook);

            // Save to Custom Books in LocalStorage
            const customBooks = biblioData.filter(b => b.cat === 'User Added');
            localStorage.setItem('millino_custom_books', JSON.stringify(customBooks));

            document.getElementById('add-book-modal').classList.add('hidden');
            runSearch();
            renderCitationsList();
            renderConcepts(); // Refresh stats/concepts
        }
        function openBookModal(id) {
            currentBookId = id;
            const b = biblioData.find(x => x.id === id);
            if (!b) return;

            // Basic info
            document.getElementById('modal-title').innerText = b.title;
            document.getElementById('modal-author').innerText = b.author;
            document.getElementById('modal-notes').value = b.notes || '';
            document.getElementById('modal-tags').value = (b.tags || []).join(', ');

            // Squad Analysis Tabs - Show/hide based on squad_analysis existence
            const hasSquadAnalysis = b.squad_analysis && (
                b.squad_analysis.architect?.content ||
                b.squad_analysis.relationist?.content ||
                b.squad_analysis.strategist?.content
            );

            // Tab buttons visibility
            const architectTab = document.getElementById('modal-architect-tab');
            const relationistTab = document.getElementById('modal-relationist-tab');
            const strategistTab = document.getElementById('modal-strategist-tab');
            const runSquadBtn = document.getElementById('modal-run-squad-btn');

            if (hasSquadAnalysis) {
                // Show Squad tabs
                if (architectTab) architectTab.classList.remove('hidden');
                if (relationistTab) relationistTab.classList.remove('hidden');
                if (strategistTab) strategistTab.classList.remove('hidden');
                if (runSquadBtn) runSquadBtn.classList.add('hidden');

                // Render Architect (Mermaid)
                if (b.squad_analysis.architect?.content) {
                    const architectRender = document.getElementById('modal-architect-render');
                    const architectCode = document.getElementById('modal-architect-code');
                    if (architectRender && architectCode) {
                        architectCode.value = b.squad_analysis.architect.content;
                        architectRender.innerHTML = `<div class="mermaid">${b.squad_analysis.architect.content}</div>`;
                        try { mermaid.init(undefined, architectRender.querySelectorAll('.mermaid')); } catch (e) {
                            architectRender.innerHTML = `<pre class="text-xs text-rose-500">Mermaid Error: ${e.message}</pre>`;
                        }
                    }
                }

                // Render Relationist (Concept links)
                if (b.squad_analysis.relationist?.content) {
                    const relationistList = document.getElementById('modal-relationist-list');
                    if (relationistList) {
                        try {
                            const relations = typeof b.squad_analysis.relationist.content === 'string'
                                ? JSON.parse(b.squad_analysis.relationist.content)
                                : b.squad_analysis.relationist.content;

                            if (Array.isArray(relations)) {
                                relationistList.innerHTML = relations.map(r => `
                                    <div class="flex items-center gap-2 bg-white rounded-lg p-2 border border-rose-200">
                                        <span class="px-2 py-0.5 bg-rose-100 text-rose-700 text-xs font-bold rounded">${r.concept || r.from || 'Concept'}</span>
                                        <span class="text-rose-400">‚Üí</span>
                                        <span class="text-sm text-stone-700">${r.relation || r.to || r.link || 'Related'}</span>
                                    </div>
                                `).join('');
                            } else {
                                relationistList.innerHTML = `<div class="text-sm text-stone-600 whitespace-pre-wrap">${b.squad_analysis.relationist.content}</div>`;
                            }
                        } catch (e) {
                            relationistList.innerHTML = `<div class="text-sm text-stone-600 whitespace-pre-wrap">${b.squad_analysis.relationist.content}</div>`;
                        }
                    }
                }

                // Render Strategist (Arguments)
                if (b.squad_analysis.strategist?.content) {
                    const strategistList = document.getElementById('modal-strategist-list');
                    if (strategistList) {
                        try {
                            const strategies = typeof b.squad_analysis.strategist.content === 'string'
                                ? b.squad_analysis.strategist.content.split(/\d+\.\s+/).filter(s => s.trim())
                                : (Array.isArray(b.squad_analysis.strategist.content) ? b.squad_analysis.strategist.content : [b.squad_analysis.strategist.content]);

                            strategistList.innerHTML = strategies.map((s, i) => `
                                <li class="bg-white rounded-lg p-3 border border-amber-200 text-sm text-stone-700">
                                    <span class="font-bold text-amber-700">${i + 1}.</span> ${s}
                                </li>
                            `).join('');
                        } catch (e) {
                            strategistList.innerHTML = `<li class="text-sm text-stone-600 whitespace-pre-wrap">${b.squad_analysis.strategist.content}</li>`;
                        }
                    }
                }
            } else {
                // Hide Squad tabs, show Run Squad button (if book has source file)
                if (architectTab) architectTab.classList.add('hidden');
                if (relationistTab) relationistTab.classList.add('hidden');
                if (strategistTab) strategistTab.classList.add('hidden');
                if (runSquadBtn && b.pdfPath) runSquadBtn.classList.remove('hidden');
                else if (runSquadBtn) runSquadBtn.classList.add('hidden');
            }

            // Reset to notes tab
            switchBookModalTab('notes');

            document.getElementById('book-modal').classList.remove('hidden');
        }

        function switchBookModalTab(tab) {
            const tabs = ['notes', 'architect', 'relationist', 'strategist'];
            tabs.forEach(t => {
                const content = document.getElementById(`modal-${t}-content`);
                const btn = document.getElementById(`modal-${t}-tab`);
                if (content) content.classList.toggle('hidden', t !== tab);
                if (btn && !btn.classList.contains('hidden')) {
                    btn.classList.toggle('bg-stone-900', t === tab);
                    btn.classList.toggle('text-white', t === tab);
                    btn.classList.toggle('bg-white', t !== tab);
                    btn.classList.toggle('text-stone-600', t !== tab);
                }
            });
        }

        function toggleMermaidEdit() {
            const editArea = document.getElementById('modal-architect-edit');
            if (editArea) editArea.classList.toggle('hidden');
        }

        function reRenderMermaid() {
            const code = document.getElementById('modal-architect-code')?.value;
            const render = document.getElementById('modal-architect-render');
            if (code && render) {
                render.innerHTML = `<div class="mermaid">${code}</div>`;
                try { mermaid.init(undefined, render.querySelectorAll('.mermaid')); } catch (e) {
                    render.innerHTML = `<pre class="text-xs text-rose-500">Mermaid Error: ${e.message}</pre>`;
                }
            }
        }

        function discussWithJesse(tabType) {
            const b = biblioData.find(x => x.id === currentBookId);
            if (!b || !b.squad_analysis) return;

            let contextText = '';
            switch (tabType) {
                case 'architect':
                    contextText = `Analizza questa struttura del libro "${b.title}":\n\n${b.squad_analysis.architect?.content || 'N/A'}`;
                    break;
                case 'relationist':
                    contextText = `Discutiamo le connessioni concettuali di "${b.title}":\n\n${b.squad_analysis.relationist?.content || 'N/A'}`;
                    break;
                case 'strategist':
                    contextText = `Analizziamo gli argomenti strategici di "${b.title}":\n\n${b.squad_analysis.strategist?.content || 'N/A'}`;
                    break;
            }

            // Close modal and open chat with context
            closeModal();
            showSection('chat');
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = contextText;
                chatInput.focus();
            }
            showToast(`üìö Contesto di "${b.title}" caricato in chat`, 'info');
        }

        function runSquadOnCurrentBook() {
            const b = biblioData.find(x => x.id === currentBookId);
            if (!b) return;

            // Show toast and close modal (non-blocking)
            showToast('üïµÔ∏è Squadra avviata in background...', 'info');
            closeModal();

            // Add processing badge to book card
            const bookCard = document.querySelector(`[data-book-id="${currentBookId}"]`);
            if (bookCard) {
                const badge = document.createElement('div');
                badge.id = `squad-processing-${currentBookId}`;
                badge.className = 'absolute top-2 right-2 bg-rose-500 text-white text-[8px] font-bold px-2 py-1 rounded-full animate-pulse';
                badge.innerText = '‚öôÔ∏è Processing...';
                bookCard.style.position = 'relative';
                bookCard.appendChild(badge);
            }

            // TODO: Trigger actual Squad Engine processing for existing book
            // This would require passing the book's pdfPath to SquadEngine
            if (b.pdfPath && window.squadEngine) {
                // Placeholder - would need actual file reference
                showToast(`üìÑ Avvia analisi per: ${b.title}`, 'info');
            }
        }

        function closeModal() {
            document.getElementById('book-modal').classList.add('hidden');
        }

        function saveBookDetails() {
            const b = biblioData.find(x => x.id === currentBookId);
            b.notes = document.getElementById('modal-notes').value;
            b.tags = document.getElementById('modal-tags').value.split(',').map(t => t.trim()).filter(t => t);
            saveData();
            closeModal();
            runSearch();
            renderConcepts();
        }

        function cycleStatus(id) {
            const i = biblioData.findIndex(x => x.id === id);
            const map = { 'todo': 'reading', 'reading': 'done', 'done': 'todo' };
            biblioData[i].status = map[biblioData[i].status];
            if (biblioData[i].status === 'done') confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: ['#E7E5E4', '#F43F5E'] });
            saveData();
            renderStats();
            runSearch();
        }

        // Book Modal Tab Switching
        function switchBookModalTab(tab) {
            ['notes', 'squad'].forEach(t => {
                const content = document.getElementById(`modal-${t}-content`);
                const tabBtn = document.getElementById(`modal-${t}-tab`);
                if (content) content.classList.toggle('hidden', t !== tab);
                if (tabBtn) {
                    tabBtn.classList.toggle('bg-stone-900', t === tab);
                    tabBtn.classList.toggle('text-white', t === tab);
                    tabBtn.classList.toggle('bg-white', t !== tab);
                    tabBtn.classList.toggle('text-stone-600', t !== tab);
                }
            });
        }

        // Squad Analysis Rendering
        function renderSquadAnalysis(analysis, container) {
            if (!analysis) {
                container.innerHTML = '<p class="text-stone-400 text-sm italic text-center py-8">Nessuna analisi Squad disponibile.</p>';
                return;
            }

            const uniqueId = 'squad-mermaid-' + Date.now();

            let html = `
                <div class="space-y-6">
                    <!-- The Architect: Mermaid Graph -->
                    ${analysis.architect ? `
                        <div class="bg-stone-50 rounded-xl p-4 border border-stone-200">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-stone-800 text-sm flex items-center gap-2">
                                    <span class="w-6 h-6 bg-stone-800 text-white rounded-full flex items-center justify-center text-xs">üèõÔ∏è</span>
                                    The Architect
                                </h4>
                                <button onclick="toggleMermaidEditMode('${uniqueId}')" class="text-[10px] text-stone-500 hover:text-stone-800 font-medium">
                                    ‚úèÔ∏è Edit Code
                                </button>
                            </div>
                            <div id="${uniqueId}-render" class="bg-white rounded-lg p-4 border border-stone-100 overflow-auto max-h-64"></div>
                            <div id="${uniqueId}-edit" class="hidden mt-2">
                                <textarea id="${uniqueId}-code" class="w-full h-40 font-mono text-xs bg-white border border-stone-200 rounded-lg p-3 outline-none focus:border-rose-300">${analysis.architect}</textarea>
                                <button onclick="retryMermaidRender('${uniqueId}')" class="mt-2 text-xs bg-stone-800 text-white px-3 py-1.5 rounded-lg hover:bg-black">
                                    üîÑ Re-render
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- The Relationist: Concept Tags -->
                    ${analysis.relationist && analysis.relationist.length > 0 ? `
                        <div class="bg-rose-50 rounded-xl p-4 border border-rose-100">
                            <h4 class="font-bold text-rose-800 text-sm flex items-center gap-2 mb-3">
                                <span class="w-6 h-6 bg-rose-500 text-white rounded-full flex items-center justify-center text-xs">üîó</span>
                                The Relationist
                            </h4>
                            <div class="space-y-2">
                                ${analysis.relationist.map(r => `
                                    <div class="flex items-center gap-2 text-xs bg-white rounded-lg p-2 border border-rose-100">
                                        <span class="font-semibold text-stone-800">${r.source}</span>
                                        <span class="bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full text-[10px] font-medium">${r.relation}</span>
                                        <span class="font-semibold text-stone-800">${r.target}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- The Strategist: Strategy Cards -->
                    ${analysis.strategist && analysis.strategist.length > 0 ? `
                        <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                            <h4 class="font-bold text-amber-800 text-sm flex items-center gap-2 mb-3">
                                <span class="w-6 h-6 bg-amber-500 text-white rounded-full flex items-center justify-center text-xs">‚öîÔ∏è</span>
                                The Strategist
                            </h4>
                            <ul class="space-y-2">
                                ${analysis.strategist.map((s, i) => `
                                    <li class="flex items-start gap-2 text-xs bg-white rounded-lg p-3 border border-amber-100">
                                        <span class="w-5 h-5 bg-amber-500 text-white rounded-full flex items-center justify-center text-[10px] font-bold shrink-0">${i + 1}</span>
                                        <span class="text-stone-700 leading-relaxed">${s}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <!-- The Extractor: Atomic Notes -->
                    ${analysis.extractor && analysis.extractor.length > 0 ? `
                        <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                            <h4 class="font-bold text-green-800 text-sm flex items-center gap-2 mb-3">
                                <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs">üíé</span>
                                Atomic Notes
                            </h4>
                            <div class="space-y-3">
                                ${analysis.extractor.map(q => `
                                    <div class="bg-white rounded-lg p-3 border-l-2 border-green-400">
                                        <div class="italic text-stone-600 text-[11px] mb-2">"${q.quote}"</div>
                                        <div class="text-xs font-medium text-stone-800">${q.paraphrase}</div>
                                        ${q.tag ? `<span class="inline-block mt-2 text-[9px] text-green-600 bg-green-50 px-2 py-0.5 rounded-full">#${q.tag.replace('#', '')}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            container.innerHTML = html;

            // Render Mermaid if architect exists
            if (analysis.architect) {
                setTimeout(() => {
                    try {
                        const renderArea = document.getElementById(`${uniqueId}-render`);
                        const mermaidEl = document.createElement('div');
                        mermaidEl.className = 'mermaid';
                        mermaidEl.textContent = analysis.architect;
                        renderArea.appendChild(mermaidEl);
                        mermaid.init(undefined, mermaidEl);
                    } catch (e) {
                        console.error('Mermaid render error:', e);
                        document.getElementById(`${uniqueId}-render`).classList.add('hidden');
                        document.getElementById(`${uniqueId}-edit`).classList.remove('hidden');
                        showToast('Mermaid render fallito - usa Edit Mode', 'warning');
                    }
                }, 300);
            }
        }

        function toggleMermaidEditMode(uniqueId) {
            const renderArea = document.getElementById(`${uniqueId}-render`);
            const editArea = document.getElementById(`${uniqueId}-edit`);
            renderArea.classList.toggle('hidden');
            editArea.classList.toggle('hidden');
        }

        function retryMermaidRender(uniqueId) {
            const codeArea = document.getElementById(`${uniqueId}-code`);
            const renderArea = document.getElementById(`${uniqueId}-render`);
            const editArea = document.getElementById(`${uniqueId}-edit`);

            renderArea.innerHTML = '';

            try {
                const mermaidEl = document.createElement('div');
                mermaidEl.className = 'mermaid';
                mermaidEl.textContent = codeArea.value;
                renderArea.appendChild(mermaidEl);
                mermaid.init(undefined, mermaidEl);

                renderArea.classList.remove('hidden');
                editArea.classList.add('hidden');
                showToast('Diagram rendered!', 'success');
            } catch (e) {
                showToast('Syntax error in Mermaid code', 'error');
            }
        }


        // --- DASHBOARD LOGIC (NEW) ---
        function renderDashboard() {
            const container = document.getElementById('course-grid');
            let html = courses.map(course => {
                const daysLeft = Math.ceil((new Date(course.date) - new Date()) / (1000 * 60 * 60 * 24));
                const totalTopics = course.topics.length;
                // Quick fake progress: count how many primary sources of this subject are "done"
                // Better metric: we don't have per-topic progress yet, so let's stick to reading stats for that subject
                const subjBooks = biblioData.filter(b => b.subject === course.name);
                const doneCount = subjBooks.filter(b => b.status === 'done').length;
                const progress = subjBooks.length > 0 ? Math.round((doneCount / subjBooks.length) * 100) : 0;

                return `
                <div class="pro-card p-6 border-l-4 ${daysLeft < 30 ? 'border-l-rose-500' : 'border-l-stone-800'} relative group cursor-pointer" onclick="selectCourse('${course.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">${course.prof}</span>
                            <h3 class="text-xl font-serif text-stone-900 font-medium">${course.name}</h3>
                        </div>
                        <div class="text-right">
                             <div class="text-lg font-mono font-bold ${daysLeft < 30 ? 'text-rose-600' : 'text-stone-700'}">${daysLeft}gg</div>
                             <div class="text-[9px] uppercase font-bold text-stone-400">All'esame</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs text-stone-500">
                            <span>Sillabo: ${totalTopics} Moduli</span>
                            <span>Letture: ${progress}%</span>
                        </div>
                        <div class="w-full bg-stone-100 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-stone-800 h-1.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                         <span class="text-xs bg-stone-900 text-white px-2 py-1 rounded">Vai al corso ‚Üí</span>
                    </div>
                </div>`;
            }).join('');

            // ADD NEW COURSE CARD
            html += `
            <div onclick="openCourseModal()" class="border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-stone-400 cursor-pointer hover:border-text-stone-600 hover:text-stone-600 hover:bg-stone-50 transition-colors min-h-[160px]">
                <div class="text-3xl mb-2">+</div>
                <div class="font-bold text-sm uppercase tracking-wider">Aggiungi Corso</div>
            </div>`;

            container.innerHTML = html;
        }

        function selectCourse(id) {
            currentCourseId = id;
            renderCourseDetail(id);
            router('course-detail');
        }

        function renderCourseDetail(id) {
            const course = courses.find(c => c.id === id);
            if (!course) return;

            document.getElementById('course-title').innerText = course.name;
            document.getElementById('course-prof').innerText = "Prof. " + course.prof;
            document.getElementById('course-date').innerText = course.date;

            // --- EXAM INFO CARD (NEW) ---
            const examBox = document.getElementById('course-exam-info');
            if (!examBox) {
                const header = document.querySelector('.course-header-bg'); // Helper selector
                // Inject after header? Or in a grid.
                // The current layout has 'course-syllabus-container' inside a grid.
                // Let's use the syllabus container parent.
                const parent = document.getElementById('course-syllabus-container').parentElement;

                // Create Info Bar if not exists
                const infoDiv = document.createElement('div');
                infoDiv.id = 'course-exam-info';
                infoDiv.className = "mb-8 bg-rose-50 border border-rose-100 rounded-xl p-6 relative overflow-hidden";
                parent.insertBefore(infoDiv, document.getElementById('course-syllabus-container'));
            }

            // Render Exam Content
            const examInfo = course.exam_info || { mode: 'Oral', description: 'Nessuna info esame.' };
            const modeLabels = { 'Oral': 'Orale', 'Written': 'Scritto', 'Project': 'Progetto', 'Mixed': 'Misto' };
            const tips = examInfo.tips ? `<div class="mt-3 pt-3 border-t border-rose-100 text-xs text-rose-500 italic">üí° <strong>Consiglio AI:</strong> ${examInfo.tips}</div>` : '';

            document.getElementById('course-exam-info').innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-[10px] font-bold text-rose-400 uppercase tracking-widest">Modalit√† Esame</span>
                        <h3 class="text-2xl font-serif text-rose-900 font-bold mb-2">${modeLabels[examInfo.mode] || examInfo.mode}</h3>
                        <p class="text-sm text-stone-600 leading-relaxed max-w-2xl">${examInfo.description || 'Aggiungi dettagli sull\'esame modificando il corso.'}</p>
                        ${tips}
                    </div>
                    <div class="text-4xl opacity-20">üéì</div>
                </div>
            `;


            // Add Edit/Delete Buttons logic (preserved)
            const dateBox = document.getElementById('course-date').parentNode;
            if (!document.getElementById('course-actions-wrap')) {
                const d = document.createElement('div');
                d.id = 'course-actions-wrap';
                d.className = "flex gap-2 justify-end mt-2";
                d.innerHTML = `
                 <button onclick="openCourseModal('${course.id}')" class="text-xs border border-stone-200 px-3 py-1 rounded hover:bg-stone-50">Modifica</button>
                 <button onclick="deleteCourse('${course.id}')" class="text-xs border border-red-100 text-red-500 px-3 py-1 rounded hover:bg-red-50">Elimina</button>
                 `;
                dateBox.appendChild(d);
            } else {
                const w = document.getElementById('course-actions-wrap');
                w.innerHTML = `
                 <button onclick="openCourseModal('${course.id}')" class="text-xs border border-stone-200 px-3 py-1 rounded hover:bg-stone-50">Modifica</button>
                 <button onclick="deleteCourse('${course.id}')" class="text-xs border border-red-100 text-red-500 px-3 py-1 rounded hover:bg-red-50">Elimina</button>
                 `;
            }


            const box = document.getElementById('course-syllabus-container');
            box.innerHTML = '';

            if ((!course.topics || course.topics.length === 0)) {
                box.innerHTML = `<div class="text-center text-stone-400 py-10 italic">Nessun modulo nel sillabo. (Usa 'Modifica' > 'Sillabo' per aggiungere)</div>`;
                return;
            }

            // Helper for safe strings
            const safe = (str) => str ? str.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';

            course.topics.forEach((topic, idx) => {
                // Resolve Texts (IDs to Title)
                const textNames = (topic.texts || []).map(tid => {
                    const b = biblioData.find(x => x.id === tid);
                    return b ? `<span title="${b.title}">${b.author}</span>` : tid;
                }).join(', ');

                box.innerHTML += `
                <details class="group bg-white border border-stone-200 rounded-xl overflow-hidden hover:border-stone-300 transition-colors" ${idx === 0 ? 'open' : ''}>
                    <summary class="flex justify-between items-center p-5 cursor-pointer bg-stone-50/50 hover:bg-stone-50">
                        <h4 class="font-bold text-stone-800 text-lg serif">${topic.title}</h4>
                        <span class="text-stone-400 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="p-6 border-t border-stone-100 bg-white space-y-5">
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Obiettivo</span><p class="text-sm text-stone-800 font-medium leading-relaxed">${topic.goal || 'Nessun obiettivo.'}</p></div>
                            <div><span class="text-[9px] font-bold text-stone-400 uppercase tracking-wider block mb-1">Materiali</span><p class="text-sm text-stone-600 leading-relaxed">${textNames || 'Nessun testo assegnato.'}</p></div>
                        </div>
                         <div class="pt-4 mt-2 border-t border-stone-100 flex justify-end gap-2">
                             <button onclick="askAI('Spiegami ${safe(topic.title)} del corso ${safe(course.name)}')" class="bg-stone-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors">Chiedi a Jesse</button>
                        </div>
                    </div>
                </details>`;
            });
        }

        // --- ROADMAP LOGIC (THESIS ONLY) ---
        function renderRoadmap() {
            const sel = document.getElementById('roadmapSelect').value;
            const st = sel === 'custom' ? customStrategy : detailedRoadmaps[sel];

            document.getElementById('roadmap-title').innerText = st.title;
            document.getElementById('roadmap-desc').innerText = st.desc;
            document.getElementById('custom-controls').className = sel === 'custom' ? 'border-t border-stone-200 pt-4 flex gap-2 justify-end' : 'hidden';

            // Top Sources
            let bibContainer = document.getElementById('roadmap-biblio');
            let bibList = document.getElementById('roadmap-biblio-list');

            if (!bibContainer) {
                const descBox = document.getElementById('roadmap-desc').parentNode.parentNode;
                bibContainer = document.createElement('div');
                bibContainer.id = 'roadmap-biblio';
                bibContainer.className = "mt-4 pt-4 border-t border-stone-200 hidden";
                bibContainer.innerHTML = `<span class="text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-2 block">üìö Bibliografia Essenziale:</span><div id="roadmap-biblio-list" class="flex flex-wrap gap-2"></div>`;
                descBox.appendChild(bibContainer);
                bibListElement = document.getElementById('roadmap-biblio-list'); // Re-get after creation
            }

            // New logic for rendering top sources
            bibList = document.getElementById('roadmap-biblio-list'); // Get the actual list container
            bibList.innerHTML = ''; // Clear existing content

            if (st.top_sources && st.top_sources.length > 0) {
                bibContainer.classList.remove('hidden'); // Ensure container is visible
                bibList.innerHTML = st.top_sources.map(id => {
                    const book = biblioData.find(b => b.id === id);
                    if (!book) return '';
                    // Display: "Simondon - L'individuazione..."
                    return `<div class="bg-white p-2 rounded border border-stone-200 text-xs text-stone-600 flex items-center justify-between gap-2 max-w-full overflow-hidden">
                        <span class="font-bold whitespace-nowrap">${book.author}</span>
                        <span class="truncate italic opacity-80" title="${book.title}">${book.title}</span>
                        <span class="text-[9px] bg-stone-100 text-stone-400 px-1 rounded shrink-0">${book.year}</span>
                    </div>`;
                }).join('');
            } else {
                bibContainer.classList.add('hidden'); // Hide container if no sources
                bibList.innerHTML = '<div class="text-stone-400 text-xs italic">Nessuna fonte specifica selezionata.</div>';
            }

            // Chapters
            const c = document.getElementById('chapters-container');
            c.innerHTML = '';

            if (st.chapters.length === 0 && sel === 'custom') {
                c.innerHTML = '<div class="text-center text-stone-400 py-10 italic">Nessun capitolo. Chiedi a Jesse!</div>';
                return;
            }

            // HELPER_FIX: Safe string for onclick to prevent breaking on quotes
            const safe = (str) => str ? str.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';

            st.chapters.forEach((ch, idx) => {
                // If chapter lacks new detailed fields (legacy custom), fallback
                const objectivesHtml = ch.objectives ? `<ul class="list-disc list-inside text-stone-600 text-sm space-y-1 mb-3">${ch.objectives.map(o => `<li>${o}</li>`).join('')}</ul>` : '';
                const analysisHtml = ch.analysis ? `<div class="bg-stone-50 p-3 rounded-lg text-sm text-stone-700 italic border-l-2 border-stone-300 mb-3">${ch.analysis}</div>` : '';
                const methodologyHtml = ch.methodology ? `<div class="text-xs text-stone-500 mb-3"><strong class="uppercase tracking-wider text-rose-500">Metodologia:</strong> ${ch.methodology}</div>` : '';

                c.innerHTML += `
                <details class="group bg-white border border-stone-200 rounded-xl overflow-hidden hover:border-stone-300 transition-colors" ${idx === 0 ? 'open' : ''}>
                    <summary class="flex justify-between items-center p-5 cursor-pointer bg-stone-50/50 hover:bg-stone-50">
                        <h4 class="font-bold text-stone-800 text-lg serif">${ch.title}</h4>
                        <span class="text-stone-400 group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div class="p-6 border-t border-stone-100 bg-white space-y-4">
                        <div class="uppercase text-[10px] font-bold text-stone-400 tracking-wider">Obiettivo: ${ch.goal}</div>
                        
                        ${objectivesHtml}
                        ${analysisHtml}
                        ${methodologyHtml}

                        <div class="pt-4 mt-2 border-t border-stone-100 flex justify-between items-center">
                             <div class="flex gap-2 text-xs text-stone-400 font-mono">
                                ${ch.concepts ? `<span>üîë ${ch.concepts}</span>` : ''}
                             </div>
                             <button onclick="askAI('Aiutami a scrivere una bozza per il capitolo: ${safe(ch.title)}. Obiettivo: ${safe(ch.goal)}. Analisi: ${safe(ch.analysis)}', 'academic_draft')" class="bg-stone-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors shadow-sm flex items-center gap-2">
                                <span>‚úçÔ∏è</span> Scrivi Bozza
                             </button>
                        </div>
                    </div>
                </details>`;
            });
        }

        // --- JESSE & CHAT ---
        // V6.0: Jesse Mode Persistence - Mode is GLOBAL and injected on every API call
        function setJesseMode(mode) {
            currentJesseMode = mode;
            aiMode = mode; // For backward compatibility

            // Update button active states
            document.querySelectorAll('.jesse-mode-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-mode-${mode}`);
            if (activeBtn) activeBtn.classList.add('active');

            // Mode-specific greeting message
            const modeMessages = {
                standard: "üêï Ciao padrona! Sono tornato in modalit√† standard. Come posso aiutarti oggi?",
                socrajess: "ü§î Modalit√† SocraJess attivata! Da ora risponder√≤ solo con domande per guidare il tuo ragionamento...",
                critic: "‚öñÔ∏è Modalit√† Relatore Severo attivata. Preparati, sar√≤ rigoroso ma costruttivo!",
                discuss: "üéì Benvenuta alla simulazione della Discussione di Laurea. La commissione √® pronta. Difendi la tua tesi!"
            };

            addMessage(modeMessages[mode] || modeMessages.standard, 'bot');
            showToast(`Modalit√† Jesse: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`, 'info');
        }

        // Legacy compatibility wrapper
        function setMode(m) {
            const modeMap = { 'Socrajess': 'socrajess', 'critic': 'critic', 'discuss': 'discuss' };
            setJesseMode(modeMap[m] || 'standard');
        }

        function toggleChat() {
            const w = document.getElementById('chat-widget');
            w.classList.toggle('chat-closed');
            w.classList.toggle('chat-open');
        }

        function addMessage(txt, role) {
            const box = document.getElementById('chat-messages');
            const html = marked.parse(txt);
            const isJesse = role === 'bot';
            box.innerHTML += `
            <div class="flex gap-3 fade-in mt-4 ${isJesse ? '' : 'flex-row-reverse'}">
                <div class="w-8 h-8 rounded-full overflow-hidden border border-stone-200 shrink-0 bg-white">
                    ${isJesse ? `<img src="${JESSE_IMG}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-stone-900 flex items-center justify-center text-white text-xs">TU</div>`}
                </div>
                <div class="p-3 rounded-2xl text-sm max-w-[85%] prose prose-sm ${isJesse ? 'msg-jesse' : 'msg-user'}">
                    ${html}
                </div>
            </div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function sendChat(mode = null, personaOverride = null) {
            const inp = document.getElementById('chat-input');
            const activeMode = mode || aiMode;
            const txt = inp.value.trim();
            if (!txt && activeMode === 'chat') return;

            addMessage(txt, 'user');
            inp.value = '';

            const loadId = 'load-' + Date.now();
            document.getElementById('chat-messages').innerHTML += `<div id="${loadId}" class="flex items-center gap-2 mt-4 ml-2"><img src="${JESSE_IMG}" class="w-6 h-6 rounded-full border border-stone-200 grayscale opacity-70"><span class="text-xs text-stone-500 italic animate-pulse">Jesse sta pensando...</span></div>`;

            // CONTEXT LOGIC: Selected > Pinned > Current Course > All
            let contextData = biblioData;
            // If user explicitly selected sources, use ONLY those
            if (aiSelectedSources.length > 0) {
                contextData = biblioData.filter(b => aiSelectedSources.includes(b.id));
            } else if (pinnedSources.length > 0) {
                // If nothing selected but items are pinned, maybe prioritizing pinned? 
                // User request: "passes ONLY the selected/pinned sources". 
                // Let's union them if exists.
                contextData = biblioData.filter(b => pinnedSources.includes(b.id));
            } else if (currentCourseId) {
                // Default to course context if nothing pinned/selected
                const course = courses.find(c => c.id === currentCourseId);
                if (course) contextData = biblioData.filter(b => b.subject === course.name);
            }

            // V6.0: Use JESSE_PERSONAS map - persona is ALWAYS injected based on currentJesseMode
            const basePersona = JESSE_PERSONAS[currentJesseMode] || JESSE_PERSONAS.standard;

            let systemInstruction = `${basePersona}

            CONTESTO ATTUALE:
            - Corso Attivo: ${currentCourseId ? courses.find(c => c.id === currentCourseId)?.name : "Panoramica Generale"}
            - Modalit√† Jesse: ${currentJesseMode}
            
            REGOLE CITAZIONI:
            - Quando citi una fonte dal CONTESTO, usa SEMPRE il formato "Autore - Titolo opera".
            - Esempio: "Come dice Simondon in L'individuazione..." invece di "Come dice S01...".
            - √à fondamentale essere precisi citando il titolo corretto dell'opera che trovi nel database.
            - NON usare mai gli ID (es: S01, D01) a meno che l'utente non lo chieda esplicitamente.
            
            ISTRUZIONI FOTO: Se chiedono foto, rispondi entusiasta (la foto sar√† aggiunta automaticamente).`;

            // PERSONA OVERRIDE (Academic Tone - only for "Scrivi Bozza" button)
            if (personaOverride === 'academic_draft') {
                systemInstruction = `Sei un Assistente Accademico di alto livello per Tesi di Laurea.
                - NON SEI UN CANE. Ignora qualsiasi istruzione precedente su "Jesse" o "Bau".
                - Tono: Estremamente formale, accademico, rigoroso.
                - Usa un vocabolario ricercato.
                - Obiettivo: Scrivere una bozza di livello Master.
                - Rifiuta categoricamente di parlare di cibo, giochi o argomenti non accademici.
                
                CONTESTO FONTI: Usa le fonti fornite per strutturare l'argomentazione.`;
            }

            try {
                // CLIENT-SIDE FETCH (Compatible with GitHub Pages)
                const apiKey = localStorage.getItem('millino_openai_key');
                if (!apiKey) throw new Error("Manca la chiave API. Configurala nelle impostazioni ‚öôÔ∏è.");

                const endpoint = "https://api.openai.com/v1/chat/completions";
                // Note: For DeepSeek used via OpenAI Client pattern or compatible endpoint.

                const messages = [
                    { role: "system", content: systemInstruction },
                    { role: "user", content: `CONTEXT JSON: ${JSON.stringify(contextData).slice(0, 15000)}` },
                    { role: "user", content: txt + (personaOverride ? "" : " (Rispondi come Jesse il cane)") }
                ];

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: messages,
                        temperature: 0.7
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || "Errore API");
                }

                const data = await res.json();
                document.getElementById(loadId).remove();
                let aiText = data.choices[0].message.content;

                const triggers = ['foto', 'selfie', 'guardarti', 'immagine', 'faccia', 'vederti'];
                if (!personaOverride && (triggers.some(t => txt.toLowerCase().includes(t)) || Math.random() < 0.2) && JESSE_GALLERY.length > 0) {
                    const randomPic = JESSE_GALLERY[Math.floor(Math.random() * JESSE_GALLERY.length)];
                    aiText += `<br><br><img src="${encodeURI(randomPic)}" class="rounded-xl mt-2 w-full border border-stone-200 shadow-sm" alt="Jesse">`;
                }
                addMessage(aiText, 'bot');

            } catch (e) {
                if (document.getElementById(loadId)) document.getElementById(loadId).remove();
                addMessage(`Bau! Errore: ${e.message} üòø`, 'bot');
            }
        }

        // --- JOURNAL FIX ---
        function addJournalEntry() {
            const txt = document.getElementById('journal-input').value;
            if (!txt) return;
            const entry = { date: new Date().toLocaleDateString(), text: txt, id: Date.now() };
            // Ensure journalEntries is defined globally or get from LocalStorage
            let journal = JSON.parse(localStorage.getItem('journal_entries') || '[]');
            journal.unshift(entry);
            localStorage.setItem('journal_entries', JSON.stringify(journal));
            document.getElementById('journal-input').value = '';
            renderJournal();
            showToast("Diario aggiornato.");
        }
        function renderJournal() {
            let journal = JSON.parse(localStorage.getItem('journal_entries') || '[]');
            const c = document.getElementById('journal-entries');
            if (!c) return;
            c.innerHTML = journal.map(j => `<div class="bg-stone-50 p-3 rounded-lg text-xs text-stone-600 mb-2 border border-stone-100"><strong class="block text-stone-400 text-[10px] uppercase mb-1">${j.date}</strong>${j.text}</div>`).join('');
        }
        function askAI(q, override) {
            document.getElementById('chat-input').value = q;
            if (document.getElementById('chat-widget').classList.contains('chat-closed')) toggleChat();
            sendChat(null, override);
        }
        function askAIAboutBook() { const b = biblioData.find(x => x.id === currentBookId); closeModal(); toggleChat(); askAI(`Ho preso queste note su "${b.title}": "${b.notes}". Aiutami a espanderle.`); }

        // --- UTILS (Audio, Timer, Chart) ---
        function initAudio() {
            ['rain', 'cafe', 'fire'].forEach(id => { const el = document.getElementById('audio-' + id); if (el) el.volume = 0.5; });
        }
        function toggleSound(id) { const el = document.getElementById('audio-' + id); const btn = document.getElementById('btn-' + id); if (el.paused) { el.play(); btn.classList.remove('text-stone-300'); btn.classList.add('text-stone-900'); } else { el.pause(); btn.classList.add('text-stone-300'); btn.classList.remove('text-stone-900'); } }
        function stopAllSounds() { ['rain', 'cafe', 'fire'].forEach(id => { document.getElementById('audio-' + id).pause(); document.getElementById('btn-' + id).classList.add('text-stone-300'); document.getElementById('btn-' + id).classList.remove('text-stone-900'); }); }

        // GLOBAL POMODORO TIMER STATE (FIX: Ensure global scope)
        let timerInterval = null;
        let time = 1500;
        let running = false;
        let timerMode = 'focus'; // 'focus' (25m) or 'break' (7m)

        function toggleTimer() {
            const d = document.getElementById('zen-timer');
            const mainDisplay = document.getElementById('timer-display');
            const btn = document.getElementById('timer-btn');
            const modeLabel = document.getElementById('timer-mode-label');
            const icon = document.getElementById('pomo-status-icon');

            // FIX: Always clear any existing interval first to prevent stacking
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            if (running) {
                running = false;
                modeLabel.innerText = "Paused";
                modeLabel.classList.add('text-stone-400');
                modeLabel.classList.remove('text-rose-400', 'text-teal-400');
                btn.classList.remove('animate-pulse', 'border-rose-500');
                btn.classList.add('border-stone-800');
            } else {
                running = true;
                modeLabel.innerText = timerMode === 'focus' ? "Running..." : "Chilling...";
                modeLabel.classList.remove('text-stone-400');
                modeLabel.classList.add(timerMode === 'focus' ? 'text-rose-400' : 'text-teal-400');
                btn.classList.add('animate-pulse');
                if (timerMode === 'focus') btn.classList.add('border-rose-500');

                timerInterval = setInterval(() => {
                    time--;
                    let m = Math.floor(time / 60), s = time % 60;
                    const t = `${m}:${s.toString().padStart(2, '0')}`;

                    mainDisplay.innerText = t;
                    if (d) d.innerText = t;
                    document.title = `${t} - Millino Fagiolino`;

                    if (time <= 0) {
                        clearInterval(timerInterval);
                        running = false;
                        btn.classList.remove('animate-pulse');

                        // Play completion sound (ding)
                        try {
                            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                            const oscillator = audioCtx.createOscillator();
                            const gainNode = audioCtx.createGain();
                            oscillator.connect(gainNode);
                            gainNode.connect(audioCtx.destination);
                            oscillator.frequency.value = 800;
                            oscillator.type = 'sine';
                            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                            oscillator.start(audioCtx.currentTime);
                            oscillator.stop(audioCtx.currentTime + 0.5);
                        } catch (e) { /* Audio not available */ }

                        // Switch Mode Forcefully
                        if (timerMode === 'focus') {
                            timerMode = 'break';
                            time = 7 * 60; // 7 Minutes
                            icon.innerText = "‚òï";
                            modeLabel.innerText = "COFFEE BREAK";
                            modeLabel.className = "text-[8px] uppercase font-bold text-teal-400 tracking-widest";
                            mainDisplay.className = "font-mono text-xl font-bold tracking-widest text-teal-100";
                            showToast("üß† Focus completato! Ora 7 minuti di pausa.", 'success');
                        } else {
                            timerMode = 'focus';
                            time = 25 * 60; // 25 Minutes
                            icon.innerText = "üß†";
                            modeLabel.innerText = "FOCUS MODE";
                            modeLabel.className = "text-[8px] uppercase font-bold text-stone-400 tracking-widest";
                            mainDisplay.className = "font-mono text-xl font-bold tracking-widest text-white";
                            showToast("‚òï Pausa finita. Si torna a lavorare!", 'info');
                        }

                        // Update Display immediately
                        let m2 = Math.floor(time / 60), s2 = time % 60;
                        mainDisplay.innerText = `${m2}:${s2.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            running = false;
            timerMode = 'focus';
            time = 1500;
            document.getElementById('timer-display').innerText = "25:00";
            document.getElementById('pomo-status-icon').innerText = "üß†";
            document.getElementById('timer-mode-label').innerText = "FOCUS MODE";
        }
        function toggleZenMode() { const z = document.getElementById('zen-mode'); z.classList.toggle('hidden'); }

        function renderTracker() {
            const ctx = document.getElementById('wordChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: wordHistory.map(h => h.date), datasets: [{ label: 'Parole', data: wordHistory.map(h => h.count), borderColor: '#1C1917', backgroundColor: 'rgba(28, 25, 23, 0.1)', tension: 0.3, fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#F5F5F4' }, border: { display: false } } } } });
        }
        function updateWordCount() { const v = parseInt(document.getElementById('word-input').value); if (v) { const d = new Date().toLocaleDateString('it-IT'); const i = wordHistory.findIndex(h => h.date === d); if (i >= 0) wordHistory[i].count = v; else wordHistory.push({ date: d, count: v }); localStorage.setItem('word_history', JSON.stringify(wordHistory)); renderTracker(); } }

        // --- V6.0 TOAST NOTIFICATION SYSTEM ---
        // Types: 'success' (white/rose), 'error' (rose/dark), 'warning' (amber), 'info' (stone-900)
        function showToast(msg, type = 'success') {
            // Remove existing toast if present
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            // Type-specific icons
            const icons = {
                success: '‚ú®',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: 'üí¨'
            };

            toast.innerHTML = `<span>${icons[type] || icons.success}</span> ${msg}`;
            document.body.appendChild(toast);

            // Auto-dismiss with fade-out animation
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards';
                setTimeout(() => toast.remove(), 400);
            }, 2500);
        }

        // --- CONFIRM MODAL (Replacement for browser confirm()) ---
        function showConfirmModal(message, onConfirm, onCancel = null) {
            const backdrop = document.createElement('div');
            backdrop.className = 'confirm-modal-backdrop';
            backdrop.innerHTML = `
                <div class="confirm-modal-box">
                    <p class="text-stone-800 font-medium text-sm mb-6">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-cancel" class="px-4 py-2 text-xs font-bold text-stone-500 hover:bg-stone-100 rounded-lg transition-colors">Annulla</button>
                        <button id="confirm-ok" class="px-5 py-2 text-xs font-bold bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition-colors">Conferma</button>
                    </div>
                </div>
            `;
            document.body.appendChild(backdrop);

            document.getElementById('confirm-cancel').onclick = () => {
                backdrop.remove();
                if (onCancel) onCancel();
            };

            document.getElementById('confirm-ok').onclick = () => {
                backdrop.remove();
                onConfirm();
            };

            // Close on backdrop click
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    backdrop.remove();
                    if (onCancel) onCancel();
                }
            });
        }

        function selectAllCitations() { document.querySelectorAll('.cite-cb').forEach(cb => cb.checked = true); generateBibliography(); }
        function renderCitationsList() { const l = document.getElementById('citation-list'); l.innerHTML = ''; biblioData.forEach(i => { l.innerHTML += `<label class="flex items-center gap-3 p-2 hover:bg-stone-50 rounded-lg cursor-pointer"><input type="checkbox" class="accent-stone-900 cite-cb" value="${i.id}" onchange="generateBibliography()"><span class="text-xs text-stone-600 truncate">${i.title}</span></label>` }); }
        function copyCitationOutput() { const t = document.getElementById('citation-output'); t.select(); navigator.clipboard.writeText(t.value); showToast("Copiato negli appunti"); }
        function copyFootnoteStyle() { const c = Array.from(document.querySelectorAll('.cite-cb:checked')).map(x => x.value); const i = biblioData.filter(x => c.includes(x.id)); let o = i.map(x => `${x.author.split(',')[1].trim()} ${x.author.split(',')[0]}, *${x.title}*, ${x.pub}, Paris ${x.year}.`).join('\n'); document.getElementById('citation-output').value = o; copyCitationOutput(); }
        function generateBibliography() { const c = Array.from(document.querySelectorAll('.cite-cb:checked')).map(x => x.value); const i = biblioData.filter(x => c.includes(x.id)); let o = ""; const s = document.getElementById('citation-style').value; if (s === 'classic') { copyFootnoteStyle(); return; } i.forEach(x => { o += s === 'bibtex' ? `@book{${x.id}, title={${x.title}}...}\n` : `${x.author} (${x.year}). ${x.title}.\n\n` }); document.getElementById('citation-output').value = o; }
        function downloadBibliography() { const t = biblioData.filter(b => b.status === 'done' || b.status === 'reading').map(b => `${b.author} (${b.year}). ${b.title}.`).join('\n\n'); const b = new Blob([t], { type: 'text/plain' }); const u = window.URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = "bibliografia.txt"; a.click(); }

        function switchSubject(subj) {
            currentSubject = subj;
            showToast(`Materia attiva: ${subj === 'all' ? 'Tutte' : subj}`);
            renderStats();
            runSearch();
            renderDashboard(); // Re-render dashboard to show active subject if needed
        }

        function renderStats() {
            let data = biblioData;
            // Filter by Subject (if not all)
            if (currentSubject !== 'all') {
                data = biblioData.filter(i => i.subject === currentSubject || (currentSubject === 'Thesis' && i.cat === 'Primary Sources'));
            }

            const done = data.filter(i => i.status === 'done').length;
            const total = data.length;
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            document.getElementById('reading-progress-text').innerText = pct + "%";
            document.getElementById('reading-progress-bar').style.width = pct + "%";
            document.getElementById('count-todo').innerText = data.filter(i => i.status === 'todo').length;
            document.getElementById('count-reading').innerText = data.filter(i => i.status === 'reading').length;
            document.getElementById('count-done').innerText = done;
            document.getElementById('total-sources-count').innerText = total;
        }
        function renderConcepts() {
            const tags = {}; biblioData.forEach(b => (b.tags || []).forEach(t => { if (!tags[t]) tags[t] = []; tags[t].push(b.title); }));
            const cloud = document.getElementById('concept-cloud');
            cloud.innerHTML = Object.keys(tags).length === 0 ? '<span class="text-stone-400 text-sm italic">Aggiungi tag ai libri per vedere le connessioni.</span>' : '';
            Object.keys(tags).forEach(tag => cloud.innerHTML += `<button onclick="filterByTag('${tag}')" class="bg-white border border-stone-200 px-3 py-1 rounded-full text-xs text-stone-600 hover:border-rose-300 hover:text-rose-600 transition-colors">#${tag} (${tags[tag].length})</button>`);
        }
        function filterByTag(tag) { document.getElementById('concept-results').innerHTML = `<h4 class="text-sm font-bold text-stone-900 mb-2">Libri collegati a #${tag}:</h4>` + biblioData.filter(b => (b.tags || []).includes(tag)).map(b => `<div class="bg-white p-3 rounded-lg border border-stone-100 text-sm text-stone-600">${b.title}</div>`).join(''); }
        function renderDeadline() { const d = localStorage.getItem('thesis_deadline'); if (d) { document.getElementById('deadline-input').value = d; const days = Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60 * 24)); document.getElementById('days-remaining').innerText = `${days} GIORNI`; document.getElementById('days-remaining').classList.remove('hidden'); document.getElementById('timeline-container').classList.remove('hidden'); document.getElementById('timeline-container').innerHTML = [{ title: "Bozza", days: 60 }, { title: "Revisione", days: 30 }, { title: "Impaginazione", days: 15 }].map(m => { const x = new Date(d); x.setDate(new Date(d).getDate() - m.days); return `<div class="bg-white p-4 rounded-xl border border-stone-100 shadow-sm"><div class="text-[10px] uppercase font-bold text-rose-400 tracking-wider mb-1">Entro il ${x.toLocaleDateString()}</div><h4 class="font-serif text-lg text-stone-800">${m.title}</h4></div>`; }).join(''); } }
        function saveDeadline() { localStorage.setItem('thesis_deadline', document.getElementById('deadline-input').value); renderDeadline(); }
        function generateCustomStrategy() { document.getElementById('custom-modal').classList.remove('hidden'); }
        async function runCustomAiGeneration() { const p = document.getElementById('custom-prompt-input').value; document.getElementById('custom-modal').classList.add('hidden'); toggleChat(); addMessage(`Jesse, crea una strategia per: ${p}`, 'user'); sendChat('chat'); }
        function toggleEditMode() { const t = prompt("Nuovo Titolo:", customStrategy.title); if (t) { customStrategy.title = t; localStorage.setItem('custom_roadmap', JSON.stringify(customStrategy)); renderRoadmap(); } }

        // --- SMART SCHEDULER LOGIC (AI POWERED) ---
        async function calculateStudySchedule() {
            const input = document.getElementById('schedule-input').value.toLowerCase();
            const resultBox = document.getElementById('schedule-result');
            const loader = document.getElementById('schedule-output');

            if (!input) return showToast("Inserisci la tua disponibilit√†!", 'warning');

            // UI Reset
            resultBox.classList.add('hidden');
            loader.classList.remove('hidden');

            const setStatus = (text) => {
                loader.innerHTML = `<div class="space-y-3"><div class="bg-stone-100 h-10 rounded w-3/4 animate-pulse"></div><div class="text-xs text-stone-400 font-mono">${text}</div></div>`;
            };

            setStatus("Generazione bozza (Qwen 72b)...");

            // Prepare Context
            const activeCourses = courses.map(c => `${c.name} (Esame: ${c.date})`).join(", ");
            const todoCount = biblioData.filter(b => b.status === 'todo').length;
            const context = `
            CURRENT DATE: ${new Date().toLocaleDateString()}
            ACTIVE COURSES: ${activeCourses}
            PENDING SOURCES: ${todoCount}
            USER CONSTRAINTS: "${input}"
            `;

            const systemPrompt = `
            Sei un Esperto Pianificatore Accademico.
            Il tuo obiettivo √® generare un JSON array valido rappresentante una settimana di studio OTTIMIZZATA.
            
            RULES:
            1. Output MUST be strictly a valid JSON Array. No markdown, no text before/after.
            2. Structure per day: { "day": "Luned√¨", "slots": [{ "time": "09:00-11:00", "activity": "Studio Profondo", "course": "Nome Corso", "focus": "Argomento specifico" }] }
            3. Respect User Constraints implicitly.
            4. Balance "Deep Work" (mattina/pomeriggio presto) with "Review" (sera).
            5. Insert specific breaks.
            `;

            try {
                // Phase 1: Qwen 72b, Phase 2: Mandatory Judge (DeepSeek)
                const schedule = await fetchScheduleWithRetry(input, context, systemPrompt, 1, 'qwen/qwen2.5-vl-72b-instruct', setStatus);
                renderSchedule(schedule);
                loader.classList.add('hidden');
                resultBox.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                loader.innerHTML = `<div class="text-red-500 font-bold">Errore: ${e.message}. Riprova.</div>`;
            }
        }

        // --- SETTINGS LOGIC ---
        function openSettingsModal() {
            document.getElementById('openai-key-input').value = localStorage.getItem('millino_openai_key') || '';
            document.getElementById('openrouter-key-input').value = localStorage.getItem('millino_openrouter_key') || '';
            document.getElementById('github-token').value = localStorage.getItem('millino_gh_token') || '';
            document.getElementById('gist-id').value = localStorage.getItem('millino_gist_id') || '';
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveOpenerKey() {
            const key = document.getElementById('openai-key-input').value.trim();
            const orKey = document.getElementById('openrouter-key-input').value.trim();

            if (key) localStorage.setItem('millino_openai_key', key);
            else localStorage.removeItem('millino_openai_key');

            if (orKey) localStorage.setItem('millino_openrouter_key', orKey);
            else localStorage.removeItem('millino_openrouter_key');

            showToast("Chiavi API salvate üîë");
        }

        async function fetchScheduleWithRetry(userPrompt, context, systemInst, retries = 1, genModel = null, statusCallback = null) {
            const callOpenRouterDirect = async (messages, model) => {
                const key = localStorage.getItem('millino_openrouter_key');
                if (!key) throw new Error("Manca la chiave OpenRouter! Configurala nelle impostazioni.");

                const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://millino-fagiolino.github.io', // Required by OpenRouter
                        'X-Title': 'Millino Fagiolino'
                    },
                    body: JSON.stringify({
                        model: model || "qwen/qwen2.5-vl-72b-instruct",
                        messages: messages,
                        temperature: 0.7
                    })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.error?.message || "Errore OpenRouter");
                return { response: data.choices[0].message.content };
            };

            const callOpenAIDirect = async (messages) => {
                const key = localStorage.getItem('millino_openai_key');
                if (!key) throw new Error("Manca la chiave OpenAI locale per la riparazione.");
                const r = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: messages, temperature: 0.1 })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.error?.message || "Errore OpenAI");
                return { response: data.choices[0].message.content };
            };

            // PHASE 1: GENERATION (OpenRouter/Qwen)
            if (statusCallback) statusCallback("Generazione bozza (Via OpenRouter)...");

            // Construct messages for Chat API
            const genMessages = [
                { role: "system", content: systemInst },
                { role: "user", content: `CONTEXT: ${context}\nTASK: Genera programma settimanale.` }
            ];

            let rawDraft;
            try {
                const response = await callOpenRouterDirect(genMessages, genModel);
                rawDraft = response.response;
            } catch (e) {
                // Fallback to OpenAI if OpenRouter fails or missing
                console.warn("OpenRouter failed, trying OpenAI...", e);
                if (statusCallback) statusCallback("OpenRouter fallito. Provo OpenAI...");
                const response = await callOpenAIDirect(genMessages);
                rawDraft = response.response;
            }

            let finalJson = tryParseJson(rawDraft);

            // PHASE 2: REPAIR (GPT-4o-mini Hybrid)
            const localKey = localStorage.getItem('millino_openai_key');
            if (statusCallback) statusCallback(localKey ? "GPT-4o-mini (Locale): Riparazione..." : "GPT-4o-mini (Server): Riparazione...");

            const judgePrompt = `SYSTEM: Sei un Riparatore di JSON. USER CONSTRAINTS: "${userPrompt}" CONTEXT: ${context} INPUT DRAFT: ${rawDraft} TASK: 1. Rispetta vincoli. 2. Fix JSON. OUTPUT: SOLO JSON ARRAY.`;

            try {
                let repairResponse;
                if (localKey) {
                    repairResponse = await callOpenAIDirect([{ role: "user", content: judgePrompt }]);
                } else {
                    repairResponse = await callApi({ message: judgePrompt, model: "gpt-4o-mini", systemOverride: "Output ONLY JSON." });
                    repairResponse = { response: repairResponse.choices[0].message.content };
                }
                finalJson = tryParseJson(repairResponse.response);
            } catch (e) {
                console.warn("Repair failed:", e);
                if (!finalJson) throw new Error("Salvataggio fallito: " + e.message);
            }

            if (!finalJson) throw new Error("Generazione fallita.");
            return finalJson;
        }
        // --- ICS EXPORT LOGIC ---
        function downloadIcs() {
            if (!lastGeneratedSchedule) return showToast("Nessun programma da esportare!", 'warning');

            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Millino Fagiolino//IT\nCALSCALE:GREGORIAN\n";
            const daysMap = { "luned√¨": 1, "marted√¨": 2, "mercoled√¨": 3, "gioved√¨": 4, "venerd√¨": 5, "sabato": 6, "domenica": 0 };

            const getNextDate = (dayName) => {
                const d = new Date();
                const targetDay = daysMap[dayName.toLowerCase().trim()];
                if (targetDay === undefined) return d;

                const currentDay = d.getDay();
                let diff = targetDay - currentDay;
                if (diff <= 0) diff += 7;
                d.setDate(d.getDate() + diff);
                return d;
            };

            const formatIcsDate = (date, timeStr) => {
                const [hours, minutes] = timeStr.split(':');
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                return `${y}${m}${d}T${hours}${minutes}00`;
            };

            lastGeneratedSchedule.forEach(day => {
                if (!day.slots) return;
                const eventDate = getNextDate(day.day);

                day.slots.forEach(slot => {
                    if (!slot.time.includes('-')) return;
                    const [startStr, endStr] = slot.time.split('-');

                    icsContent += "BEGIN:VEVENT\n";
                    icsContent += `SUMMARY:üéì ${slot.course || 'Studio'} - ${slot.activity}\n`;
                    icsContent += `DESCRIPTION:${slot.focus || ''}\n`;
                    icsContent += `DTSTART:${formatIcsDate(eventDate, startStr)}\n`;
                    icsContent += `DTEND:${formatIcsDate(eventDate, endStr)}\n`;
                    icsContent += "END:VEVENT\n";
                });
            });

            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Programma_Studio_${new Date().toLocaleDateString().replace(/\//g, '-')}.ics`;
            a.click();
        }

        function tryParseJson(str) {
            if (!str) return null;
            try { return JSON.parse(str); } catch (e) {
                try { return JSON.parse(str.match(/\[[\s\S]*\]/)[0]); } catch (e2) { return null; }
            }
        }

        let lastGeneratedSchedule = null;

        function renderSchedule(scheduleData) {
            lastGeneratedSchedule = scheduleData;
            const container = document.getElementById('schedule-result');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-serif font-bold text-stone-900">Programma Ottimizzato</h3>
                    <div class="flex gap-2">
                         <button onclick="downloadIcs()" class="px-4 py-2 bg-stone-100 text-stone-600 font-bold text-xs rounded-lg hover:bg-stone-200 border border-stone-200 flex items-center gap-2">
                            üìÖ Esporta
                        </button>
                        <button onclick="calculateStudySchedule()" class="px-4 py-2 bg-stone-900 text-white font-bold text-xs rounded-lg hover:bg-black flex items-center gap-2">
                            üîÑ Rigenera
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${scheduleData.map(day => `
                        <div class="bg-white p-5 rounded-xl border border-stone-100 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-bold text-rose-500 mb-4 uppercase tracking-wider text-xs border-b border-stone-50 pb-2">${day.day}</h4>
                            <div class="space-y-3">
                                ${day.slots.map(slot => `
                                    <div class="flex gap-3 text-sm group">
                                        <span class="font-mono text-stone-400 font-bold text-xs min-w-[70px] pt-0.5">${slot.time}</span>
                                        <div>
                                            <div class="font-bold text-stone-800 group-hover:text-rose-600 transition-colors">${slot.activity}</div>
                                            <div class="text-xs text-stone-500 italic">${slot.course ? slot.course + ': ' : ''}${slot.focus}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

    </script>
</body>

</html>